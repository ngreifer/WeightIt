<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="WeightIt">
<title>Estimating Effects After Weighting • WeightIt</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimating Effects After Weighting">
<meta property="og:description" content="WeightIt">
<meta property="og:image" content="https://ngreifer.github.io/WeightIt/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">WeightIt</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.14.2.9001</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/WeightIt.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/estimating-effects.html">Estimating Effects After Weighting</a>
    <a class="dropdown-item" href="../articles/installing-packages.html">Installing Supporting Packages</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ngreifer/WeightIt/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Estimating Effects After Weighting</h1>
                        <h4 data-toc-skip class="author">Noah
Greifer</h4>
            
            <h4 data-toc-skip class="date">2023-10-19</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ngreifer/WeightIt/blob/HEAD/vignettes/estimating-effects.Rmd" class="external-link"><code>vignettes/estimating-effects.Rmd</code></a></small>
      <div class="d-none name"><code>estimating-effects.Rmd</code></div>
    </div>

    
    
<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>After assessing balance and deciding on a weighting specification, it
comes time to estimate the effect of the treatment in the weighted
sample. How the effect is estimated and interpreted depends on the
desired estimand and the effect measure used. In addition to estimating
effects, estimating the uncertainty of the effects is critical in
communicating them and assessing whether the observed effect is
compatible with there being no effect in the population. This guide
explains how to estimate effects after weighting for point and
longitudinal treatments and with various outcome types.</p>
<p>This guide is structured as follows: first, information on the
concepts related to effect and standard error (SE) estimation is
presented below. Then, instructions for how to estimate effects and SEs
are described for the standard case (weighting for the ATE with a binary
treatment and continuous outcome) and some other common circumstances.
Finally, recommendations for reporting results and tips to avoid making
common mistakes are presented.</p>
<p>(Note: much of this vignette is copied from
<code><a href="https://kosukeimai.github.io/MatchIt/articles/estimating-effects.html" class="external-link">vignette("estimating-effects", package = "MatchIt")</a></code> and
adapted to the context of weighting.)</p>
<div class="section level3">
<h3 id="identifying-the-estimand">Identifying the estimand<a class="anchor" aria-label="anchor" href="#identifying-the-estimand"></a>
</h3>
<p>Before an effect is estimated, the estimand must be specified and
clarified. Although some aspects of the estimand depend not only on how
the effect is estimated after weighting but also on the weighting method
itself, other aspects must be considered at the time of effect
estimation and interpretation. Here, we consider three aspects of the
estimand: the population the effect is meant to generalize to (the
target population), the effect measure, and whether the effect is
marginal or conditional.</p>
<p><strong>The target population.</strong> Different weighting methods
allow you to estimate effects that can generalize to different target
populations. The most common estimand in weighting is the average
treatment effect in the population (ATE), which is the average effect of
treatment for the population from which the sample is a random sample.
Other common estimands include the average treatment effect in the
treated (ATT), the average treatment effect in the control (ATC), and
the average treatment effect in the overlap (ATO). These are defined and
explained in <span class="citation">Greifer and Stuart (<a href="#ref-greiferChoosingEstimandWhen2021" role="doc-biblioref">2021</a>)</span>. The estimand for weighting is
controlled by the <code>estimand</code> argument in the call to
<code><a href="../reference/weightit.html">weightit()</a></code>. Other allowable estimands for some weighting
methods include the average treatment effect in the matched sample (ATM)
and the average treatment effect in the optimal subset (ATOS). These are
treated just like the ATO and will not be differentiated further.</p>
<p><strong>Marginal and conditional effects.</strong> A marginal effect
is a comparison between the expected potential outcome under treatment
and the expected potential outcome under control. This is the same
quantity estimated in randomized trials without blocking or covariate
adjustment and is particularly useful for quantifying the overall effect
of a policy or population-wide intervention. A conditional effect is the
comparison between the expected potential outcomes in the treatment
groups within strata. This is useful for identifying the effect of a
treatment for an individual patient or a subset of the population.</p>
<p><strong>Effect measures.</strong> The outcome types we consider here
are continuous, with the effect measured by the mean difference; binary,
with the effect measured by the risk difference (RD), risk ratio (RR),
or odds ratio (OR); and time-to-event (i.e., survival), with the effect
measured by the hazard ratio (HR). The RR, OR, and HR are
<em>noncollapsible</em> effect measures, which means the marginal effect
on that scale is not a (possibly) weighted average of the conditional
effects within strata, even if the stratum-specific effects are of the
same magnitude. For these effect measures, it is critical to distinguish
between marginal and conditional effects because different statistical
methods target different types of effects. The mean difference and RD
are <em>collapsible</em> effect measures, so the same methods can be
used to estimate marginal and conditional effects.</p>
<p>Our primary focus will be on marginal effects, which are appropriate
for all effect measures, easily interpretable, and require few modeling
assumptions.</p>
</div>
<div class="section level3">
<h3 id="g-computation">G-computation<a class="anchor" aria-label="anchor" href="#g-computation"></a>
</h3>
<p>To estimate marginal effects, we use a method known as g-computation
<span class="citation">(<a href="#ref-snowdenImplementationGComputationSimulated2011" role="doc-biblioref">Snowden, Rose, and Mortimer 2011</a>)</span> or
regression estimation <span class="citation">(<a href="#ref-schaferAverageCausalEffects2008" role="doc-biblioref">Schafer
and Kang 2008</a>)</span>. This involves first specifying a model for
the outcome as a function of the treatment and covariates. Then, for
each unit, we compute their predicted values of the outcome setting
their treatment status to treated, and then again for control, leaving
us with two predicted outcome values for each unit, which are estimates
of the potential outcomes under each treatment level. We compute the
mean of each of the estimated potential outcomes across the entire
sample, which leaves us with two average estimated potential outcomes.
Finally, the contrast of these average estimated potential outcomes
(e.g., their difference or ratio, depending on the effect measure
desired) is the estimate of the treatment effect.</p>
<p>When doing g-computation after weighting, a few additional
considerations are required. First, the outcome model should be fit
incorporating the estimated weights (e.g., using weighted least squares
or weighted maximum likelihood estimation) <span class="citation">(<a href="#ref-vansteelandtInvitedCommentaryGComputation2011" role="doc-biblioref">Vansteelandt and Keiding 2011</a>)</span>. Second,
when we take the average of the estimated potential outcomes under each
treatment level, this must be a weighted average that incorporates the
estimated weights^[Note: For the ATE, this is actually optional. For the
ATT and ATC, this is unnecessary but causes no harm if done. For other
estimands or when sampling weights are used, this is necessary. Given
that there is no harm to computing the weighted means when it is
unnecessary and it is often necessary, we always recommend it here.].
Third, if we want to target the ATT or ATC, we only estimate potential
outcomes for the treated or control group, respectively (though we still
generate predicted values under both treatment and control) <span class="citation">(<a href="#ref-wangGcomputationAverageTreatment2017" role="doc-biblioref">Wang, Nianogo, and Arah 2017</a>)</span>.</p>
<p>G-computation as a framework for estimating effects after weighting
has a number of advantages over other approaches. It works the same
regardless of the form of the outcome model or type of outcome (e.g.,
whether a linear model is used for a continuous outcome or a logistic
model is used for a binary outcome); the only difference might be how
the average expected potential outcomes are contrasted in the final
step. In simple cases, the estimated effect is numerically identical to
effects estimated using other methods; for example, if no covariates are
included in the outcome model, the g-computation estimate is equal to
the difference in means from a t-test or coefficient of the treatment in
a linear model for the outcome. There are analytic and bootstrap
approximations to the SEs of the g-computation estimate. The analytic
approximation is computed using the delta method, a technique for
computing the SE of a quantity derived from the regression model
parameters, such as the g-computation estimate.</p>
<p>For the reasons above, we use weighted g-computation when possible
for all effect estimates, even if there are simpler methods that would
yield the same estimates. Using a single workflow (with some slight
modifications depending on the context; see below) facilitates
implementing best practices regardless of what choices a user makes.</p>
<p>There are other methods to incorporate the outcome model into
estimation of the treatment effect, the best studied of which is
augmented inverse probability weighting (AIPW), which also involves a
g-computation step. We only describe weighted g-computation here because
of its conceptual simplicity, ease of implementation, and connection
with best practices for estimating effects after matching.</p>
</div>
<div class="section level3">
<h3 id="modeling-the-outcome">Modeling the Outcome<a class="anchor" aria-label="anchor" href="#modeling-the-outcome"></a>
</h3>
<p>The goal of the outcome model is to generate good predictions for use
in the g-computation procedure described above. The type and form of the
outcome model should depend on the outcome type. For continuous
outcomes, one can use a linear model regressing the outcome on the
treatment; for binary outcomes, one can use a generalized linear model
with, e.g., a logistic link; for time-to-event outcomes, one can use a
Cox proportional hazards model.</p>
<p>An additional decision to make is whether (and how) to include
covariates in the outcome model. One may ask, why use weighting at all
if you are going to model the outcome with covariates anyway? Weighting
reduces the dependence of the effect estimate on correct specification
of the outcome model; this is the central thesis of <span class="citation">Ho et al. (<a href="#ref-hoMatchingNonparametricPreprocessing2007" role="doc-biblioref">2007</a>)</span> (though applied to matching in
their case). Including covariates in the outcome model after weighting
has several functions: it can increase precision in the effect estimate,
reduce the bias due to residual imbalance, and make the effect estimate
“doubly robust”, which means it is consistent if either the weighting
reduces sufficient imbalance in the covariates or if the outcome model
is correct. For these reasons, we recommend covariate adjustment after
weighting when possible. There is some evidence that covariate
adjustment is most helpful for covariates with standardized mean
differences greater than .1 <span class="citation">(<a href="#ref-nguyenDoubleadjustmentPropensityScore2017" role="doc-biblioref">Nguyen et al. 2017</a>)</span>, so these covariates
and covariates thought to be highly predictive of the outcome should be
prioritized in treatment effect models if not all can be included due to
sample size constraints.</p>
<p>Although there are many possible ways to include covariates (e.g.,
not just main effects but interactions, smoothing terms like splines, or
other nonlinear transformations), it is important not to engage in
specification search (i.e., trying many outcomes models in search of the
“best” one). Doing so can invalidate results and yield a conclusion that
fails to replicate. For this reason, we recommend only including the
same terms included in the weighting model unless there is a strong
<em>a priori</em> and justifiable reason to model the outcome
differently.</p>
<p>It is important not to interpret the coefficients and tests of
covariates in the outcome model. These are not causal effects and their
estimates may be severely confounded. Only the treatment effect estimate
can be interpreted as causal assuming the relevant assumptions about
unconfoundedness are met. Inappropriately interpreting the coefficients
of covariates in the outcome model is known as the Table 2 fallacy <span class="citation">(<a href="#ref-westreichTableFallacyPresenting2013" role="doc-biblioref">Westreich and Greenland 2013</a>)</span>. To avoid
this, we only display the results of the g-computation procedure and do
not examine or interpret the outcome models themselves.</p>
</div>
<div class="section level3">
<h3 id="estimating-standard-errors-and-confidence-intervals">Estimating Standard Errors and Confidence Intervals<a class="anchor" aria-label="anchor" href="#estimating-standard-errors-and-confidence-intervals"></a>
</h3>
<p>Uncertainty estimation (i.e., of SEs, confidence intervals, and
p-values) may consider the variety of sources of uncertainty present in
the analysis, including (but not limited to!) estimation of the
propensity score (if used) and estimation of the treatment effect (i.e.,
because of sampling error). For some methods, methods for analytically
computing the correct asymptotic SE have been described. These often
require custom coding or are limited to specific weighting methods and
estimands<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;These can be computed with M-estimation using the
&lt;code&gt;geex&lt;/code&gt; package or automatically using the
&lt;code&gt;PSweight&lt;/code&gt; package.&lt;/p&gt;"><sup>1</sup></a>. Instead, we consider two approximations to
the analytic SE: robust SEs and the bootstrap, described below.</p>
<div class="section level4">
<h4 id="robust-and-cluster-robust-standard-errors">Robust and Cluster-Robust Standard Errors<a class="anchor" aria-label="anchor" href="#robust-and-cluster-robust-standard-errors"></a>
</h4>
<p><strong>Robust standard errors.</strong> Also known as sandwich SEs
(due to the form of the formula for computing them),
heteroscedasticity-consistent SEs, or Huber-White SEs, robust SEs are an
adjustment to the usual maximum likelihood or ordinary least squares SEs
that are robust to violations of some of the assumptions required for
usual SEs to be valid <span class="citation">(<a href="#ref-mackinnonHeteroskedasticityconsistentCovarianceMatrix1985" role="doc-biblioref">MacKinnon and White 1985</a>)</span>. Robust SEs
have been shown to be conservative (i.e., yield overly large SEs and
wide confidence intervals) for estimating the ATE after some forms of
weighting <span class="citation">(<a href="#ref-robinsMarginalStructuralModels2000" role="doc-biblioref">Robins, Hernán, and Brumback 2000</a>)</span>,
though they can be either conservative or not for other weighting
methods and estimands, such as for the ATT <span class="citation">(<a href="#ref-reifeisVarianceTreatmentEffect2020" role="doc-biblioref">Reifeis and Hudgens 2020</a>)</span> or for entropy
balancing <span class="citation">(<a href="#ref-chanGloballyEfficientNonparametric2016" role="doc-biblioref">Chan, Yam, and Zhang 2016</a>)</span>. Robust SEs
treat the estimated weights as if they were fixed and known, ignoring
uncertainty in their estimation. Although they are quick and simple to
estimate using functionality in the <code>sandwich</code> and
<code>survey</code> packages, they should be used with caution, and the
bootstrap (described below) should be preferred in most cases.</p>
</div>
<div class="section level4">
<h4 id="bootstrapping">Bootstrapping<a class="anchor" aria-label="anchor" href="#bootstrapping"></a>
</h4>
<p>Some problems with robust SEs include that they fail to take into
account the estimation of the weights and are only an approximation when
used to compute derived quantities from nonlinear models, which is often
true when using g-computation to estimate effects. One solution to these
problems is bootstrapping, which is a technique used to simulate the
sampling distribution of an estimator by repeatedly drawing samples with
replacement and estimating the effect in each bootstrap sample <span class="citation">(<a href="#ref-efronBootstrapMethodsStandard1986" role="doc-biblioref">Efron and Tibshirani 1986</a>)</span>. From the
bootstrap distribution, SEs and confidence intervals can be computed in
several ways, including using the standard deviation of the bootstrap
estimates as the SE estimate or using the 2.5 and 97.5 percentiles as
95% confidence interval bounds. Bootstrapping tends to be most useful
when no analytic estimator of a SE is possible or has been derived yet.
Bootstrapping has been found to be effective at estimating SEs and
confidence intervals after weighting, often performing better even than
the analytic asymptotic formula when it is available <span class="citation">(<a href="#ref-austin2022" role="doc-biblioref">Austin
2022</a>)</span>.</p>
<p>Typically, bootstrapping involves performing the entire estimation
process in each bootstrap sample, including estimation both of the
weights and the effect. With bootstrapping, more bootstrap replications
are always better but can take time and increase the chances that at
least one error will occur within the bootstrap analysis (e.g., a
bootstrap sample with zero treated units or zero units with an event).
In general, numbers of replications upwards of 999 are recommended, with
values one less than a multiple of 100 preferred to avoid interpolation
when using the percentiles as confidence interval limits <span class="citation">(<a href="#ref-mackinnonBootstrapMethodsEconometrics2006" role="doc-biblioref">MacKinnon 2006</a>)</span>. There are several
methods of computing bootstrap confidence intervals, but the
bias-corrected accelerated (BCa) bootstrap confidence interval often
performs well and is easy to implement, simply by setting
<code>type = "bca"</code> in the call to <code><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot::boot.ci()</a></code>
after running <code><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot::boot()</a></code><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Sometimes, an error will occur with this method, which
usually means more bootstrap replications are required. The number of
replicates must be greater than the original sample size.&lt;/p&gt;"><sup>2</sup></a>.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="estimating-treatment-effects-and-standard-errors-after-weighting">Estimating Treatment Effects and Standard Errors After
Weighting<a class="anchor" aria-label="anchor" href="#estimating-treatment-effects-and-standard-errors-after-weighting"></a>
</h2>
<p>Below, we describe effect estimation after weighting. The focus here
is not on evaluating the methods but simply on demonstrating them. In
all cases, the correct propensity score model is used. We will present
both the faster and simpler method that uses robust SEs and the more
complicated but accurate method using bootstrapping.</p>
<p>We’ll be using a simulated toy dataset <code>d</code> with several
outcome and treatment types. Code to generate the dataset is at the end
of this document. Below we display the first six rows of
<code>d</code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   A Am      Ac      X1      X2      X3       X4 X5      X6      X7      X8       X9    Y_C Y_B    Y_S</span></span>
<span><span class="co">## 1 0 C1 -2.2185  0.1725 -1.4283 -0.4103 -2.36059  1 -1.1199  0.6398 -0.4840 -0.59385 -3.591   0  857.7</span></span>
<span><span class="co">## 2 0 C2 -2.2837 -1.0959  0.8463  0.2456 -0.12333  1 -2.2687 -1.4491 -0.5514 -0.31439 -1.548   0  311.6</span></span>
<span><span class="co">## 3 0 C1 -1.1362  0.1768  0.7905 -0.8436  0.82366  1 -0.2221  0.2971 -0.6966 -0.69516  6.071   0  241.2</span></span>
<span><span class="co">## 4 0 C1 -0.8865 -0.4595  0.1726  1.9542 -0.62661  1 -0.4019 -0.8294 -0.5384  0.20729  2.491   1  142.4</span></span>
<span><span class="co">## 5 1  T  0.8613  0.3563 -1.8121  0.8135 -0.67189  1 -0.8297  1.7297 -0.6439 -0.02648 -1.100   0  206.8</span></span>
<span><span class="co">## 6 0 C2 -2.1697 -2.4313 -1.7984 -1.2940  0.04609  1 -1.2419 -1.1252 -1.8659 -0.56513 -9.850   0 1962.9</span></span></code></pre>
<p><code>A</code> is a binary treatment variable, <code>X1</code>
through <code>X9</code> are covariates, <code>Y_C</code> is a continuous
outcome, <code>Y_B</code> is a binary outcome, and <code>Y_S</code> is a
survival outcome. <code>Am</code> and <code>Ac</code> are multi-category
and continuous treatment variables, respectively.</p>
<p>We will need to the following packages to perform the analyses:</p>
<ul>
<li>
<code>marginaleffects</code> provides the
<code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons()</a></code> function for performing g-computation and
estimating the SEs and confidence intervals of the average estimate
potential outcomes and treatment effects</li>
<li>
<code>sandwich</code> is used internally by
<code>marginaleffects</code> to compute robust and cluster-robust
SEs</li>
<li>
<code>survival</code> provides <code><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph()</a></code> to estimate the
coefficients in a Cox-proportional hazards model for the marginal hazard
ratio, which we will use for survival outcomes</li>
<li>
<code>boot</code> provides <code><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot()</a></code> and
<code><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot.ci()</a></code> for performing bootstrapping and computing
bootstrap confidence intervals</li>
</ul>
<p>Of course, we also need <code>WeightIt</code> to perform the
weighting.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ngreifer.github.io/WeightIt/">"WeightIt"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://marginaleffects.com/" class="external-link">"marginaleffects"</a></span><span class="op">)</span></span></code></pre></div>
<p>Effect estimates will be computed using
<code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">marginaleffects::avg_comparisons()</a></code>, even when its use may
be superfluous (e.g., for comparing the weighted difference in means).
As previously mentioned, this is because it is useful to have a single
workflow that works no matter the situation, perhaps with very slight
modifications to accommodate different contexts. Using
<code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons()</a></code> has several advantages, even when the
alternatives are simple: it only provides the effect estimate, and not
other coefficients; it automatically incorporates robust SEs if
requested; and it always produces average marginal effects for the
correct population if requested.</p>
<p>Other packages may be of use but are not used here. There are
alternatives to the <code>marginaleffects</code> package for computing
average marginal effects, including <code>margins</code> and
<code>stdReg</code>. The <code>survey</code> package can be used to
estimate robust SEs incorporating weights and provides functions for
survey-weighted generalized linear models and Cox-proportional hazards
models. Much of the code here can be adapted to be used with
<code>survey</code>, and we will demonstrate that as well.</p>
<div class="section level3">
<h3 id="the-standard-case-binary-treatment-with-robust-ses">The Standard Case: Binary Treatment with Robust SEs<a class="anchor" aria-label="anchor" href="#the-standard-case-binary-treatment-with-robust-ses"></a>
</h3>
<p>For most weighting methods, estimating the effect after weighting is
straightforward and involves fitting a model for the outcome that
incorporates the estimated weights, then estimating the treatment effect
using g-computation (i.e., using
<code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">marginaleffects::avg_comparisons()</a></code>) with a robust SE to
account for pair membership. This procedure is the same for continuous
and binary outcomes with and without covariates.</p>
<p>There are a few adjustments that need to be made for certain
scenarios, which we describe in the section “Adjustments to the Standard
Case”. These adjustments include for the following cases: when weighting
for the ATT or ATC, for estimating effects with binary outcomes, and for
estimating effects with survival outcomes. Estimation for all estimands
other than the ATT and ATC proceeds as it does for the ATE. You must
read the Standard Case to understand the basic procedure before reading
about these special scenarios. We also demonstrate how to estimate
effects for multi-category and continuous treatments.</p>
<p>Here, we demonstrate the faster analytic approach to estimating
confidence intervals; for the bootstrap approach, see the section “Using
Bootstrapping to Estimate Confidence Intervals” below.</p>
<p>First, we will perform propensity score weighting for the ATE.
Remember, all weighting methods use this exact procedure or a slight
variation, so this section is critical even if you are using a different
weighting method.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#PS weighting for the ATE with a logistic regression PS</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weightit.html">weightit</a></span><span class="op">(</span><span class="va">A</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span>, data <span class="op">=</span> <span class="va">d</span>,</span>
<span>              method <span class="op">=</span> <span class="st">"glm"</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span></span>
<span><span class="va">W</span></span></code></pre></div>
<pre><code><span><span class="co">## A <span style="font-style: italic;">weightit</span> object</span></span>
<span><span class="co">##  - method: "glm" (propensity score weighting with GLM)</span></span>
<span><span class="co">##  - number of obs.: 2000</span></span>
<span><span class="co">##  - sampling weights: none</span></span>
<span><span class="co">##  - treatment: 2-category</span></span>
<span><span class="co">##  - estimand: ATE</span></span>
<span><span class="co">##  - covariates: X1, X2, X3, X4, X5, X6, X7, X8, X9</span></span></code></pre>
<p>Typically one would assess balance and ensure that this weighting
specification works, but we will skip that step here to focus on effect
estimation. See <code><a href="../articles/WeightIt.html">vignette("WeightIt")</a></code> and
<code><a href="https://ngreifer.github.io/cobalt/articles/cobalt.html" class="external-link">vignette("cobalt", package = "cobalt")</a></code> for more information
on this necessary step.</p>
<p>First, we fit a model for the outcome given the treatment and
(optionally) the covariates. It’s usually a good idea to include
treatment-covariate interactions, which we do below, but this is not
always necessary, especially when excellent balance has been
achieved.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Bring weights into the dataset</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">$</span><span class="va">weights</span></span>
<span></span>
<span><span class="co">#Linear model with covariates</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y_C</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                        <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>           data <span class="op">=</span> <span class="va">d</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span></code></pre></div>
<p>Next, we use <code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">marginaleffects::avg_comparisons()</a></code> to
estimate the ATE.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                vcov <span class="op">=</span> <span class="st">"HC3"</span>,</span>
<span>                wts <span class="op">=</span> <span class="st">"weights"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Term Contrast Estimate Std. Error   z Pr(&gt;|z|)    S 2.5 % 97.5 %</span></span>
<span><span class="co">##     A    1 - 0     2.05      0.477 4.3   &lt;0.001 15.8  1.12   2.98</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </span></span>
<span><span class="co">## Type:  response</span></span></code></pre>
<p>Let’s break down the call to <code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons()</a></code>: to the
first argument, we supply the model fit, <code>fit</code>; to the
<code>variables</code> argument, the name of the treatment
(<code>"A"</code>); to the <code>vcov</code> argument, the name of the
robust SE we want to request (in this case, HC3, which perform well
relative to other robust SEs); and to the <code>wts</code> argument, the
names of the variable in <code>d</code> containing the matching weights
(<code>"weights"</code>) to ensure they are included in the analysis.
Some of these arguments differ depending on the specifics of the outcome
type; see the sections below for information.</p>
<p>If, in addition to the effect estimate, we want the average estimated
potential outcomes, we can use
<code><a href="https://rdrr.io/pkg/marginaleffects/man/predictions.html" class="external-link">marginaleffects::avg_predictions()</a></code>, which we demonstrate
below. Note the interpretation of the resulting estimates as the
expected potential outcomes is only valid if all covariates present in
the outcome model (if any) are interacted with the treatment.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/predictions.html" class="external-link">avg_predictions</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                vcov <span class="op">=</span> <span class="st">"HC3"</span>,</span>
<span>                wts <span class="op">=</span> <span class="st">"weights"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  A Estimate Std. Error     z Pr(&gt;|z|)    S 2.5 % 97.5 %</span></span>
<span><span class="co">##  0     1.47      0.131 11.23   &lt;0.001 94.8  1.22   1.73</span></span>
<span><span class="co">##  1     3.52      0.458  7.69   &lt;0.001 46.0  2.63   4.42</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: A, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </span></span>
<span><span class="co">## Type:  response</span></span></code></pre>
<p>We can see that the difference in potential outcome means is equal to
the average treatment effect computed previously<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;To verify that they are equal, supply the output of
&lt;code&gt;&lt;a href="https://rdrr.io/pkg/marginaleffects/man/predictions.html" class="external-link"&gt;avg_predictions()&lt;/a&gt;&lt;/code&gt; to &lt;code&gt;&lt;a href="https://rdrr.io/pkg/marginaleffects/man/hypotheses.html" class="external-link"&gt;hypotheses()&lt;/a&gt;&lt;/code&gt;, e.g.,
&lt;code&gt;avg_predictions(…) |&amp;gt; hypotheses("revpairwise")&lt;/code&gt;; this
explicitly compares the average potential outcomes and should yield
identical estimates to the &lt;code&gt;&lt;a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link"&gt;avg_comparisons()&lt;/a&gt;&lt;/code&gt; call.&lt;/p&gt;'><sup>3</sup></a>. All of the arguments
to <code><a href="https://rdrr.io/pkg/marginaleffects/man/predictions.html" class="external-link">avg_predictions()</a></code> are the same as those to
<code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="adjustments-to-the-standard-case">Adjustments to the Standard Case<a class="anchor" aria-label="anchor" href="#adjustments-to-the-standard-case"></a>
</h3>
<p>This section explains how the procedure might differ if any of the
following special circumstances occur.</p>
<div class="section level4">
<h4 id="weighting-for-the-att-or-atc">Weighting for the ATT or ATC<a class="anchor" aria-label="anchor" href="#weighting-for-the-att-or-atc"></a>
</h4>
<p>When weighting for the ATT, everything is identical to the Standard
Case except that in the calls to <code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons()</a></code> and
<code><a href="https://rdrr.io/pkg/marginaleffects/man/predictions.html" class="external-link">avg_predictions()</a></code>, the <code>newdata</code> argument must
additionally be supplied to <code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons()</a></code> and
<code><a href="https://rdrr.io/pkg/marginaleffects/man/predictions.html" class="external-link">avg_predictions()</a></code> as</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">newdata</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">A</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>This requests that g-computation be done only for the treated units.
For the ATC, replace <code>1</code> with <code>0</code>.</p>
</div>
<div class="section level4">
<h4 id="binary-outcomes">Binary outcomes<a class="anchor" aria-label="anchor" href="#binary-outcomes"></a>
</h4>
<p>Estimating effects on binary outcomes is essentially the same as for
continuous outcomes. The main difference is that there are several
measures of the effect one can consider, which include the odds ratio
(OR), risk ratio/relative risk (RR), and risk difference (RD), and the
syntax to <code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons()</a></code> depends on which one is
desired. The outcome model should be one appropriate for binary outcomes
(e.g., logistic regression) but is unrelated to the desired effect
measure because we can compute any of the above effect measures using
<code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons()</a></code> after the logistic regression.</p>
<p>To fit a logistic regression model, change <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> to
<code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code> and set <code>family = quasibinomial</code><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;We use &lt;code&gt;&lt;a href="https://rdrr.io/r/stats/family.html" class="external-link"&gt;quasibinomial()&lt;/a&gt;&lt;/code&gt; instead of
&lt;code&gt;&lt;a href="https://rdrr.io/r/stats/family.html" class="external-link"&gt;binomial()&lt;/a&gt;&lt;/code&gt; simply to avoid a spurious warning; the results
will be identical regardless.&lt;/p&gt;'><sup>4</sup></a>. To
compute the marginal RD, we can use exactly the same syntax as in the
Standard Case; nothing needs to change<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Note that for low or high average expected risks
computed with &lt;code&gt;&lt;a href="https://rdrr.io/pkg/marginaleffects/man/predictions.html" class="external-link"&gt;predictions()&lt;/a&gt;&lt;/code&gt;, the confidence intervals may
go below 0 or above 1; this is because an approximation is used. To
avoid this problem, bootstrapping or simulation-based inference can be
used instead.&lt;/p&gt;'><sup>5</sup></a>.</p>
<p>To compute the marginal RR, we need to add
<code>comparison = "lnratioavg"</code> to
<code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons()</a></code>; this computes the marginal log RR. To
get the marginal RR, we need to add <code>transform = "exp"</code> to
<code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons()</a></code>, which exponentiates the marginal log RR
and its confidence interval. The code below computes the effects and
displays the statistics of interest:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Logistic regression model with covariates</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Y_B</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                        <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>           data <span class="op">=</span> <span class="va">d</span>, weights <span class="op">=</span> <span class="va">weights</span>,</span>
<span>           family <span class="op">=</span> <span class="va">quasibinomial</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Compute effects; RR and confidence interval</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                vcov <span class="op">=</span> <span class="st">"HC3"</span>,</span>
<span>                wts <span class="op">=</span> <span class="st">"weights"</span>,</span>
<span>                comparison <span class="op">=</span> <span class="st">"lnratioavg"</span>,</span>
<span>                transform <span class="op">=</span> <span class="st">"exp"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Term              Contrast Estimate Pr(&gt;|z|)    S 2.5 % 97.5 %</span></span>
<span><span class="co">##     A ln(mean(1) / mean(0))     1.71   &lt;0.001 26.6  1.42   2.05</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, estimate, p.value, s.value, conf.low, conf.high, predicted_lo, predicted_hi, predicted </span></span>
<span><span class="co">## Type:  response</span></span></code></pre>
<p>The output displays the marginal RR, its Z-value, the p-value for the
Z-test of the log RR against 0, and its confidence interval. (Note that
even though the <code>Contrast</code> label still suggests the log RR,
the RR is actually displayed.) To view the log RR and its standard
error, omit the <code>transform</code> argument.</p>
<p>For the marginal OR, the only thing that needs to change is that
<code>comparison</code> should be set to <code>"lnoravg"</code>.</p>
</div>
<div class="section level4">
<h4 id="survival-outcomes">Survival outcomes<a class="anchor" aria-label="anchor" href="#survival-outcomes"></a>
</h4>
<p>There are several measures of effect size for survival outcomes, some
of which are described by <span class="citation">Mao et al. (<a href="#ref-mao2018" role="doc-biblioref">2018</a>)</span>. When using
the Cox proportional hazards model, the quantity of interest is the
hazard ratio (HR) between the treated and control groups. As with the
OR, the HR is non-collapsible, which means the estimated HR will only be
a valid estimate of the marginal HR when no other covariates are
included in the model. Other effect measures, such as the difference in
mean survival times or probability of survival after a given time, can
be treated just like continuous and binary outcomes as previously
described.</p>
<p>For the HR, we cannot compute average marginal effects and must use
the coefficient on treatment in a Cox model fit without covariates. This
means that we cannot use the procedures from the Standard Case. Here we
describe estimating the marginal HR using <code><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph()</a></code> from the
<code>survival</code> package. (See
<code><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">help("coxph", package = "survival")</a></code> for more information on
this model.) Robust SEs for HRs were studied by <span class="citation">Austin (<a href="#ref-austin2016" role="doc-biblioref">2016</a>)</span> and were found to be conservative;
they are requested automatically when weights are supplied to
<code><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph()</a></code>. Other formulas have been developed for estimating
standard errors more accurately <span class="citation">(<a href="#ref-mao2018" role="doc-biblioref">Mao et al. 2018</a>; <a href="#ref-hajage2018" role="doc-biblioref">Hajage et al.
2018</a>)</span>, though <span class="citation">Austin (<a href="#ref-austin2016" role="doc-biblioref">2016</a>)</span> also found
the bootstrap to be adequate.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/therneau/survival" class="external-link">"survival"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Cox Regression for marginal HR</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Y_S</span><span class="op">)</span> <span class="op">~</span> <span class="va">A</span>, data <span class="op">=</span> <span class="va">d</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Call:</span></span>
<span><span class="co">## coxph(formula = Surv(Y_S) ~ A, data = d, weights = weights)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##   coef exp(coef) se(coef) robust se z     p</span></span>
<span><span class="co">## A 0.39      1.47     0.03      0.10 4 6e-05</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Likelihood ratio test=151  on 1 df, p=&lt;2e-16</span></span>
<span><span class="co">## n= 2000, number of events= 2000</span></span></code></pre>
<p>The <code>coef</code> column contains the log HR, and
<code>exp(coef)</code> contains the HR. Remember to always use the
<code>robust se</code> for the SE of the log HR. The displayed z-test
p-value results from using the robust SE.</p>
<p>The <code>adjustedCurves</code> package provides integration with
<code>WeightIt</code> to estimate adjusted survival estimands. We
strongly recommend using this package to estimate effects after
weighting.</p>
</div>
<div class="section level4">
<h4 id="using-the-survey-package">Using the <code>survey</code> package<a class="anchor" aria-label="anchor" href="#using-the-survey-package"></a>
</h4>
<p>The <code>survey</code> package has often been recommended for use in
estimating treatment effects after propensity score weighting. When
combined with <code>marginaleffects</code> functions, it yields
identical estimates and similar standard errors to the methods described
above that use <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> or <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code> and manually
request a robust SE. The main benefits of using <code>survey</code> are
that you don’t need to request robust SEs in the call to
<code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons()</a></code> and you can incorporate other survey
design information, e.g., if your study comes from a complex survey.</p>
<p>Below is how you would adjust the standard case to use
<code>survey</code> instead:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="http://r-survey.r-forge.r-project.org/survey/" class="external-link">"survey"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Declare a survey design using the estimated weights</span></span>
<span><span class="va">des</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign</a></span><span class="op">(</span><span class="op">~</span><span class="fl">1</span>, weights <span class="op">=</span> <span class="op">~</span><span class="va">weights</span>, data <span class="op">=</span> <span class="va">d</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Fit the outcome model</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survey/man/svyglm.html" class="external-link">svyglm</a></span><span class="op">(</span><span class="va">Y_C</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                           <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>              design <span class="op">=</span> <span class="va">des</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#G-computation for the difference in means</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                wts <span class="op">=</span> <span class="st">"(weights)"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Term Contrast Estimate Std. Error    z Pr(&gt;|z|)    S 2.5 % 97.5 %</span></span>
<span><span class="co">##     A    1 - 0     2.05      0.356 5.75   &lt;0.001 26.8  1.35   2.75</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </span></span>
<span><span class="co">## Type:  response</span></span></code></pre>
<p>Note that we need to supply <code>"(weights)"</code> to the
<code>wts</code> argument for them to be correctly incorporated. You
might notice that the standard errors computed using <code>survey</code>
are different from those using <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> or <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code>
and HC3 robust SEs; to get similar SEs using <code><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm()</a></code> or
<code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code>, set <code>vcov = "HC0"</code> in the call to
<code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons()</a></code>. This approach is not recommended because
HC3 standard errors tend to perform better, which is one reason to avoid
using <code>survey</code>. In many cases, though, the results will be
similar.</p>
<p>Remember that if sampling weights are used in the estimation of the
balancing weights, the balancing weights and sampling weights must be
multiplied together prior to inclusion in the call to
<code><a href="https://rdrr.io/pkg/survey/man/svydesign.html" class="external-link">svydesign()</a></code>.</p>
</div>
</div>
<div class="section level3">
<h3 id="multi-category-treatments">Multi-Category Treatments<a class="anchor" aria-label="anchor" href="#multi-category-treatments"></a>
</h3>
<p>Multi-category treatments work essentially the same way as binary
treatments. The main practical differences are in choosing the estimand
and estimating the weights. The ATE and ATO are straightforward. The ATT
requires choosing one group to be the treated or “focal” group. Effects
are the estimated for members of that group. The contrast in the focal
group between the expected potential outcomes under a non-focal
treatment and the expected potential outcomes for the focal (actual)
treatment can be interpreted similarly to how ATTs are interpreted for
binary treatments. The contrasts in the focal group between expected
potential outcomes under a pair of non-focal treatments can be
interpreted as the contrast between the ATTs of the non-focal
treatments. Weights may be estimated differently for multi-category
treatments from binary treatments; see the individual methods pages for
how they differ.</p>
<p>Below, we’ll estimate the ATTs of the multi-category treatment
<code>Am</code> for a focal level.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">Am</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  C1  C2   T </span></span>
<span><span class="co">## 751 801 448</span></span></code></pre>
<p>We have a focal treatment group, <code>"T"</code>, and two control
groups <code>"C1"</code> and <code>"C2"</code>. We expect the ATTs for
the two control groups to be the same since we assigned them randomly
from within the original control group.</p>
<p>First, we estimate our weights using entropy balancing <span class="citation">(<a href="#ref-hainmuellerEntropyBalancingCausal2012" role="doc-biblioref">Hainmueller 2012</a>)</span>, identifying the focal
group using <code>focal</code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weightit.html">weightit</a></span><span class="op">(</span><span class="va">Am</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span>, data <span class="op">=</span> <span class="va">d</span>,</span>
<span>              method <span class="op">=</span> <span class="st">"ebal"</span>, estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>              focal <span class="op">=</span> <span class="st">"T"</span><span class="op">)</span></span>
<span><span class="va">W</span></span></code></pre></div>
<pre><code><span><span class="co">## A <span style="font-style: italic;">weightit</span> object</span></span>
<span><span class="co">##  - method: "ebal" (entropy balancing)</span></span>
<span><span class="co">##  - number of obs.: 2000</span></span>
<span><span class="co">##  - sampling weights: none</span></span>
<span><span class="co">##  - treatment: 3-category (C1, C2, T)</span></span>
<span><span class="co">##  - estimand: ATT (focal: T)</span></span>
<span><span class="co">##  - covariates: X1, X2, X3, X4, X5, X6, X7, X8, X9</span></span></code></pre>
<p>Typically one would assess the performance of the weights (balance
and effective sample size) but we will skip that for now. Next, we fit
the outcome model and perform weighted g-computation. We use
<code><a href="https://rdrr.io/pkg/marginaleffects/man/predictions.html" class="external-link">avg_predictions()</a></code> first to compute the expected potential
outcome under each treatment for the focal group, and the use
<code><a href="https://rdrr.io/pkg/marginaleffects/man/hypotheses.html" class="external-link">hypotheses()</a></code> to test all pairwise comparisons.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Bring weights into the dataset</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">$</span><span class="va">weights</span></span>
<span></span>
<span><span class="co">#Fit the outcome model</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y_C</span> <span class="op">~</span> <span class="va">Am</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                        <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>          data <span class="op">=</span> <span class="va">d</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#G-computation</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/predictions.html" class="external-link">avg_predictions</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                     variables <span class="op">=</span> <span class="st">"Am"</span>,</span>
<span>                     vcov <span class="op">=</span> <span class="st">"HC3"</span>,</span>
<span>                     newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">Am</span> <span class="op">==</span> <span class="st">"T"</span><span class="op">)</span>,</span>
<span>                     wts <span class="op">=</span> <span class="st">"weights"</span><span class="op">)</span></span>
<span><span class="va">p</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Am Estimate Std. Error     z Pr(&gt;|z|)     S 2.5 % 97.5 %</span></span>
<span><span class="co">##  C1     1.64      0.390  4.21   &lt;0.001  15.2 0.876   2.41</span></span>
<span><span class="co">##  C2     1.84      0.324  5.68   &lt;0.001  26.2 1.206   2.48</span></span>
<span><span class="co">##  T      3.75      0.222 16.88   &lt;0.001 210.1 3.314   4.18</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: Am, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </span></span>
<span><span class="co">## Type:  response</span></span></code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/hypotheses.html" class="external-link">hypotheses</a></span><span class="op">(</span><span class="va">p</span>, <span class="st">"revpairwise"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##     Term Estimate Std. Error     z Pr(&gt;|z|)    S  2.5 % 97.5 %</span></span>
<span><span class="co">##  C2 - C1     0.20      0.251 0.799    0.424  1.2 -0.291  0.692</span></span>
<span><span class="co">##  T - C1      2.11      0.295 7.152   &lt;0.001 40.1  1.531  2.686</span></span>
<span><span class="co">##  T - C2      1.91      0.291 6.549   &lt;0.001 34.0  1.337  2.479</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </span></span>
<span><span class="co">## Type:  response</span></span></code></pre>
<p>We find significant ATTs between the focal treatment and control
levels (<code>T - C1</code> and <code>T - C2</code>), but the difference
between control levels (<code>C2 - C1</code>), which can be interpreted
as the difference between these ATTs, is nonsignificant, as expected.
Remember, for the ATT, bootstrapping usually provides more valid
inference than the robust SEs used here.</p>
</div>
<div class="section level3">
<h3 id="continuous-treatments">Continuous Treatments<a class="anchor" aria-label="anchor" href="#continuous-treatments"></a>
</h3>
<p>For continuous treatments, one estimand of interest is the average
dose-response function (ADRF), which links the value of the treatment to
the expected potential outcome under that treatment value across the
full sample. We do not provide a detailed account of the ADRF but will
demonstrate how to estimate weights that balance covariates with respect
to a continuous treatment and how to estimate and plot the ADRF in the
weighted sample. We’ll use the continuous treatment <code>Ac</code>,
which ranges from -10.37 to 6.26, and estimate its effect on the
continuous outcome <code>Y_C</code>.</p>
<p>First, we’ll estimate distance covariance optimal weights <span class="citation">(<a href="#ref-huling2023" role="doc-biblioref">Huling,
Greifer, and Chen 2023</a>)</span> using <code><a href="../reference/weightit.html">weightit()</a></code>.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weightit.html">weightit</a></span><span class="op">(</span><span class="va">Ac</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span>, data <span class="op">=</span> <span class="va">d</span>,</span>
<span>              method <span class="op">=</span> <span class="st">"energy"</span><span class="op">)</span></span>
<span><span class="va">W</span></span></code></pre></div>
<pre><code><span><span class="co">## A <span style="font-style: italic;">weightit</span> object</span></span>
<span><span class="co">##  - method: "energy" (energy balancing)</span></span>
<span><span class="co">##  - number of obs.: 2000</span></span>
<span><span class="co">##  - sampling weights: none</span></span>
<span><span class="co">##  - treatment: continuous</span></span>
<span><span class="co">##  - covariates: X1, X2, X3, X4, X5, X6, X7, X8, X9</span></span></code></pre>
<p>Typically one would assess the performance of the weights (balance
and effective sample size) but we will skip that for now. Next, we fit
the outcome model and perform weighted g-computation. For the outcome
model, we will use a natural cubic spline on <code>Ac</code> with 4 df.
You can use any transformation of the treatment, e.g., a polynomial
transformation using <code><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly()</a></code>, as long as it is flexible
enough to capture any possible ADRF; purely nonparametric methods like
kernel regression can be used as well, but inference for them is more
challenging. Covariates can be included in the model, but with many
covariates, many basis functions for the treatment, and a full set of
treatment-covariate interactions, the resulting estimates may be
imprecise.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Bring weights into the dataset</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">$</span><span class="va">weights</span></span>
<span></span>
<span><span class="co">#Fit the outcome model</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">Y_C</span> <span class="op">~</span> <span class="fu">splines</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">Ac</span>, df <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">*</span></span>
<span>            <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>               <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>          data <span class="op">=</span> <span class="va">d</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span></code></pre></div>
<p>Next we use <code><a href="https://rdrr.io/pkg/marginaleffects/man/predictions.html" class="external-link">avg_predictions()</a></code> first to compute the
expected potential outcome under a representative set of treatment
values. We’ll examine 51 treatment values from the 10th to 90th
percentiles of <code>Ac</code> because estimates outside those ranges
tend to be imprecise.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Represenative values of Ac:</span></span>
<span><span class="va">values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">d</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Ac</span>, <span class="fl">.1</span><span class="op">)</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Ac</span>, <span class="fl">.9</span><span class="op">)</span>,</span>
<span>                      length.out <span class="op">=</span> <span class="fl">51</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#G-computation</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/predictions.html" class="external-link">avg_predictions</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                     variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Ac <span class="op">=</span> <span class="va">values</span><span class="op">)</span>,</span>
<span>                     vcov <span class="op">=</span> <span class="st">"HC3"</span>,</span>
<span>                     wts <span class="op">=</span> <span class="st">"weights"</span><span class="op">)</span></span></code></pre></div>
<p>Although one can examine the expected potential outcomes, it is often
more useful to see them plotted. We can generate a plot of the ADRF and
its pointwise confidence band using <code>ggplot2</code>^[You can also
use <code><a href="https://rdrr.io/pkg/marginaleffects/man/plot_predictions.html" class="external-link">plot_predictions()</a></code>, though after requesting the
predictions in the prior step it is quicker to use
<code><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot()</a></code>.]:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org" class="external-link">"ggplot2"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">p</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Ac</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>              alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Ac"</span>, y <span class="op">=</span> <span class="st">"E[Y|A]"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="estimating-effects_files/figure-html/unnamed-chunk-19-1.png" width="672"></p>
<p>We can see that the ADRF has an elbow-shape, with a zone of no
evidence of treatment effect followed by a zone of increasing values of
the outcome as the treatment increases.</p>
<p>Another way to characterize the effect of continuous treatments is to
examine the average marginal effect function (AMEF), which is a function
that relates the value of treatment to the derivative of the ADRF. When
this derivative is different from zero, there is evidence of a treatment
effect at the corresponding value of treatment. Below, we use
<code><a href="https://rdrr.io/pkg/marginaleffects/man/slopes.html" class="external-link">avg_slopes()</a></code> to compute the pointwise derivatives of the
ADRF across levels of <code>Ac</code> and then plot it^[You can also use
<code><a href="https://rdrr.io/pkg/marginaleffects/man/plot_slopes.html" class="external-link">plot_slopes()</a></code>.].</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate the pointwise derivatives at representative</span></span>
<span><span class="co"># values of Ac</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/slopes.html" class="external-link">avg_slopes</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                variables <span class="op">=</span> <span class="st">"Ac"</span>,</span>
<span>                newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/datagrid.html" class="external-link">datagridcf</a></span><span class="op">(</span>Ac <span class="op">=</span> <span class="va">values</span><span class="op">)</span>,</span>
<span>                by <span class="op">=</span> <span class="st">"Ac"</span>,</span>
<span>                vcov <span class="op">=</span> <span class="st">"HC3"</span>,</span>
<span>                wts <span class="op">=</span> <span class="st">"weights"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the AMEF</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">s</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Ac</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>              alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Ac"</span>, y <span class="op">=</span> <span class="st">"dE[Y|A]/dA"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="estimating-effects_files/figure-html/unnamed-chunk-20-1.png" width="672"></p>
<p>We can see that between values of -1.5 and .5, there is evidence of a
positive effect of <code>Ac</code> on <code>Y_C</code> (i.e., because
the confidence intervals for the slope of the ADRF at those values of
<code>Ac</code> exclude 0). This is in line with our observation above
that the treatment only appears to have an effect at higher values of
<code>Ac</code>.</p>
</div>
<div class="section level3">
<h3 id="longitudinal-treatments">Longitudinal Treatments<a class="anchor" aria-label="anchor" href="#longitudinal-treatments"></a>
</h3>
<p>Coming soon! For now see the example at
<code><a href="../articles/WeightIt.html">vignette("WeightIt")</a></code>.</p>
</div>
<div class="section level3">
<h3 id="using-bootstrapping-to-estimate-confidence-intervals">Using Bootstrapping to Estimate Confidence Intervals<a class="anchor" aria-label="anchor" href="#using-bootstrapping-to-estimate-confidence-intervals"></a>
</h3>
<p>The bootstrap is an alternative to the delta method for estimating
confidence intervals for estimated effects. See the section
Bootstrapping above for details. Here, we’ll demonstrate the standard
bootstrap, which involves resampling units and estimating the weights
and treatment effect within each bootstrap sample. For both, we will use
functionality in the <code>boot</code> package. It is critical to set a
seed using <code><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed()</a></code> prior to performing the bootstrap in
order for results to be replicable.</p>
<p>For the standard bootstrap, we need a function that takes in the
original dataset and a vector of sampled unit indices and returns the
estimated quantity of interest. This function should estimate the
weights in the bootstrap sample, fit the outcome model, and estimate the
treatment effect using g-computation. We’ll consider the marginal RR ATT
of <code>A</code> on the binary outcome <code>Y_B</code>.</p>
<p>The first step is to write the estimation function, we call
<code>boot_fun</code>. This function returns the marginal RR. In it, we
estimate the weights and the effect and return the estimate of
interest.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">boot_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">boot_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span></span>
<span>  </span>
<span>  <span class="co">#PS weighting for the ATT</span></span>
<span>  <span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weightit.html">weightit</a></span><span class="op">(</span><span class="va">A</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                 <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span>,</span>
<span>               data <span class="op">=</span> <span class="va">boot_data</span>,</span>
<span>               method <span class="op">=</span> <span class="st">"glm"</span>, estimand <span class="op">=</span> <span class="st">"ATT"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Bring weights into the dataset</span></span>
<span>  <span class="va">boot_data</span><span class="op">$</span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">$</span><span class="va">weights</span></span>
<span>  </span>
<span>  <span class="co">#Fit outcome model</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Y_B</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                 <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>             data <span class="op">=</span> <span class="va">boot_data</span>, weights <span class="op">=</span> <span class="va">weights</span>,</span>
<span>             family <span class="op">=</span> <span class="va">quasibinomial</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#G-computation</span></span>
<span>  <span class="va">comp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                          variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                          vcov <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                          newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">boot_data</span>, <span class="va">A</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                          wts <span class="op">=</span> <span class="st">"weights"</span>,</span>
<span>                          comparison <span class="op">=</span> <span class="st">"lnratioavg"</span>,</span>
<span>                          transform <span class="op">=</span> <span class="st">"exp"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">comp</span><span class="op">$</span><span class="va">estimate</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Next, we call <code><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot::boot()</a></code> with this function and the
original dataset supplied to perform the bootstrapping. We’ll request
199 bootstrap replications here, but in practice you should use many
more, upwards of 999. More is always better. Using more also allows you
to use the bias-corrected and accelerated (BCa) bootstrap confidence
intervals (which you can request by setting <code>type = "bca"</code> in
the call to <code><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot.ci()</a></code>), which are known to be the most
accurate. See <code><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">?boot.ci</a></code> for details. Here, we’ll just use a
percentile confidence interval.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"boot"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">54321</span><span class="op">)</span></span>
<span><span class="va">boot_out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot</a></span><span class="op">(</span><span class="va">d</span>, <span class="va">boot_fun</span>, R <span class="op">=</span> <span class="fl">199</span><span class="op">)</span></span>
<span></span>
<span><span class="va">boot_out</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## ORDINARY NONPARAMETRIC BOOTSTRAP</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Call:</span></span>
<span><span class="co">## boot(data = d, statistic = boot_fun, R = 199)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Bootstrap Statistics :</span></span>
<span><span class="co">##     original    bias    std. error</span></span>
<span><span class="co">## t1*    1.477 -0.008648      0.1108</span></span></code></pre>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot.ci</a></span><span class="op">(</span><span class="va">boot_out</span>, type <span class="op">=</span> <span class="st">"perc"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## BOOTSTRAP CONFIDENCE INTERVAL CALCULATIONS</span></span>
<span><span class="co">## Based on 199 bootstrap replicates</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## CALL : </span></span>
<span><span class="co">## boot.ci(boot.out = boot_out, type = "perc")</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Intervals : </span></span>
<span><span class="co">## Level     Percentile     </span></span>
<span><span class="co">## 95%   ( 1.274,  1.693 )  </span></span>
<span><span class="co">## Calculations and Intervals on Original Scale</span></span>
<span><span class="co">## Some percentile intervals may be unstable</span></span></code></pre>
<p>We find a RR of 1.477 with a confidence interval of (1.274, 1.693).
If we had wanted a risk difference, we could have adjusted the arguments
to <code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons()</a></code> (i.e., by removing the
<code>comparison</code> and <code>transform</code> arguments).</p>
<p>To estimate the bootstrap confidence for the HR, we can do the same
as above except our <code>boot_fun</code> will look like the
following:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">boot_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">boot_data</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">[</span><span class="va">i</span>,<span class="op">]</span></span>
<span>  </span>
<span>  <span class="co">#PS weighting for the ATE</span></span>
<span>  <span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weightit.html">weightit</a></span><span class="op">(</span><span class="va">A</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                 <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span>,</span>
<span>               data <span class="op">=</span> <span class="va">boot_data</span>,</span>
<span>               method <span class="op">=</span> <span class="st">"glm"</span>, estimand <span class="op">=</span> <span class="st">"ATT"</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Bring weights into the dataset</span></span>
<span>  <span class="va">boot_data</span><span class="op">$</span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">$</span><span class="va">weights</span></span>
<span>  </span>
<span>  <span class="co">#Fit outcome model</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Y_S</span><span class="op">)</span> <span class="op">~</span> <span class="va">A</span>, data <span class="op">=</span> <span class="va">boot_data</span>,</span>
<span>               weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">#Return the coefficient on treatment</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">[</span><span class="st">"A"</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>(Remember that you will need to load in the <code>survival</code>
package before doing so.)</p>
</div>
</div>
<div class="section level2">
<h2 id="reporting-results">Reporting Results<a class="anchor" aria-label="anchor" href="#reporting-results"></a>
</h2>
<p>It is important to be as thorough and complete as possible when
describing the methods of estimating the treatment effect and the
results of the analysis. This improves transparency and replicability of
the analysis. Results should at least include the following:</p>
<ul>
<li>a description of the outcome model used (e.g., logistic regression,
a linear model with treatment-covariate interactions and covariates, a
Cox proportional hazards model with the propensity score weights
applied)</li>
<li>the way the effect was estimated (e.g., using g-computation or as
the coefficient in the outcome model)</li>
<li>the way SEs and confidence intervals were estimated (e.g., using
robust SEs, using the BCa bootstrap with 4999 bootstrap replications and
the entire process of weighting and effect estimation included in each
replication)</li>
<li>R packages and functions used in estimating the effect and its SE
(e.g., <code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code> in base R, <code><a href="https://rdrr.io/pkg/marginaleffects/man/comparisons.html" class="external-link">avg_comparisons()</a></code> in
<code>marginaleffects</code>, <code><a href="https://rdrr.io/pkg/boot/man/boot.html" class="external-link">boot()</a></code> and
<code><a href="https://rdrr.io/pkg/boot/man/boot.ci.html" class="external-link">boot.ci()</a></code> in <code>boot</code>)</li>
<li>The effect and its SE and confidence interval</li>
</ul>
<p>All this is in addition to information about the weighting method,
estimand, propensity score estimation procedure (if used), balance
assessment, etc.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-austin2016" class="csl-entry">
Austin, Peter C. 2016. <span>“Variance Estimation When Using Inverse
Probability of Treatment Weighting (IPTW) with Survival
Analysis.”</span> <em>Statistics in Medicine</em> 35 (30): 5642–55. <a href="https://doi.org/10.1002/sim.7084" class="external-link">https://doi.org/10.1002/sim.7084</a>.
</div>
<div id="ref-austin2022" class="csl-entry">
———. 2022. <span>“Bootstrap Vs Asymptotic Variance Estimation When Using
Propensity Score Weighting with Continuous and Binary Outcomes.”</span>
<em>Statistics in Medicine</em> 41 (22): 4426–43. <a href="https://doi.org/10.1002/sim.9519" class="external-link">https://doi.org/10.1002/sim.9519</a>.
</div>
<div id="ref-chanGloballyEfficientNonparametric2016" class="csl-entry">
Chan, Kwun Chuen Gary, Sheung Chi Phillip Yam, and Zheng Zhang. 2016.
<span>“Globally Efficient Non-Parametric Inference of Average Treatment
Effects by Empirical Balancing Calibration Weighting.”</span>
<em>Journal of the Royal Statistical Society: Series B (Statistical
Methodology)</em> 78 (3): 673–700. <a href="https://doi.org/10.1111/rssb.12129" class="external-link">https://doi.org/10.1111/rssb.12129</a>.
</div>
<div id="ref-efronBootstrapMethodsStandard1986" class="csl-entry">
Efron, B., and R. Tibshirani. 1986. <span>“Bootstrap Methods for
Standard Errors, Confidence Intervals, and Other Measures of Statistical
Accuracy.”</span> <em>Statistical Science</em> 1 (1): 54–75. <a href="https://www.jstor.org/stable/2245500" class="external-link">https://www.jstor.org/stable/2245500</a>.
</div>
<div id="ref-greiferChoosingEstimandWhen2021" class="csl-entry">
Greifer, Noah, and Elizabeth A. Stuart. 2021. <span>“Choosing the
Estimand When Matching or Weighting in Observational Studies.”</span>
<em>arXiv:2106.10577 [Stat]</em>, June. <a href="https://arxiv.org/abs/2106.10577" class="external-link">https://arxiv.org/abs/2106.10577</a>.
</div>
<div id="ref-hainmuellerEntropyBalancingCausal2012" class="csl-entry">
Hainmueller, J. 2012. <span>“Entropy Balancing for Causal Effects:
<span>A</span> Multivariate Reweighting Method to Produce Balanced
Samples in Observational Studies.”</span> <em>Political Analysis</em> 20
(1): 25–46. <a href="https://doi.org/10.1093/pan/mpr025" class="external-link">https://doi.org/10.1093/pan/mpr025</a>.
</div>
<div id="ref-hajage2018" class="csl-entry">
Hajage, David, Guillaume Chauvet, Lisa Belin, Alexandre Lafourcade,
Florence Tubach, and Yann De Rycke. 2018. <span>“Closed-Form Variance
Estimator for Weighted Propensity Score Estimators with Survival
Outcome.”</span> <em>Biometrical Journal</em> 60 (6): 1151–63. <a href="https://doi.org/10.1002/bimj.201700330" class="external-link">https://doi.org/10.1002/bimj.201700330</a>.
</div>
<div id="ref-hoMatchingNonparametricPreprocessing2007" class="csl-entry">
Ho, Daniel E., Kosuke Imai, Gary King, and Elizabeth A. Stuart. 2007.
<span>“Matching as Nonparametric Preprocessing for Reducing Model
Dependence in Parametric Causal Inference.”</span> <em>Political
Analysis</em> 15 (3): 199–236. <a href="https://doi.org/10.1093/pan/mpl013" class="external-link">https://doi.org/10.1093/pan/mpl013</a>.
</div>
<div id="ref-huling2023" class="csl-entry">
Huling, Jared D., Noah Greifer, and Guanhua Chen. 2023.
<span>“Independence Weights for Causal Inference with Continuous
Treatments.”</span> <em>Journal of the American Statistical
Association</em>, May, 1–25. <a href="https://doi.org/10.1080/01621459.2023.2213485" class="external-link">https://doi.org/10.1080/01621459.2023.2213485</a>.
</div>
<div id="ref-mackinnonBootstrapMethodsEconometrics2006" class="csl-entry">
MacKinnon, James G. 2006. <span>“Bootstrap Methods in
Econometrics.”</span> <em>Economic Record</em> 82 (s1): S2–18. <a href="https://doi.org/10.1111/j.1475-4932.2006.00328.x" class="external-link">https://doi.org/10.1111/j.1475-4932.2006.00328.x</a>.
</div>
<div id="ref-mackinnonHeteroskedasticityconsistentCovarianceMatrix1985" class="csl-entry">
MacKinnon, James G, and Halbert White. 1985. <span>“Some
Heteroskedasticity-Consistent Covariance Matrix Estimators with Improved
Finite Sample Properties.”</span> <em>Journal of Econometrics</em> 29
(3): 305–25. <a href="https://doi.org/10.1016/0304-4076(85)90158-7" class="external-link">https://doi.org/10.1016/0304-4076(85)90158-7</a>.
</div>
<div id="ref-mao2018" class="csl-entry">
Mao, Huzhang, Liang Li, Wei Yang, and Yu Shen. 2018. <span>“On the
Propensity Score Weighting Analysis with Survival Outcome: Estimands,
Estimation, and Inference.”</span> <em>Statistics in Medicine</em> 37
(26): 3745–63. <a href="https://doi.org/10.1002/sim.7839" class="external-link">https://doi.org/10.1002/sim.7839</a>.
</div>
<div id="ref-nguyenDoubleadjustmentPropensityScore2017" class="csl-entry">
Nguyen, Tri-Long, Gary S. Collins, Jessica Spence, Jean-Pierre Daurès,
P. J. Devereaux, Paul Landais, and Yannick Le Manach. 2017.
<span>“Double-Adjustment in Propensity Score Matching Analysis: Choosing
a Threshold for Considering Residual Imbalance.”</span> <em>BMC Medical
Research Methodology</em> 17: 78. <a href="https://doi.org/10.1186/s12874-017-0338-0" class="external-link">https://doi.org/10.1186/s12874-017-0338-0</a>.
</div>
<div id="ref-reifeisVarianceTreatmentEffect2020" class="csl-entry">
Reifeis, Sarah A., and Michael G. Hudgens. 2020. <span>“On Variance of
the Treatment Effect in the Treated Using Inverse Probability
Weighting.”</span> <em>arXiv:2011.11874 [Stat]</em>, November. <a href="https://arxiv.org/abs/2011.11874" class="external-link">https://arxiv.org/abs/2011.11874</a>.
</div>
<div id="ref-robinsMarginalStructuralModels2000" class="csl-entry">
Robins, James M., Miguel Ángel Hernán, and Babette Brumback. 2000.
<span>“Marginal Structural Models and Causal Inference in
Epidemiology.”</span> <em>Epidemiology</em> 11 (5): 550–60. <a href="https://doi.org/10.1097/00001648-200009000-00011" class="external-link">https://doi.org/10.1097/00001648-200009000-00011</a>.
</div>
<div id="ref-schaferAverageCausalEffects2008" class="csl-entry">
Schafer, Joseph L., and Joseph Kang. 2008. <span>“Average Causal Effects
from Nonrandomized Studies: A Practical Guide and Simulated
Example.”</span> <em>Psychological Methods</em> 13 (4): 279–313. <a href="https://doi.org/10.1037/a0014268" class="external-link">https://doi.org/10.1037/a0014268</a>.
</div>
<div id="ref-snowdenImplementationGComputationSimulated2011" class="csl-entry">
Snowden, Jonathan M., Sherri Rose, and Kathleen M. Mortimer. 2011.
<span>“Implementation of G-Computation on a Simulated Data Set:
Demonstration of a Causal Inference Technique.”</span> <em>American
Journal of Epidemiology</em> 173 (7): 731–38. <a href="https://doi.org/10.1093/aje/kwq472" class="external-link">https://doi.org/10.1093/aje/kwq472</a>.
</div>
<div id="ref-vansteelandtInvitedCommentaryGComputation2011" class="csl-entry">
Vansteelandt, Stijn, and Niels Keiding. 2011. <span>“Invited Commentary:
G-Computation<span></span>lost in Translation?”</span> <em>American
Journal of Epidemiology</em> 173 (7): 739–42. <a href="https://doi.org/10.1093/aje/kwq474" class="external-link">https://doi.org/10.1093/aje/kwq474</a>.
</div>
<div id="ref-wangGcomputationAverageTreatment2017" class="csl-entry">
Wang, Aolin, Roch A. Nianogo, and Onyebuchi A. Arah. 2017.
<span>“G-Computation of Average Treatment Effects on the Treated and the
Untreated.”</span> <em>BMC Medical Research Methodology</em> 17 (1): 3.
<a href="https://doi.org/10.1186/s12874-016-0282-4" class="external-link">https://doi.org/10.1186/s12874-016-0282-4</a>.
</div>
<div id="ref-westreichTableFallacyPresenting2013" class="csl-entry">
Westreich, Daniel, and Sander Greenland. 2013. <span>“The Table 2
Fallacy: Presenting and Interpreting Confounder and Modifier
Coefficients.”</span> <em>American Journal of Epidemiology</em> 177 (4):
292–98. <a href="https://doi.org/10.1093/aje/kws412" class="external-link">https://doi.org/10.1093/aje/kws412</a>.
</div>
</div>
</div>
<div class="section level2">
<h2 id="code-to-generate-data-used-in-examples">Code to Generate Data used in Examples<a class="anchor" aria-label="anchor" href="#code-to-generate-data-used-in-examples"></a>
</h2>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Generating data similar to Austin (2009) for demonstrating treatment effect estimation</span></span>
<span><span class="va">gen_X</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">9</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">n</span>, ncol <span class="op">=</span> <span class="fl">9</span><span class="op">)</span></span>
<span>  <span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">.5</span><span class="op">)</span></span>
<span>  <span class="va">X</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">gen_Ac</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">LP_A</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1.2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.4</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">7</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">8</span><span class="op">]</span></span>
<span>  <span class="va">LP_A</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">rlogis</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#~20% treated</span></span>
<span><span class="va">gen_A</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Ac</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">1</span> <span class="op">*</span> <span class="op">(</span><span class="va">Ac</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">gen_Am</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">A</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"T"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"C1"</span>, <span class="st">"C2"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Continuous outcome</span></span>
<span><span class="va">gen_Y_C</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">2</span><span class="op">*</span><span class="va">A</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">6</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#Conditional:</span></span>
<span><span class="co">#  MD: 2</span></span>
<span><span class="co">#Marginal:</span></span>
<span><span class="co">#  MD: 2</span></span>
<span></span>
<span><span class="co"># Binary outcome</span></span>
<span><span class="va">gen_Y_B</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">LP_B</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.4</span><span class="op">)</span><span class="op">*</span><span class="va">A</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.4</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">6</span><span class="op">]</span></span>
<span>  <span class="va">P_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">LP_B</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">P_B</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#Conditional:</span></span>
<span><span class="co">#  OR:   2.4</span></span>
<span><span class="co">#  logOR: .875</span></span>
<span><span class="co">#Marginal:</span></span>
<span><span class="co">#  RD:    .144</span></span>
<span><span class="co">#  RR:   1.54</span></span>
<span><span class="co">#  logRR: .433</span></span>
<span><span class="co">#  OR:   1.92</span></span>
<span><span class="co">#  logOR  .655</span></span>
<span></span>
<span><span class="co"># Survival outcome</span></span>
<span><span class="va">gen_Y_S</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">LP_S</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.4</span><span class="op">)</span><span class="op">*</span><span class="va">A</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.4</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">6</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="fl">2e4</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">LP_S</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#Conditional:</span></span>
<span><span class="co">#  HR:   2.4</span></span>
<span><span class="co">#  logHR: .875</span></span>
<span><span class="co">#Marginal:</span></span>
<span><span class="co">#  HR:   1.57</span></span>
<span><span class="co">#  logHR: .452</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">19599</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu">gen_X</span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">Ac</span> <span class="op">&lt;-</span> <span class="fu">gen_Ac</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">gen_A</span><span class="op">(</span><span class="va">Ac</span><span class="op">)</span></span>
<span><span class="va">Am</span> <span class="op">&lt;-</span> <span class="fu">gen_Am</span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Y_C</span> <span class="op">&lt;-</span> <span class="fu">gen_Y_C</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span></span>
<span><span class="va">Y_B</span> <span class="op">&lt;-</span> <span class="fu">gen_Y_B</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span></span>
<span><span class="va">Y_S</span> <span class="op">&lt;-</span> <span class="fu">gen_Y_S</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">Am</span>, <span class="va">Ac</span>, <span class="va">X</span>, <span class="va">Y_C</span>, <span class="va">Y_B</span>, <span class="va">Y_S</span><span class="op">)</span></span></code></pre></div>
</div>

  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Noah Greifer.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
