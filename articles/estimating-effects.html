<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Estimating Effects After Weighting • WeightIt</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimating Effects After Weighting">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">WeightIt</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/WeightIt.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/estimating-effects.html">Estimating Effects After Weighting</a></li>
    <li><a class="dropdown-item" href="../articles/installing-packages.html">Installing Supporting Packages</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ngreifer/WeightIt/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Estimating Effects After Weighting</h1>
                        <h4 data-toc-skip class="author">Noah
Greifer</h4>
            
            <h4 data-toc-skip class="date">2024-07-27</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ngreifer/WeightIt/blob/master/vignettes/estimating-effects.Rmd" class="external-link"><code>vignettes/estimating-effects.Rmd</code></a></small>
      <div class="d-none name"><code>estimating-effects.Rmd</code></div>
    </div>

    
    
<style>
pre {
  overflow-x: auto;
}
pre code {
  word-wrap: normal;
  white-space: pre;
}
</style>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>After assessing balance and deciding on a weighting specification, it
comes time to estimate the effect of the treatment in the weighted
sample. How the effect is estimated and interpreted depends on the
desired estimand and the effect measure used. In addition to estimating
effects, estimating the uncertainty of the effects is critical in
communicating them and assessing whether the observed effect is
compatible with there being no effect in the population. This guide
explains how to estimate effects after weighting for point and
longitudinal treatments and with various outcome types.</p>
<p>This guide is structured as follows: first, information on the
concepts related to effect and standard error (SE) estimation is
presented below. Then, instructions for how to estimate effects and SEs
are described for the standard case (weighting for the ATE with a binary
treatment and continuous outcome) and some other common circumstances.
Finally, recommendations for reporting results and tips to avoid making
common mistakes are presented.</p>
<div class="section level3">
<h3 id="identifying-the-estimand">Identifying the estimand<a class="anchor" aria-label="anchor" href="#identifying-the-estimand"></a>
</h3>
<p>Before an effect is estimated, the estimand must be specified and
clarified. Although some aspects of the estimand depend not only on how
the effect is estimated after weighting but also on the weighting method
itself, other aspects must be considered at the time of effect
estimation and interpretation. Here, we consider three aspects of the
estimand: the population the effect is meant to generalize to (the
target population), the effect measure, and whether the effect is
marginal or conditional.</p>
<p><strong>The target population.</strong> Different weighting methods
allow you to estimate effects that can generalize to different target
populations. The most common estimand in weighting is the average
treatment effect in the population (ATE), which is the average effect of
treatment for the population from which the sample is a random sample.
Other common estimands include the average treatment effect in the
treated (ATT), the average treatment effect in the control (ATC), and
the average treatment effect in the overlap (ATO). These are defined and
explained in <span class="citation">Greifer and Stuart (<a href="#ref-greiferChoosingEstimandWhen2021">2021</a>)</span>. The
estimand for weighting is controlled by the <code>estimand</code>
argument in the call to <code><a href="../reference/weightit.html">weightit()</a></code>. Other allowable
estimands for some weighting methods include the average treatment
effect in the matched sample (ATM) and the average treatment effect in
the optimal subset (ATOS). These are treated just like the ATO and will
not be differentiated further.</p>
<p><strong>Marginal and conditional effects.</strong> A marginal effect
is a comparison between the expected potential outcome under treatment
and the expected potential outcome under control. This is the same
quantity estimated in randomized trials without blocking or covariate
adjustment and is particularly useful for quantifying the overall effect
of a policy or population-wide intervention. A conditional effect is the
comparison between the expected potential outcomes in the treatment
groups within strata. This is useful for identifying the effect of a
treatment for an individual patient or a subset of the population.</p>
<p><strong>Effect measures.</strong> The outcome types we consider here
are continuous, with the effect measured by the mean difference; binary,
with the effect measured by the risk difference (RD), risk ratio (RR),
or odds ratio (OR); and time-to-event (i.e., survival), with the effect
measured by the hazard ratio (HR). The RR, OR, and HR are
<em>noncollapsible</em> effect measures, which means the marginal effect
on that scale is not a (possibly) weighted average of the conditional
effects within strata, even if the stratum-specific effects are of the
same magnitude. For these effect measures, it is critical to distinguish
between marginal and conditional effects because different statistical
methods target different types of effects. The mean difference and RD
are <em>collapsible</em> effect measures, so the same methods can be
used to estimate marginal and conditional effects.</p>
<p>Our primary focus will be on marginal effects, which are appropriate
for all effect measures, easily interpretable, and require few modeling
assumptions.</p>
</div>
<div class="section level3">
<h3 id="g-computation">G-computation<a class="anchor" aria-label="anchor" href="#g-computation"></a>
</h3>
<p>To estimate marginal effects, we use a method known as g-computation
<span class="citation">(<a href="#ref-snowdenImplementationGComputationSimulated2011">Snowden,
Rose, and Mortimer 2011</a>)</span> or regression estimation <span class="citation">(<a href="#ref-schaferAverageCausalEffects2008">Schafer
and Kang 2008</a>)</span>. This involves first specifying a model for
the outcome as a function of the treatment and covariates. Then, for
each unit, we compute their predicted values of the outcome setting
their treatment status to treated, and then again for control, leaving
us with two predicted outcome values for each unit, which are estimates
of the potential outcomes under each treatment level. We compute the
mean of each of the estimated potential outcomes across the entire
sample, which leaves us with two average estimated potential outcomes.
Finally, the contrast of these average estimated potential outcomes
(e.g., their difference or ratio, depending on the effect measure
desired) is the estimate of the treatment effect.</p>
<p>When doing g-computation after weighting, a few additional
considerations are required. First, the outcome model should be fit
incorporating the estimated weights (e.g., using weighted least squares
or weighted maximum likelihood estimation) <span class="citation">(<a href="#ref-vansteelandtInvitedCommentaryGComputation2011">Vansteelandt
and Keiding 2011</a>)</span>. Second, when we take the average of the
estimated potential outcomes under each treatment level, if an estimand
other than the ATT, ATC, or ATE is used or sampling weights are
included, this must be a weighted average that incorporates the
weights<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Note: Previously, this guide recommended always
including the weights. We believe best practice is to omit them, though
this does not mean previous analyses using weighted averages are
invalid.&lt;/p&gt;"><sup>1</sup></a>.
Third, if we want to target the ATT or ATC, we only estimate potential
outcomes for the treated or control group, respectively (though we still
generate predicted values under both treatment and control) <span class="citation">(<a href="#ref-wangGcomputationAverageTreatment2017">Wang, Nianogo, and Arah
2017</a>)</span>.</p>
<p>G-computation as a framework for estimating effects after weighting
has a number of advantages over other approaches. It works the same
regardless of the form of the outcome model or type of outcome (e.g.,
whether a linear model is used for a continuous outcome or a logistic
model is used for a binary outcome); the only difference might be how
the average expected potential outcomes are contrasted in the final
step. In simple cases, the estimated effect is numerically identical to
effects estimated using other methods; for example, if no covariates are
included in the outcome model, the g-computation estimate is equal to
the difference in means from a t-test or coefficient of the treatment in
a linear model for the outcome. There are analytic and bootstrap
approximations to the SEs of the g-computation estimate. The analytic
approximation is computed using the delta method, a technique for
computing the SE of a quantity derived from the regression model
parameters, such as the g-computation estimate.</p>
<p>For the reasons above, we use weighted g-computation when possible
for all effect estimates, even if there are simpler methods that would
yield the same estimates. Using a single workflow (with some slight
modifications depending on the context; see below) facilitates
implementing best practices regardless of what choices a user makes.</p>
<p>There are other methods to incorporate the outcome model into
estimation of the treatment effect, the best studied of which is
augmented inverse probability weighting (AIPW), which also involves a
g-computation step. We only describe weighted g-computation here because
of its conceptual simplicity, ease of implementation, and connection
with best practices for estimating effects after matching.</p>
</div>
<div class="section level3">
<h3 id="modeling-the-outcome">Modeling the Outcome<a class="anchor" aria-label="anchor" href="#modeling-the-outcome"></a>
</h3>
<p>The goal of the outcome model is to generate good predictions for use
in the g-computation procedure described above. The type and form of the
outcome model should depend on the outcome type. For continuous
outcomes, one can use a linear model regressing the outcome on the
treatment; for binary outcomes, one can use a generalized linear model
with, e.g., a logistic link; for time-to-event outcomes, one can use a
Cox proportional hazards model. Note that the purpose of including the
outcome model is not to arrive at a doubly robust estimator (i.e., one
that is consistent if either the outcome or propensity score model is
correct); rather, it is simply to increase the precision of the weighted
estimate essentially for free. To take advantage of this feature, it is
important to use a canonical link (i.e., the default link for a given
family), as recommended by <span class="citation">Gabriel et al. (<a href="#ref-gabrielInverseProbabilityTreatment2024">2024</a>)</span>.</p>
<p>An additional decision to make is whether (and how) to include
covariates in the outcome model. One may ask, why use weighting at all
if you are going to model the outcome with covariates anyway? Weighting
reduces the dependence of the effect estimate on correct specification
of the outcome model; this is the central thesis of <span class="citation">Ho et al. (<a href="#ref-hoMatchingNonparametricPreprocessing2007">2007</a>)</span>
(though applied to matching in their case). Including covariates in the
outcome model after weighting has several functions: it can increase
precision in the effect estimate, reduce the bias due to residual
imbalance, and make the effect estimate “doubly robust”, which means it
is consistent if either the weighting reduces sufficient imbalance in
the covariates or if the outcome model is correct. For these reasons, we
recommend covariate adjustment after weighting when possible. There is
some evidence that covariate adjustment is most helpful for covariates
with standardized mean differences greater than .1 <span class="citation">(<a href="#ref-nguyenDoubleadjustmentPropensityScore2017">Nguyen et al.
2017</a>)</span>, so these covariates and covariates thought to be
highly predictive of the outcome should be prioritized in treatment
effect models if not all can be included due to sample size
constraints.</p>
<p>Although there are many possible ways to include covariates (e.g.,
not just main effects but interactions, smoothing terms like splines, or
other nonlinear transformations), it is important not to engage in
specification search (i.e., trying many outcomes models in search of the
“best” one). Doing so can invalidate results and yield a conclusion that
fails to replicate. For this reason, we recommend only including the
same terms included in the weighting model unless there is a strong
<em>a priori</em> and justifiable reason to model the outcome
differently.</p>
<p>It is important not to interpret the coefficients and tests of
covariates in the outcome model. These are not causal effects and their
estimates may be severely confounded. Only the treatment effect estimate
can be interpreted as causal assuming the relevant assumptions about
unconfoundedness are met. Inappropriately interpreting the coefficients
of covariates in the outcome model is known as the Table 2 fallacy <span class="citation">(<a href="#ref-westreichTableFallacyPresenting2013">Westreich and Greenland
2013</a>)</span>. To avoid this, we only display the results of the
g-computation procedure and do not examine or interpret the outcome
models themselves.</p>
</div>
<div class="section level3">
<h3 id="estimating-standard-errors-and-confidence-intervals">Estimating Standard Errors and Confidence Intervals<a class="anchor" aria-label="anchor" href="#estimating-standard-errors-and-confidence-intervals"></a>
</h3>
<p>Uncertainty estimation (i.e., of SEs, confidence intervals, and
p-values) may consider the variety of sources of uncertainty present in
the analysis, including (but not limited to!) estimation of the
propensity score (if used) and estimation of the treatment effect (i.e.,
because of sampling error). For some methods, methods for analytically
computing the correct asymptotic SE have been described and are
implement in <code>WeightIt</code> when available. These methods rely on
M-estimation <span class="citation">(<a href="#ref-stefanskiCalculusMEstimation2002">Stefanski and Boos
2002</a>; <a href="#ref-rossMestimationCommonEpidemiological2024">Ross
et al. 2024</a>)</span>, a method of combining estimation of multiple
models to adjust the standard errors for their joint estimation. For
other methods, one must rely on an approximation that treats the weights
as fixed and known, which can either yield conservative or
anti-conservative standard errors depending on the method and estimand
<span class="citation">(<a href="#ref-austin2022">Austin 2022</a>; <a href="#ref-reifeisVarianceTreatmentEffect2020">Reifeis and Hudgens
2020</a>)</span>. Alternatively, one can use the bootstrap, which tends
to have good performance regardless of the situation but can be
computationally intensive for large datasets or slow weight estimation
methods <span class="citation">(<a href="#ref-austin2022">Austin
2022</a>)</span>. We describe the correct asymptotic standard errors,
the robust standard errors treating the weights as fixed, and the
bootstrap below.</p>
<div class="section level4">
<h4 id="asymptotically-correct-standard-errors-using-m-estimation">Asymptotically Correct Standard Errors Using M-estimation<a class="anchor" aria-label="anchor" href="#asymptotically-correct-standard-errors-using-m-estimation"></a>
</h4>
<p>M-estimation involves specifying a stack of estimating equations, one
for each parameter to be estimated, that are each a function of the
parameters. The final parameter estimates are those that yield a vector
of 0s for the solutions of the estimating equations. These estimating
equations include the parameters of the weighting model (e.g., the
coefficients in the logistic regression model for the propensity score)
and the parameters of the outcome model (i.e., the coefficients on
treatment and the covariates). It is possible to compute the joint
covariance matrix of all the estimated parameters using functions of the
estimating equations and the estimated parameters. We refer curious
readers to <span class="citation">Stefanski and Boos (<a href="#ref-stefanskiCalculusMEstimation2002">2002</a>)</span> for an
introduction.</p>
<p>Most theoretical developments on the estimation of asymptotically
correct standard errors for propensity score-weighted treatment effect
estimates rely on M-estimation theory <span class="citation">(<a href="#ref-luncefordStratificationWeightingPropensity2004">Lunceford and
Davidian 2004</a>; <a href="#ref-reifeisVarianceTreatmentEffect2020">Reifeis and Hudgens
2020</a>; <a href="#ref-gabrielInverseProbabilityTreatment2024">Gabriel
et al. 2024</a>)</span>. This method can only be used when the model
used to estimate the weights involves estimating equations. Currently,
only weights estimated using a generalized linear model propensity
score, entropy balancing, inverse probability tilting, or the
just-identified covariate balancing propensity score can be accommodated
with this method. <code><a href="../reference/glm_weightit.html">glm_weightit()</a></code> can be used to fit
generalized linear models for the outcome that account for estimation of
the weights; <code><a href="../reference/glm_weightit.html">ordinal_weightit()</a></code>,
<code><a href="../reference/glm_weightit.html">multinom_weightit()</a></code>, and <code><a href="../reference/glm_weightit.html">coxph_weightit()</a></code> can
be used to fit ordinal, multinomial, and Cox proportional hazards
models. When estimating equations are not available for a given method,
the weights are treated as fixed and known, and the M-estimation
standard errors are equal to the robust standard errors described
below.</p>
</div>
<div class="section level4">
<h4 id="robust-standard-errors">Robust Standard Errors<a class="anchor" aria-label="anchor" href="#robust-standard-errors"></a>
</h4>
<p>Also known as sandwich SEs (due to the form of the formula for
computing them), heteroscedasticity-consistent SEs, or Huber-White SEs,
robust SEs are an adjustment to the usual maximum likelihood or ordinary
least squares SEs that are robust to violations of some of the
assumptions required for usual SEs to be valid <span class="citation">(<a href="#ref-mackinnonHeteroskedasticityconsistentCovarianceMatrix1985">MacKinnon
and White 1985</a>)</span>. They can also be adjusted to accommodate
arbitrary levels of clustering in the data (e.g., when units are sampled
from schools). Robust SEs have been shown to be conservative (i.e.,
yielding overly large SEs and wide confidence intervals) for estimating
the ATE after some forms of weighting <span class="citation">(<a href="#ref-robinsMarginalStructuralModels2000">Robins, Hernán, and
Brumback 2000</a>)</span>, though they can be either conservative or not
for other weighting methods and estimands, such as for the ATT <span class="citation">(<a href="#ref-reifeisVarianceTreatmentEffect2020">Reifeis and Hudgens
2020</a>)</span> or for entropy balancing <span class="citation">(<a href="#ref-chanGloballyEfficientNonparametric2016">Chan, Yam, and Zhang
2016</a>)</span>. Robust SEs treat the estimated weights as if they were
fixed and known, ignoring uncertainty in their estimation that is
otherwise accounted for by the asymptotically correct standard errors
described above. Although they are quick and simple to estimate using
functionality in the <code>sandwich</code> and <code>survey</code>
packages or using <code><a href="../reference/glm_weightit.html">glm_weightit()</a></code>, they should be used with
caution, and the bootstrap (described below) or asymptotically correct
standard errors should be preferred in most cases.</p>
</div>
<div class="section level4">
<h4 id="bootstrapping">Bootstrapping<a class="anchor" aria-label="anchor" href="#bootstrapping"></a>
</h4>
<p>Some problems with the robust SEs described above include that they
fail to take into account the estimation of the weights and are only an
approximation when used to compute derived quantities from nonlinear
models, which is often true when using g-computation to estimate
effects. One solution to these problems is bootstrapping, which is a
technique used to simulate the sampling distribution of an estimator by
repeatedly drawing samples with replacement and estimating the effect in
each bootstrap sample <span class="citation">(<a href="#ref-efronBootstrapMethodsStandard1986">Efron and Tibshirani
1986</a>)</span>. From the bootstrap distribution, SEs and confidence
intervals can be computed in several ways, including using the standard
deviation of the bootstrap estimates as the SE estimate or using the 2.5
and 97.5 percentiles as 95% confidence interval bounds. Bootstrapping
tends to be most useful when no analytic estimator of a SE is possible
or has been derived yet. Bootstrapping has been found to be effective at
estimating SEs and confidence intervals after weighting, often
performing better even than the asymptotically correct method when it is
available, specially in smaller samples <span class="citation">(<a href="#ref-austin2022">Austin 2022</a>)</span>.</p>
<p>Typically, bootstrapping involves performing the entire estimation
process in each bootstrap sample, including estimation both of the
weights and the outcome model parameters. More bootstrap replications
are always better but can take time and increase the chances that at
least one error will occur within the bootstrap analysis (e.g., a
bootstrap sample with zero treated units or zero units with an event).
In general, numbers of replications upwards of 1000 are recommended. The
traditional bootstrap resamples units from the dataset, and the
fractional weighted bootstrap <span class="citation">(<a href="#ref-xuApplicationsFractionalRandomWeightBootstrap2020a">Xu et al.
2020</a>)</span> draws a weight for each unit from a specified
distribution and treats the weights as sampling weights in each
replication. Both are equally valid in most cases, but the fractional
weighted bootstrap can outperform the traditional bootstrap when sparse
categorical variables are present in the data.</p>
<p>Bootstrap standard errors can be computed manually using
<code>boot</code> (for the traditional bootstrap) or <code>fwb</code>
(for the fractional weighted bootstrap) or automatically using
functionality in <code><a href="../reference/glm_weightit.html">glm_weightit()</a></code>, which, in each bootstrap
sample, re-estimates the weights and then uses those weights to fit the
outcome model. The covariance of the bootstrap estimates is used as the
parameter variance matrix. There are some methods of computing bootstrap
confidence intervals that use the bootstrap replications themselves,
e.g., by using the quantiles of the bootstrap distribution. Those are
not available in <code>WeightIt</code> and must be programmed
manually.</p>
<p>Because bootstrap standard errors involve a random component, it is
imperative to set a seed using <code><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed()</a></code> to ensure
reproducibility.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="estimating-treatment-effects-and-standard-errors-after-weighting">Estimating Treatment Effects and Standard Errors After
Weighting<a class="anchor" aria-label="anchor" href="#estimating-treatment-effects-and-standard-errors-after-weighting"></a>
</h2>
<p>Below, we describe effect estimation after weighting. The focus here
is not on evaluating the methods but simply on demonstrating them. In
all cases, the correct propensity score model is used. We will present
the asymptotically correct method that uses M-estimation, the method
that uses robust SEs that treat the weights as fixed, and
bootstrapping.</p>
<p>We’ll be using a simulated toy dataset <code>d</code> with several
outcome and treatment types. Code to generate the dataset is at the end
of this document. Below we display the first six rows of
<code>d</code>:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">d</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   A Am      Ac      X1      X2      X3       X4 X5      X6      X7      X8       X9    Y_C Y_B    Y_S</span></span>
<span><span class="co">## 1 0 C1 -2.2185  0.1725 -1.4283 -0.4103 -2.36059  1 -1.1199  0.6398 -0.4840 -0.59385 -3.591   0  857.7</span></span>
<span><span class="co">## 2 0 C2 -2.2837 -1.0959  0.8463  0.2456 -0.12333  1 -2.2687 -1.4491 -0.5514 -0.31439 -1.548   0  311.6</span></span>
<span><span class="co">## 3 0 C1 -1.1362  0.1768  0.7905 -0.8436  0.82366  1 -0.2221  0.2971 -0.6966 -0.69516  6.071   0  241.2</span></span>
<span><span class="co">## 4 0 C1 -0.8865 -0.4595  0.1726  1.9542 -0.62661  1 -0.4019 -0.8294 -0.5384  0.20729  2.491   1  142.4</span></span>
<span><span class="co">## 5 1  T  0.8613  0.3563 -1.8121  0.8135 -0.67189  1 -0.8297  1.7297 -0.6439 -0.02648 -1.100   0  206.8</span></span>
<span><span class="co">## 6 0 C2 -2.1697 -2.4313 -1.7984 -1.2940  0.04609  1 -1.2419 -1.1252 -1.8659 -0.56513 -9.850   0 1962.9</span></span></code></pre>
<p><code>A</code> is a binary treatment variable, <code>X1</code>
through <code>X9</code> are covariates, <code>Y_C</code> is a continuous
outcome, <code>Y_B</code> is a binary outcome, and <code>Y_S</code> is a
survival outcome. <code>Am</code> and <code>Ac</code> are multi-category
and continuous treatment variables, respectively.</p>
<p>In addition to <code>WeightIt</code> and whatever package may be
required to estimate the weights, we will need the following packages to
perform the analyses:</p>
<ul>
<li>
<code>marginaleffects</code> provides the
<code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons()</a></code> function for performing g-computation and
estimating the SEs and confidence intervals of the average estimate
potential outcomes and treatment effects</li>
<li>
<code>survival</code> provides <code>coxph()</code> to estimate the
coefficients in a Cox-proportional hazards model for the marginal hazard
ratio, which is called internally by <code><a href="../reference/glm_weightit.html">coxph_weightit()</a></code> for
survival outcomes</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ngreifer.github.io/WeightIt/">"WeightIt"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://marginaleffects.com/" class="external-link">"marginaleffects"</a></span><span class="op">)</span></span></code></pre></div>
<p>Effect estimates will be computed using
<code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">marginaleffects::avg_comparisons()</a></code>, even when its use may
be superfluous (e.g., for comparing the weighted difference in means).
As previously mentioned, this is because it is useful to have a single
workflow that works no matter the situation, perhaps with very slight
modifications to accommodate different contexts. Using
<code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons()</a></code> has several advantages, even when the
alternatives are simple: it only provides the effect estimate and not
other coefficients, and it always produces average marginal effects for
the correct population if requested.</p>
<p>Other packages may be of use but are not used here. There are
alternatives to the <code>marginaleffects</code> package for computing
average marginal effects, including <code>margins</code> and
<code>stdReg</code>. The <code>survey</code> package can be used to
estimate robust SEs incorporating weights and provides functions for
survey-weighted generalized linear models and Cox-proportional hazards
models. Much of the code here can be adapted to be used with
<code>survey</code>, and we will demonstrate that as well.</p>
<div class="section level3">
<h3 id="the-standard-case-binary-treatment-with-asymptotically-correct-ses">The Standard Case: Binary Treatment with Asymptotically Correct
SEs<a class="anchor" aria-label="anchor" href="#the-standard-case-binary-treatment-with-asymptotically-correct-ses"></a>
</h3>
<p>For many weighting methods, estimating the effect after weighting is
straightforward and involves fitting a model for the outcome that
incorporates the estimated weights using <code><a href="../reference/glm_weightit.html">lm_weightit()</a></code> or
<code><a href="../reference/glm_weightit.html">glm_weightit()</a></code>, then estimating the treatment effect using
g-computation (i.e., using
<code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">marginaleffects::avg_comparisons()</a></code>). This procedure is the
same for continuous and binary outcomes with and without covariates.
This method uses the asymptotically correct M-estimation-based SEs when
available and robust SEs otherwise or bootstrap standard errors if
requested.</p>
<p>There are a few adjustments that need to be made for certain
scenarios, which we describe in the section “Adjustments to the Standard
Case”. These adjustments include for the following cases: when weighting
for the ATT or ATC, for estimating effects with binary outcomes, and for
estimating effects with survival outcomes. Estimation for all estimands
other than the ATT and ATC proceeds as it does for the ATE. You must
read the Standard Case to understand the basic procedure before reading
about these special scenarios. We also demonstrate how to estimate
effects for multi-category, continuous, and sequential treatments.</p>
<p>Here, we demonstrate the faster analytic approach to estimating
confidence intervals; for the bootstrap approach, see the section “Using
Bootstrapping to Estimate Confidence Intervals” below.</p>
<p>First, we will perform propensity score weighting for the ATE.
Remember, all weighting methods use this exact procedure or a slight
variation, so this section is critical even if you are using a different
weighting method.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#PS weighting for the ATE with a logistic regression PS</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weightit.html">weightit</a></span><span class="op">(</span><span class="va">A</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span>, data <span class="op">=</span> <span class="va">d</span>,</span>
<span>              method <span class="op">=</span> <span class="st">"glm"</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span></span>
<span><span class="va">W</span></span></code></pre></div>
<pre><code><span><span class="co">## A <span style="font-style: italic;">weightit</span> object</span></span>
<span><span class="co">##  - method: "glm" (propensity score weighting with GLM)</span></span>
<span><span class="co">##  - number of obs.: 2000</span></span>
<span><span class="co">##  - sampling weights: none</span></span>
<span><span class="co">##  - treatment: 2-category</span></span>
<span><span class="co">##  - estimand: ATE</span></span>
<span><span class="co">##  - covariates: X1, X2, X3, X4, X5, X6, X7, X8, X9</span></span></code></pre>
<p>Typically one would assess balance and ensure that this weighting
specification works, but we will skip that step here to focus on effect
estimation. See <code><a href="../articles/WeightIt.html">vignette("WeightIt")</a></code> and
<code><a href="https://ngreifer.github.io/cobalt/articles/cobalt.html" class="external-link">vignette("cobalt", package = "cobalt")</a></code> for more information
on this necessary step.</p>
<p>First, we fit a model for the outcome given the treatment and
(optionally) the covariates. It’s usually a good idea to include
treatment-covariate interactions, which we do below, but this is not
always necessary, especially when excellent balance has been
achieved.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Linear model with covariates</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/glm_weightit.html">lm_weightit</a></span><span class="op">(</span><span class="va">Y_C</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                        <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>                    data <span class="op">=</span> <span class="va">d</span>, weightit <span class="op">=</span> <span class="va">W</span><span class="op">)</span></span></code></pre></div>
<p>Next, we use <code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">marginaleffects::avg_comparisons()</a></code> to
estimate the ATE.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons</a></span><span class="op">(</span><span class="va">fit</span>, variables <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Term          Contrast Estimate Std. Error    z Pr(&gt;|z|)    S 2.5 % 97.5 %</span></span>
<span><span class="co">##     A mean(1) - mean(0)     1.96      0.346 5.66   &lt;0.001 26.0  1.28   2.63</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high, predicted_lo, predicted_hi, predicted </span></span>
<span><span class="co">## Type:  response</span></span></code></pre>
<p>If, in addition to the effect estimate, we want the average estimated
potential outcomes, we can use
<code><a href="https://marginaleffects.com/man/predictions.html" class="external-link">marginaleffects::avg_predictions()</a></code>, which we demonstrate
below. Note the interpretation of the resulting estimates as the
expected potential outcomes is only valid if all covariates present in
the outcome model (if any) are interacted with the treatment.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://marginaleffects.com/man/predictions.html" class="external-link">avg_predictions</a></span><span class="op">(</span><span class="va">fit</span>, variables <span class="op">=</span> <span class="st">"A"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  A Estimate Std. Error    z Pr(&gt;|z|)    S 2.5 % 97.5 %</span></span>
<span><span class="co">##  0     1.42      0.135 10.5   &lt;0.001 84.0  1.16   1.68</span></span>
<span><span class="co">##  1     3.38      0.318 10.6   &lt;0.001 84.8  2.75   4.00</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: A, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </span></span>
<span><span class="co">## Type:  response</span></span></code></pre>
<p>We can see that the difference in potential outcome means is equal to
the average treatment effect computed previously<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;To verify that they are equal, supply the output of
&lt;code&gt;&lt;a href="https://marginaleffects.com/man/predictions.html" class="external-link"&gt;avg_predictions()&lt;/a&gt;&lt;/code&gt; to &lt;code&gt;&lt;a href="https://marginaleffects.com/man/hypotheses.html" class="external-link"&gt;hypotheses()&lt;/a&gt;&lt;/code&gt;, e.g.,
&lt;code&gt;avg_predictions(…) |&amp;gt; hypotheses("revpairwise")&lt;/code&gt;; this
explicitly compares the average potential outcomes and should yield
identical estimates to the &lt;code&gt;&lt;a href="https://marginaleffects.com/man/comparisons.html" class="external-link"&gt;avg_comparisons()&lt;/a&gt;&lt;/code&gt; call.&lt;/p&gt;'><sup>2</sup></a>. The arguments to
<code><a href="https://marginaleffects.com/man/predictions.html" class="external-link">avg_predictions()</a></code> are the same as those to
<code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons()</a></code>.</p>
</div>
<div class="section level3">
<h3 id="adjustments-to-the-standard-case">Adjustments to the Standard Case<a class="anchor" aria-label="anchor" href="#adjustments-to-the-standard-case"></a>
</h3>
<p>This section explains how the procedure might differ if any of the
following special circumstances occur.</p>
<div class="section level4">
<h4 id="weighting-for-the-att-or-atc">Weighting for the ATT or ATC<a class="anchor" aria-label="anchor" href="#weighting-for-the-att-or-atc"></a>
</h4>
<p>When weighting for the ATT, everything is identical to the Standard
Case except that in the calls to <code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons()</a></code> and
<code><a href="https://marginaleffects.com/man/predictions.html" class="external-link">avg_predictions()</a></code>, the <code>newdata</code> argument must
additionally be supplied to <code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons()</a></code> and
<code><a href="https://marginaleffects.com/man/predictions.html" class="external-link">avg_predictions()</a></code> as</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">newdata</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">A</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>This requests that g-computation be done only for the treated units.
For the ATC, replace <code>1</code> with <code>0</code>.</p>
</div>
<div class="section level4">
<h4 id="weighting-for-estimands-other-than-the-att-atc-or-ate">Weighting for estimands other than the ATT, ATC, or ATE<a class="anchor" aria-label="anchor" href="#weighting-for-estimands-other-than-the-att-atc-or-ate"></a>
</h4>
<p>When weighting for an estimand that changes the target population
away from one naturally defined by the data, e.g., for the ATO, ATM, or
ATOS, or when trimming weights in such a way that trimmed units are
dropped from the sample (i.e., receive a weight of 0), an adjustment
needs to be made to the call to <code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons()</a></code> and
<code><a href="https://marginaleffects.com/man/predictions.html" class="external-link">avg_predictions()</a></code>. For the estimands listed, we need to
supply the estimated weights to the <code>wts</code> argument. So, after
weighting for the ATO for example, we need to specify the following:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wts</span> <span class="op">=</span> <span class="va">W</span><span class="op">$</span><span class="va">weights</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="binary-outcomes">Binary outcomes<a class="anchor" aria-label="anchor" href="#binary-outcomes"></a>
</h4>
<p>Estimating effects on binary outcomes is essentially the same as for
continuous outcomes. The main difference is that there are several
measures of the effect one can consider, which include the odds ratio
(OR), risk ratio/relative risk (RR), and risk difference (RD), and the
syntax to <code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons()</a></code> depends on which one is
desired. The outcome model should be one appropriate for binary outcomes
(e.g., logistic regression) but is unrelated to the desired effect
measure because we can compute any of the above effect measures using
<code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons()</a></code> after the logistic regression.</p>
<p>To fit a logistic regression model, change <code><a href="../reference/glm_weightit.html">lm_weightit()</a></code>
to <code><a href="../reference/glm_weightit.html">glm_weightit()</a></code> and set <code>family = binomial</code>.
To compute the marginal RD, we can use exactly the same syntax as in the
Standard Case; nothing needs to change<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Note that for low or high average expected risks
computed with &lt;code&gt;&lt;a href="https://marginaleffects.com/man/predictions.html" class="external-link"&gt;predictions()&lt;/a&gt;&lt;/code&gt;, the confidence intervals may
go below 0 or above 1; this is because an approximation is used. To
avoid this problem, bootstrapping or simulation-based inference can be
used instead.&lt;/p&gt;'><sup>3</sup></a>.</p>
<p>To compute the marginal log RR, we need to add
<code>comparison = "lnratioavg"</code> to
<code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons()</a></code>; this computes the marginal log RR. To
get the marginal RR, we need to add <code>transform = "exp"</code> to
<code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons()</a></code>, which exponentiates the marginal log RR
and its confidence interval. The code below computes the effects and
displays the statistics of interest:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Logistic regression model with covariates</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/glm_weightit.html">glm_weightit</a></span><span class="op">(</span><span class="va">Y_B</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                        <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>                    data <span class="op">=</span> <span class="va">d</span>, weightit <span class="op">=</span> <span class="va">W</span>,</span>
<span>                    family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Compute effects; RR and confidence interval</span></span>
<span><span class="fu"><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                comparison <span class="op">=</span> <span class="st">"lnratioavg"</span>,</span>
<span>                transform <span class="op">=</span> <span class="st">"exp"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Term              Contrast Estimate Pr(&gt;|z|)    S 2.5 % 97.5 %</span></span>
<span><span class="co">##     A ln(mean(1) / mean(0))     1.64   &lt;0.001 39.5  1.43   1.88</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, estimate, p.value, s.value, conf.low, conf.high, predicted_lo, predicted_hi, predicted </span></span>
<span><span class="co">## Type:  response</span></span></code></pre>
<p>The output displays the marginal RR, its Z-value, the p-value for the
Z-test of the log RR against 0, and its confidence interval. (Note that
even though the <code>Contrast</code> label still suggests the log RR,
the RR is actually displayed.) To view the log RR and its standard
error, omit the <code>transform</code> argument.</p>
<p>For the marginal OR, the only thing that needs to change is that
<code>comparison</code> should be set to <code>"lnoravg"</code>.</p>
<p>Multi-category outcomes can be modeled using
<code><a href="../reference/glm_weightit.html">ordinal_weightit()</a></code> and <code><a href="../reference/glm_weightit.html">multinom_weightit()</a></code>,
which fit ordinal and multinomial regression models, respectively.</p>
</div>
<div class="section level4">
<h4 id="survival-outcomes">Survival outcomes<a class="anchor" aria-label="anchor" href="#survival-outcomes"></a>
</h4>
<p>There are several measures of effect size for survival outcomes, some
of which are described by <span class="citation">Mao et al. (<a href="#ref-mao2018">2018</a>)</span>. When using the Cox proportional
hazards model, the quantity of interest is the hazard ratio (HR) between
the treated and control groups. As with the OR, the HR is
non-collapsible, which means the estimated HR will only be a valid
estimate of the marginal HR when no other covariates are included in the
model. Other effect measures, such as the difference in mean survival
times or probability of survival after a given time, can be treated just
like continuous and binary outcomes as previously described.</p>
<p>For the HR, we cannot compute average marginal effects and must use
the coefficient on treatment in a Cox model fit without covariates. This
means that we cannot use the procedures from the Standard Case. Here we
describe estimating the marginal HR using <code><a href="../reference/glm_weightit.html">coxph_weightit()</a></code>,
which adapts <code>coxph()</code> from the <code>survival</code> package
but allows for estimation of SEs that account for estimation of the
weights. Robust SEs for HRs were studied by <span class="citation">Austin (<a href="#ref-austin2016">2016</a>)</span> and
were found to be conservative. Other formulas have been developed for
estimating standard errors more accurately <span class="citation">(<a href="#ref-mao2018">Mao et al. 2018</a>; <a href="#ref-hajage2018">Hajage et al. 2018</a>)</span>, though <span class="citation">Austin (<a href="#ref-austin2016">2016</a>)</span> also
found the bootstrap to be adequate. The HC0 robust standard error is
requested by default, and bootstrap standard errors can be requested by
setting <code>vcov</code> to <code>"BS"</code> or
<code>"FWB"</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Cox Regression for marginal HR</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/glm_weightit.html">coxph_weightit</a></span><span class="op">(</span><span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">Y_S</span><span class="op">)</span> <span class="op">~</span> <span class="va">A</span>, data <span class="op">=</span> <span class="va">d</span>,</span>
<span>                      weightit <span class="op">=</span> <span class="va">W</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Log HR estimates</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Call:</span></span></span>
<span><span class="co">## coxph_weightit(formula = survival::Surv(Y_S) ~ A, data = d, weightit = W)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Coefficients:</span></span></span>
<span><span class="co">##   Estimate Std. Error z value Pr(&gt;|z|)    </span></span>
<span><span class="co">## A    0.387     0.0965    4.02  5.9e-05 ***</span></span>
<span><span class="co">## <span style="font-style: italic;">Standard error: HC0 robust</span></span></span>
<span><span class="co"><span style="font-style: italic;">## </span></span></span></code></pre>
<p>Note that the output differs from that of
<code><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">survival::coxph()</a></code> and is more similar to that of
<code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code>. The <code>Estimate</code> column contains the log
HR. We can request the HR by setting <code>transform = "exp"</code> in
the call to <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#HR and CIs; requested by exponentiating log HRs</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit</span>, ci <span class="op">=</span> <span class="cn">TRUE</span>, transform <span class="op">=</span> <span class="st">"exp"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Call:</span></span></span>
<span><span class="co">## coxph_weightit(formula = survival::Surv(Y_S) ~ A, data = d, weightit = W)</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Coefficients (transformed):</span></span></span>
<span><span class="co">##   Estimate z value Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">## A     1.47    4.02 5.93e-05  1.22    1.8</span></span>
<span><span class="co">## <span style="font-style: italic;">Standard error: HC0 robust</span></span></span>
<span><span class="co"><span style="font-style: italic;">## </span></span></span></code></pre>
<p>The <code>adjustedCurves</code> package provides integration with
<code>WeightIt</code> to estimate adjusted survival estimands. We
strongly recommend using this package to estimate effects after
weighting.</p>
</div>
<div class="section level4">
<h4 id="using-sampling-weights-andor-clustered-data">Using sampling weights and/or clustered data<a class="anchor" aria-label="anchor" href="#using-sampling-weights-andor-clustered-data"></a>
</h4>
<p>When sampling weights are required to generalize to the correct
population, they must be included in the call to <code><a href="../reference/weightit.html">weightit()</a></code>
to estimate the balancing weights, in the outcome model, and in the call
to <code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons()</a></code>, etc. In most cases, this can be
handled without modifying the standard case except that
<code>s.weights</code> must be supplied to <code><a href="../reference/weightit.html">weightit()</a></code>, and
<code>wts = W$s.weights</code> must be supplied to
<code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons()</a></code>, etc. <code><a href="../reference/glm_weightit.html">lm_weightit()</a></code> and
<code><a href="../reference/glm_weightit.html">glm_weightit()</a></code> automatically incorporate the sampling
weights into estimation of the outcome model.</p>
<p>If there is clustering in the sampling design, such clustering can be
accounted for by using the <code>cluster</code> argument to
<code><a href="../reference/glm_weightit.html">glm_weightit()</a></code>, which accepts a one-sided formula with the
clustering variable(s) on the right side. These can be used with the
traditional or fractional weighted bootstrap as well.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Estimate the balancing weights, with sampling weights called "sw"</span></span>
<span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weightit.html">weightit</a></span><span class="op">(</span><span class="va">A</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span>, data <span class="op">=</span> <span class="va">d</span>,</span>
<span>              method <span class="op">=</span> <span class="st">"glm"</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>,</span>
<span>              s.weights <span class="op">=</span> <span class="st">"sw"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Fit the outcome model, with clustering variable "clu"</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/glm_weightit.html">glm_weightit</a></span><span class="op">(</span><span class="va">Y_C</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                           <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>                    data <span class="op">=</span> <span class="va">d</span>, weightit <span class="op">=</span> <span class="va">W</span>,</span>
<span>                    cluster <span class="op">=</span> <span class="op">~</span><span class="va">clu</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Compute the ATE, include sampling weights in the estimation</span></span>
<span><span class="fu"><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                wts <span class="op">=</span> <span class="va">W</span><span class="op">$</span><span class="va">s.weights</span><span class="op">)</span></span></code></pre></div>
<p>More complicated survey designs might require the use of the
<code>survey</code> package to handle them; it is important to note that
using <code>survey::svyglm()</code> instead of
<code><a href="../reference/glm_weightit.html">glm_weightit()</a></code> will produce standard errors that do not
account for estimation of the balancing weights. See an example below
for using <code>survey</code> to estimate effects after weighting.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="http://r-survey.r-forge.r-project.org/survey/" class="external-link">survey</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Multiply sampling weights and estimated weights</span></span>
<span><span class="va">d</span><span class="op">$</span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">W</span><span class="op">$</span><span class="va">weights</span> <span class="op">*</span> <span class="va">d</span><span class="op">$</span><span class="va">sw</span></span>
<span></span>
<span><span class="co">#Declare a survey design using the combined weights with</span></span>
<span><span class="co">#appropriate clustering</span></span>
<span><span class="va">des</span> <span class="op">&lt;-</span> <span class="fu">svydesign</span><span class="op">(</span><span class="op">~</span><span class="va">clu</span>, weights <span class="op">=</span> <span class="op">~</span><span class="va">weights</span>, data <span class="op">=</span> <span class="va">d</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Fit the outcome model</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">svyglm</span><span class="op">(</span><span class="va">Y_C</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                           <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>              design <span class="op">=</span> <span class="va">des</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#G-computation for the difference in means, including sampling weights</span></span>
<span><span class="fu"><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                wts <span class="op">=</span> <span class="va">d</span><span class="op">$</span><span class="va">sw</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="multi-category-treatments">Multi-Category Treatments<a class="anchor" aria-label="anchor" href="#multi-category-treatments"></a>
</h3>
<p>Multi-category treatments work essentially the same way as binary
treatments. The main practical differences are in choosing the estimand
and estimating the weights. The ATE and ATO are straightforward. The ATT
requires choosing one group to be the treated or “focal” group. Effects
are the estimated for members of that group. The contrast in the focal
group between the expected potential outcomes under a non-focal
treatment and the expected potential outcomes for the focal (actual)
treatment can be interpreted similarly to how ATTs are interpreted for
binary treatments. The contrasts in the focal group between expected
potential outcomes under a pair of non-focal treatments can be
interpreted as the contrast between the ATTs of the non-focal
treatments. Weights may be estimated differently for multi-category
treatments from binary treatments; see the individual methods pages for
how they differ.</p>
<p>Below, we’ll estimate the ATTs of the multi-category treatment
<code>Am</code> for a focal level.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">d</span><span class="op">$</span><span class="va">Am</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  C1  C2   T </span></span>
<span><span class="co">## 751 801 448</span></span></code></pre>
<p>We have a focal treatment group, <code>"T"</code>, and two control
groups <code>"C1"</code> and <code>"C2"</code>. We expect the ATTs for
the two control groups to be the same since we assigned them randomly
from within the original control group.</p>
<p>First, we estimate our weights using entropy balancing <span class="citation">(<a href="#ref-hainmuellerEntropyBalancingCausal2012">Hainmueller
2012</a>)</span>, identifying the focal group using
<code>focal</code>:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weightit.html">weightit</a></span><span class="op">(</span><span class="va">Am</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span>, data <span class="op">=</span> <span class="va">d</span>,</span>
<span>              method <span class="op">=</span> <span class="st">"ebal"</span>, estimand <span class="op">=</span> <span class="st">"ATT"</span>,</span>
<span>              focal <span class="op">=</span> <span class="st">"T"</span><span class="op">)</span></span>
<span><span class="va">W</span></span></code></pre></div>
<pre><code><span><span class="co">## A <span style="font-style: italic;">weightit</span> object</span></span>
<span><span class="co">##  - method: "ebal" (entropy balancing)</span></span>
<span><span class="co">##  - number of obs.: 2000</span></span>
<span><span class="co">##  - sampling weights: none</span></span>
<span><span class="co">##  - treatment: 3-category (C1, C2, T)</span></span>
<span><span class="co">##  - estimand: ATT (focal: T)</span></span>
<span><span class="co">##  - covariates: X1, X2, X3, X4, X5, X6, X7, X8, X9</span></span></code></pre>
<p>Typically one would assess the performance of the weights (balance
and effective sample size) but we will skip that for now. Next, we fit
the outcome model and perform weighted g-computation. We use
<code><a href="https://marginaleffects.com/man/predictions.html" class="external-link">avg_predictions()</a></code> first to compute the expected potential
outcome under each treatment for the focal group, and the use
<code><a href="https://marginaleffects.com/man/hypotheses.html" class="external-link">hypotheses()</a></code> to test all pairwise comparisons.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Fit the outcome model</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/glm_weightit.html">lm_weightit</a></span><span class="op">(</span><span class="va">Y_C</span> <span class="op">~</span> <span class="va">Am</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                                 <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>                   data <span class="op">=</span> <span class="va">d</span>, weightit <span class="op">=</span> <span class="va">W</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#G-computation</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://marginaleffects.com/man/predictions.html" class="external-link">avg_predictions</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                     variables <span class="op">=</span> <span class="st">"Am"</span>,</span>
<span>                     newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">Am</span> <span class="op">==</span> <span class="st">"T"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">p</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Am Estimate Std. Error     z Pr(&gt;|z|)     S 2.5 % 97.5 %</span></span>
<span><span class="co">##  C1     1.64      0.355  4.62   &lt;0.001  18.0 0.945   2.34</span></span>
<span><span class="co">##  C2     1.84      0.301  6.12   &lt;0.001  30.0 1.252   2.43</span></span>
<span><span class="co">##  T      3.75      0.217 17.27   &lt;0.001 219.7 3.324   4.17</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: Am, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </span></span>
<span><span class="co">## Type:  response</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://marginaleffects.com/man/hypotheses.html" class="external-link">hypotheses</a></span><span class="op">(</span><span class="va">p</span>, <span class="st">"revpairwise"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##     Term Estimate Std. Error     z Pr(&gt;|z|)    S  2.5 % 97.5 %</span></span>
<span><span class="co">##  C2 - C1     0.20      0.465 0.431    0.667  0.6 -0.712   1.11</span></span>
<span><span class="co">##  T - C1      2.11      0.416 5.064   &lt;0.001 21.2  1.292   2.92</span></span>
<span><span class="co">##  T - C2      1.91      0.371 5.144   &lt;0.001 21.8  1.181   2.63</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </span></span>
<span><span class="co">## Type:  response</span></span></code></pre>
<p>We find significant ATTs between the focal treatment and control
levels (<code>T - C1</code> and <code>T - C2</code>), but the difference
between control levels (<code>C2 - C1</code>), which can be interpreted
as the difference between these ATTs, is nonsignificant, as
expected.</p>
</div>
<div class="section level3">
<h3 id="continuous-treatments">Continuous Treatments<a class="anchor" aria-label="anchor" href="#continuous-treatments"></a>
</h3>
<p>For continuous treatments, one estimand of interest is the average
dose-response function (ADRF), which links the value of the treatment to
the expected potential outcome under that treatment value across the
full sample. We do not provide a detailed account of the ADRF but will
demonstrate how to estimate weights that balance covariates with respect
to a continuous treatment and how to estimate and plot the ADRF in the
weighted sample. We’ll use the continuous treatment <code>Ac</code>,
which ranges from -10.37 to 6.26, and estimate its effect on the
continuous outcome <code>Y_C</code>.</p>
<p>First, we’ll estimate entropy balancing weights <span class="citation">(<a href="#ref-vegetabileNonparametricEstimationPopulation2021">Vegetabile
et al. 2021</a>)</span> using <code><a href="../reference/weightit.html">weightit()</a></code>.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weightit.html">weightit</a></span><span class="op">(</span><span class="va">Ac</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span>, data <span class="op">=</span> <span class="va">d</span>,</span>
<span>              moments <span class="op">=</span> <span class="fl">2</span>, int <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>              method <span class="op">=</span> <span class="st">"ebal"</span><span class="op">)</span></span>
<span><span class="va">W</span></span></code></pre></div>
<pre><code><span><span class="co">## A <span style="font-style: italic;">weightit</span> object</span></span>
<span><span class="co">##  - method: "ebal" (entropy balancing)</span></span>
<span><span class="co">##  - number of obs.: 2000</span></span>
<span><span class="co">##  - sampling weights: none</span></span>
<span><span class="co">##  - treatment: continuous</span></span>
<span><span class="co">##  - covariates: X1, X2, X3, X4, X5, X6, X7, X8, X9</span></span></code></pre>
<p>Typically one would assess the performance of the weights (balance
and effective sample size) but we will skip that for now. Next, we fit
the outcome model and perform weighted g-computation. For the outcome
model, we will use a natural cubic spline on <code>Ac</code> with 4 df.
You can use any transformation of the treatment, e.g., a polynomial
transformation using <code><a href="https://rdrr.io/r/stats/poly.html" class="external-link">poly()</a></code>, as long as it is flexible
enough to capture any possible ADRF; purely nonparametric methods like
kernel regression can be used as well, but inference for them is more
challenging. Covariates can be included in the model, but with many
covariates, many basis functions for the treatment, and a full set of
treatment-covariate interactions, the resulting estimates may be
imprecise.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Fit the outcome model</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/glm_weightit.html">lm_weightit</a></span><span class="op">(</span><span class="va">Y_C</span> <span class="op">~</span> <span class="fu">splines</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/splines/ns.html" class="external-link">ns</a></span><span class="op">(</span><span class="va">Ac</span>, df <span class="op">=</span> <span class="fl">4</span><span class="op">)</span> <span class="op">*</span></span>
<span>                     <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                        <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span><span class="op">)</span>,</span>
<span>                   data <span class="op">=</span> <span class="va">d</span>, weightit <span class="op">=</span> <span class="va">W</span><span class="op">)</span></span></code></pre></div>
<p>Next we use <code><a href="https://marginaleffects.com/man/predictions.html" class="external-link">avg_predictions()</a></code> first to compute the
expected potential outcome under a representative set of treatment
values. We’ll examine 31 treatment values from the 10th to 90th
percentiles of <code>Ac</code> because estimates outside those ranges
tend to be imprecise.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Represenative values of Ac:</span></span>
<span><span class="va">values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">d</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Ac</span>, <span class="fl">.1</span><span class="op">)</span>,</span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">Ac</span>, <span class="fl">.9</span><span class="op">)</span>,</span>
<span>                      length.out <span class="op">=</span> <span class="fl">31</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#G-computation</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://marginaleffects.com/man/predictions.html" class="external-link">avg_predictions</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                     variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>Ac <span class="op">=</span> <span class="va">values</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Although one can examine the expected potential outcomes, it is often
more useful to see them plotted. We can generate a plot of the ADRF and
its pointwise confidence band using <code>ggplot2</code><a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;You can also use &lt;code&gt;&lt;a href="https://marginaleffects.com/man/plot_predictions.html" class="external-link"&gt;plot_predictions()&lt;/a&gt;&lt;/code&gt;, though
after requesting the predictions in the prior step it is quicker to use
&lt;code&gt;&lt;a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link"&gt;ggplot()&lt;/a&gt;&lt;/code&gt;.&lt;/p&gt;'><sup>4</sup></a>:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org" class="external-link">"ggplot2"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">p</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Ac</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>              alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Ac"</span>, y <span class="op">=</span> <span class="st">"E[Y|A]"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="estimating-effects_files/figure-html/unnamed-chunk-20-1.png" width="672"></p>
<p>We can see that the ADRF has an elbow-shape, with a zone of no
evidence of treatment effect followed by a zone of increasing values of
the outcome as the treatment increases.</p>
<p>Another way to characterize the effect of continuous treatments is to
examine the average marginal effect function (AMEF), which is a function
that relates the value of treatment to the derivative of the ADRF. When
this derivative is different from zero, there is evidence of a treatment
effect at the corresponding value of treatment. Below, we use
<code><a href="https://marginaleffects.com/man/slopes.html" class="external-link">avg_slopes()</a></code> to compute the pointwise derivatives of the
ADRF across levels of <code>Ac</code> and then plot it<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;You can also use &lt;code&gt;&lt;a href="https://marginaleffects.com/man/plot_slopes.html" class="external-link"&gt;plot_slopes()&lt;/a&gt;&lt;/code&gt;&lt;/p&gt;'><sup>5</sup></a>.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate the pointwise derivatives at representative</span></span>
<span><span class="co"># values of Ac</span></span>
<span><span class="va">s</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://marginaleffects.com/man/slopes.html" class="external-link">avg_slopes</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                variables <span class="op">=</span> <span class="st">"Ac"</span>,</span>
<span>                newdata <span class="op">=</span> <span class="fu"><a href="https://marginaleffects.com/man/datagrid.html" class="external-link">datagrid</a></span><span class="op">(</span>Ac <span class="op">=</span> <span class="va">values</span>,</span>
<span>                                   grid_type <span class="op">=</span> <span class="st">"counterfactual"</span><span class="op">)</span>,</span>
<span>                by <span class="op">=</span> <span class="st">"Ac"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot the AMEF</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">s</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Ac</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">conf.low</span>, ymax <span class="op">=</span> <span class="va">conf.high</span><span class="op">)</span>,</span>
<span>              alpha <span class="op">=</span> <span class="fl">.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">0</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Ac"</span>, y <span class="op">=</span> <span class="st">"dE[Y|A]/dA"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="estimating-effects_files/figure-html/unnamed-chunk-21-1.png" width="672"></p>
<p>We can see that between values of -1.8 and .5, there is evidence of a
positive effect of <code>Ac</code> on <code>Y_C</code> (i.e., because
the confidence intervals for the slope of the ADRF at those values of
<code>Ac</code> exclude 0). This is in line with our observation above
that the treatment only appears to have an effect at higher values of
<code>Ac</code>.</p>
</div>
<div class="section level3">
<h3 id="longitudinal-treatments">Longitudinal Treatments<a class="anchor" aria-label="anchor" href="#longitudinal-treatments"></a>
</h3>
<p>For longitudinal treatments, estimation proceeds as usual, except
that we estimate weights using <code><a href="../reference/weightitMSM.html">weightitMSM()</a></code> and fit a
weighted outcome model that includes treatment at all time periods (and,
optionally, and covariates measured prior to the first treatment). It is
important not to include any covariates possibly caused by any of the
treatments to avoid any bias; this is the whole point of using weighting
to estimate the marginal structural model in the first place.</p>
<p><code><a href="../reference/glm_weightit.html">glm_weightit()</a></code> makes it easy to incorporate the weights
and account for their estimation in computing the parameter variance
matrix, if desired. As with other methods, when the components required
for M-estimation are included in the <code><a href="../reference/weightitMSM.html">weightitMSM()</a></code> output,
they will be used to estimate standard errors that adjust for estimation
of the weights. Otherwise, the weights can be treated as fixed or the
whole estimation can be done through bootstrapping.</p>
<p>Below, we demonstrate using the usual inverse probability weights for
a marginal structural model. Because these weights are computed from
propensity scores estimated with logistic regression, we can use
M-estimation to adjust for their estimation in computing the parameter
covariance matrix. This also includes estimation of the standardization
factor, if any. We’ll use the toy dataset <code>msmdata</code> that
comes with <code>WeightIt</code>.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"msmdata"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Wmsm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weightitMSM.html">weightitMSM</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">A_1</span> <span class="op">~</span> <span class="va">X1_0</span> <span class="op">+</span> <span class="va">X2_0</span>,</span>
<span>                             <span class="va">A_2</span> <span class="op">~</span> <span class="va">X1_1</span> <span class="op">+</span> <span class="va">X2_1</span> <span class="op">+</span></span>
<span>                               <span class="va">A_1</span> <span class="op">+</span> <span class="va">X1_0</span> <span class="op">+</span> <span class="va">X2_0</span>,</span>
<span>                             <span class="va">A_3</span> <span class="op">~</span> <span class="va">X1_2</span> <span class="op">+</span> <span class="va">X2_2</span> <span class="op">+</span></span>
<span>                               <span class="va">A_2</span> <span class="op">+</span> <span class="va">X1_1</span> <span class="op">+</span> <span class="va">X2_1</span> <span class="op">+</span></span>
<span>                               <span class="va">A_1</span> <span class="op">+</span> <span class="va">X1_0</span> <span class="op">+</span> <span class="va">X2_0</span><span class="op">)</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">msmdata</span>, method <span class="op">=</span> <span class="st">"glm"</span>,</span>
<span>                        stabilize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Next we’ll fit the outcome model using <code><a href="../reference/glm_weightit.html">glm_weightit()</a></code>,
which includes the baseline covariates (i.e., only those measured prior
the first treatment).</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/glm_weightit.html">glm_weightit</a></span><span class="op">(</span><span class="va">Y_B</span> <span class="op">~</span> <span class="va">A_1</span> <span class="op">*</span> <span class="va">A_2</span> <span class="op">*</span> <span class="va">A_3</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1_0</span> <span class="op">+</span> <span class="va">X2_0</span><span class="op">)</span>,</span>
<span>                    data <span class="op">=</span> <span class="va">msmdata</span>, weightit <span class="op">=</span> <span class="va">Wmsm</span>,</span>
<span>                    family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span></code></pre></div>
<p>Then, we compute the average expected potential outcomes under each
treatment regime using
<code><a href="https://marginaleffects.com/man/predictions.html" class="external-link">marginaleffects::avg_predictions()</a></code>:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://marginaleffects.com/man/predictions.html" class="external-link">avg_predictions</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                      variables <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A_1"</span>, <span class="st">"A_2"</span>, <span class="st">"A_3"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  A_1 A_2 A_3 Estimate Std. Error    z Pr(&gt;|z|)     S 2.5 % 97.5 %</span></span>
<span><span class="co">##    0   0   0    0.687     0.0166 41.4   &lt;0.001   Inf 0.654  0.719</span></span>
<span><span class="co">##    0   0   1    0.521     0.0379 13.7   &lt;0.001 140.3 0.447  0.595</span></span>
<span><span class="co">##    0   1   0    0.491     0.0213 23.1   &lt;0.001 389.1 0.449  0.532</span></span>
<span><span class="co">##    0   1   1    0.438     0.0295 14.8   &lt;0.001 163.2 0.380  0.496</span></span>
<span><span class="co">##    1   0   0    0.602     0.0211 28.5   &lt;0.001 590.8 0.561  0.644</span></span>
<span><span class="co">##    1   0   1    0.544     0.0314 17.3   &lt;0.001 221.0 0.482  0.605</span></span>
<span><span class="co">##    1   1   0    0.378     0.0163 23.2   &lt;0.001 393.1 0.346  0.410</span></span>
<span><span class="co">##    1   1   1    0.422     0.0261 16.1   &lt;0.001 192.3 0.371  0.473</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: A_1, A_2, A_3, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </span></span>
<span><span class="co">## Type:  response</span></span></code></pre>
<p>We can compare individual predictions using
<code><a href="https://marginaleffects.com/man/hypotheses.html" class="external-link">marginaleffects::hypotheses()</a></code>. For example, to compare all
treatment histories to just the first treatment history (i.e., in which
all units are untreated for all time periods), we can run the
following:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://marginaleffects.com/man/hypotheses.html" class="external-link">hypotheses</a></span><span class="op">(</span><span class="va">p</span>, <span class="st">"reference"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##               Term Estimate Std. Error      z Pr(&gt;|z|)     S  2.5 %  97.5 %</span></span>
<span><span class="co">##  0, 0, 1 - 0, 0, 0  -0.1658     0.0414  -4.00  &lt; 0.001  14.0 -0.247 -0.0846</span></span>
<span><span class="co">##  0, 1, 0 - 0, 0, 0  -0.1960     0.0269  -7.29  &lt; 0.001  41.5 -0.249 -0.1433</span></span>
<span><span class="co">##  0, 1, 1 - 0, 0, 0  -0.2488     0.0337  -7.38  &lt; 0.001  42.6 -0.315 -0.1828</span></span>
<span><span class="co">##  1, 0, 0 - 0, 0, 0  -0.0842     0.0270  -3.12  0.00179   9.1 -0.137 -0.0314</span></span>
<span><span class="co">##  1, 0, 1 - 0, 0, 0  -0.1428     0.0356  -4.02  &lt; 0.001  14.0 -0.212 -0.0731</span></span>
<span><span class="co">##  1, 1, 0 - 0, 0, 0  -0.3083     0.0232 -13.30  &lt; 0.001 131.6 -0.354 -0.2629</span></span>
<span><span class="co">##  1, 1, 1 - 0, 0, 0  -0.2647     0.0308  -8.61  &lt; 0.001  56.9 -0.325 -0.2044</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </span></span>
<span><span class="co">## Type:  response</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="moderation-analysis">Moderation Analysis<a class="anchor" aria-label="anchor" href="#moderation-analysis"></a>
</h3>
<p>Moderation analysis involves determining whether a treatment effect
differs across levels of another variable. The use of weighting with
moderation analysis is described in <span class="citation">Griffin et
al. (<a href="#ref-griffinTutorialPropensityScore2023">2023</a>)</span>.
The goal is to achieve balance within each subgroup of the potential
moderating variable, and there are several ways of doing so. Broadly,
one can either perform weighting in the full dataset and interact the
moderator with the other covariates in the weighting model, or one can
perform completely separate analyses in each subgroup.</p>
<p>In some cases, e.g., when using unregularized parametric methods like
GLM propensity score weighting, CBPS, entropy balancing, or inverse
probability tilting, both methods yield identical results. To fit a
weighting model within each subgroup, one can use the <code>by</code>
argument to <code><a href="../reference/weightit.html">weightit()</a></code>, which does just this<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content="&lt;p&gt;Currently, when &lt;code&gt;by&lt;/code&gt; is used, M-estimation
based standard errors cannot be computed, but all methods compatible
with M-estimation yield identical results when using &lt;code&gt;by&lt;/code&gt;
vs. interacting the moderator with the other covariates in the weighting
model. Here, we demonstrate using &lt;code&gt;by&lt;/code&gt; because it is more
generalizable to other methods.&lt;/p&gt;"><sup>6</sup></a>. There is also the
possibility of using the subgroup balancing propensity score <span class="citation">(<a href="#ref-dongSubgroupBalancingPropensity2020">Dong et al.
2020</a>)</span> implemented using <code><a href="../reference/sbps.html">sbps()</a></code>, which determines
whether a single weighting model fit to the whole or a subgroup-specific
weighting model is best for each subgroup and overall. The chosen
approach should be that which achieves the best balance, though we don’t
demonstrate assessing balance here to maintain focus on effect
estimation.</p>
<p>We’ll consider the binary variable <code>X5</code> to be the
potential moderator of the effect of <code>A</code> on <code>Y_C</code>.
Below, we’ll estimate weights using CBPS for the ATE within each level
of <code>X5</code> by supplying it to the <code>by</code> argument.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Wm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weightit.html">weightit</a></span><span class="op">(</span><span class="va">A</span> <span class="op">~</span> <span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span> <span class="op">+</span> <span class="va">X4</span> <span class="op">+</span> <span class="va">X5</span> <span class="op">+</span> </span>
<span>                 <span class="va">X6</span> <span class="op">+</span> <span class="va">X7</span> <span class="op">+</span> <span class="va">X8</span> <span class="op">+</span> <span class="va">X9</span>, data <span class="op">=</span> <span class="va">d</span>,</span>
<span>               method <span class="op">=</span> <span class="st">"cbps"</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span>,</span>
<span>               by <span class="op">=</span> <span class="op">~</span><span class="va">X5</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Wm</span></span></code></pre></div>
<pre><code><span><span class="co">## A <span style="font-style: italic;">weightit</span> object</span></span>
<span><span class="co">##  - method: "cbps" (covariate balancing propensity score weighting)</span></span>
<span><span class="co">##  - number of obs.: 2000</span></span>
<span><span class="co">##  - sampling weights: none</span></span>
<span><span class="co">##  - treatment: 2-category</span></span>
<span><span class="co">##  - estimand: ATE</span></span>
<span><span class="co">##  - covariates: X1, X2, X3, X4, X5, X6, X7, X8, X9</span></span>
<span><span class="co">##  - by: X5</span></span></code></pre>
<p>Because we are using CBPS, equivalent weights could be estimated by
interacting <code>X5</code> with the other covariates, e.g.,
<code>A ~ X5 * (X1 + X2 + ...)</code>.</p>
<p>It is straightforward to check subgroup balance using
<code><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">cobalt::bal.tab()</a></code>, which has a <code>cluster</code>
argument that can be used to assess balance within subgroups, e.g., by
<code>cobalt::bal.tab(Wm, cluster = "X5")</code>. See
<code><a href="https://ngreifer.github.io/cobalt/articles/segmented-data.html" class="external-link">vignette("segmented-data", package = "cobalt")</a></code> for
details.</p>
<p>If we are satisfied with balance, we can then model the outcome with
an interaction between the treatment, the moderator, and, optionally,
the covariates. This is equivalent to fitting a model for the outcome
within each combination of the treatment and moderator, so it can be a
good idea to simplify this model to include just the most important
covariates to the outcome in order to avoid estimating too many
parameters. At a minimum, you must include an interaction between the
treatment and moderator. Here, we’ll fit a linear regression model
including the just the first three covariates in addition to the
treatment and moderator (allowing the covariates to interact with
both).</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/glm_weightit.html">lm_weightit</a></span><span class="op">(</span><span class="va">Y_C</span> <span class="op">~</span> <span class="va">A</span> <span class="op">*</span> <span class="va">X5</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1</span> <span class="op">+</span> <span class="va">X2</span> <span class="op">+</span> <span class="va">X3</span><span class="op">)</span>,</span>
<span>                    data <span class="op">=</span> <span class="va">d</span>, weightit <span class="op">=</span> <span class="va">Wm</span><span class="op">)</span></span></code></pre></div>
<p>To estimate the subgroup ATEs, we can use
<code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons()</a></code>, this time specifying the <code>by</code>
argument to signify that we want treatment effects stratified by the
moderator.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons</a></span><span class="op">(</span><span class="va">fit</span>, variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                by <span class="op">=</span> <span class="st">"X5"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  Term          Contrast X5 Estimate Std. Error    z Pr(&gt;|z|)    S 2.5 % 97.5 %</span></span>
<span><span class="co">##     A mean(1) - mean(0)  0     1.16      0.480 2.41   0.0159  6.0 0.217   2.10</span></span>
<span><span class="co">##     A mean(1) - mean(0)  1     2.38      0.454 5.24   &lt;0.001 22.5 1.487   3.27</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, X5, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high, predicted_lo, predicted_hi, predicted </span></span>
<span><span class="co">## Type:  response</span></span></code></pre>
<p>We can see that the subgroup mean differences differ from each other,
and we can formally test for moderation using another call to
<code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons()</a></code>, this time using the
<code>hypothesis</code> argument to signify that we want to compare
effects between subgroups:</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons</a></span><span class="op">(</span><span class="va">fit</span>, variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                by <span class="op">=</span> <span class="st">"X5"</span>,</span>
<span>                hypothesis <span class="op">=</span> <span class="st">"pairwise"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##   Term Estimate Std. Error     z Pr(&gt;|z|)   S 2.5 % 97.5 %</span></span>
<span><span class="co">##  0 - 1    -1.22       0.66 -1.85    0.065 3.9 -2.51 0.0759</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, estimate, std.error, statistic, p.value, s.value, conf.low, conf.high </span></span>
<span><span class="co">## Type:  response</span></span></code></pre>
<p>Though the subgroup effects differ from each other in the sample,
this difference is not statistically significant at the .05 level, so
there is no evidence of moderation by <code>X5</code>.</p>
<p>When the moderator has more than two levels, it is possible to run an
omnibus test for moderation by changing <code>hypothesis</code> to
<code>"reference"</code> and supplying the output to
<code><a href="https://marginaleffects.com/man/hypotheses.html" class="external-link">marginaleffects::hypotheses()</a></code> with
<code>joint = TRUE</code>, e.g.,</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons</a></span><span class="op">(</span><span class="va">fit</span>, variables <span class="op">=</span> <span class="st">"A"</span>,</span>
<span>                by <span class="op">=</span> <span class="st">"X5"</span>,</span>
<span>                hypothesis <span class="op">=</span> <span class="st">"reference"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://marginaleffects.com/man/hypotheses.html" class="external-link">hypotheses</a></span><span class="op">(</span>joint <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>This produces a single p-value for the test that all pairwise
differences between subgroups are equal to zero.</p>
<p>It is important to remember that the presence of moderation does not
imply that the moderator causes differences in the treatment effect; it
may simply be associated with a variable that interacts with the
treatment <span class="citation">(<a href="#ref-vanderweeleDistinctionInteractionEffect2009">VanderWeele
2009</a>)</span>. In addition, depending on which variables are adjusted
for and how, moderation may not necessarily represent a disparity, even
if one group experiences less benefit than another group <span class="citation">(<a href="#ref-jacksonMeaningfulCausalDecompositions2021">Jackson
2021</a>)</span>.</p>
</div>
</div>
<div class="section level2">
<h2 id="reporting-results">Reporting Results<a class="anchor" aria-label="anchor" href="#reporting-results"></a>
</h2>
<p>It is important to be as thorough and complete as possible when
describing the methods of estimating the treatment effect and the
results of the analysis. This improves transparency and replicability of
the analysis. Results should at least include the following:</p>
<ul>
<li>a description of the outcome model used (e.g., logistic regression,
a linear model with treatment-covariate interactions and covariates, a
Cox proportional hazards model with the propensity score weights
applied)</li>
<li>the way the effect was estimated (e.g., using g-computation or as
the coefficient in the outcome model)</li>
<li>the way SEs were estimated (e.g., using M-estimation, using robust
SEs that treat the weights as fixed, using the fractional weighted
bootstrap with 1000 bootstrap replications and the entire process of
weighting and effect estimation included in each replication)</li>
<li>R packages and functions used in estimating the effect and its SE
(e.g., <code><a href="../reference/glm_weightit.html">glm_weightit()</a></code> in <code>WeightIt</code>,
<code><a href="https://marginaleffects.com/man/comparisons.html" class="external-link">avg_comparisons()</a></code> in <code>marginaleffects</code>)</li>
<li>The effect and its SE and confidence interval</li>
</ul>
<p>All this is in addition to information about the weighting method,
estimand, propensity score estimation procedure (if used), balance
assessment, etc.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-austin2016" class="csl-entry">
Austin, Peter C. 2016. <span>“Variance Estimation When Using Inverse
Probability of Treatment Weighting (IPTW) with Survival
Analysis.”</span> <em>Statistics in Medicine</em> 35 (30): 5642–55. <a href="https://doi.org/10.1002/sim.7084" class="external-link">https://doi.org/10.1002/sim.7084</a>.
</div>
<div id="ref-austin2022" class="csl-entry">
———. 2022. <span>“Bootstrap Vs Asymptotic Variance Estimation When Using
Propensity Score Weighting with Continuous and Binary Outcomes.”</span>
<em>Statistics in Medicine</em> 41 (22): 4426–43. <a href="https://doi.org/10.1002/sim.9519" class="external-link">https://doi.org/10.1002/sim.9519</a>.
</div>
<div id="ref-chanGloballyEfficientNonparametric2016" class="csl-entry">
Chan, Kwun Chuen Gary, Sheung Chi Phillip Yam, and Zheng Zhang. 2016.
<span>“Globally Efficient Non-Parametric Inference of Average Treatment
Effects by Empirical Balancing Calibration Weighting.”</span>
<em>Journal of the Royal Statistical Society: Series B (Statistical
Methodology)</em> 78 (3): 673–700. <a href="https://doi.org/10.1111/rssb.12129" class="external-link">https://doi.org/10.1111/rssb.12129</a>.
</div>
<div id="ref-dongSubgroupBalancingPropensity2020" class="csl-entry">
Dong, Jing, Junni L Zhang, Shuxi Zeng, and Fan Li. 2020. <span>“Subgroup
Balancing Propensity Score.”</span> <em>Statistical Methods in Medical
Research</em> 29 (3): 659–76. <a href="https://doi.org/10.1177/0962280219870836" class="external-link">https://doi.org/10.1177/0962280219870836</a>.
</div>
<div id="ref-efronBootstrapMethodsStandard1986" class="csl-entry">
Efron, B., and R. Tibshirani. 1986. <span>“Bootstrap Methods for
Standard Errors, Confidence Intervals, and Other Measures of Statistical
Accuracy.”</span> <em>Statistical Science</em> 1 (1): 54–75. <a href="https://www.jstor.org/stable/2245500" class="external-link">https://www.jstor.org/stable/2245500</a>.
</div>
<div id="ref-gabrielInverseProbabilityTreatment2024" class="csl-entry">
Gabriel, Erin E., Michael C. Sachs, Torben Martinussen, Ingeborg
Waernbaum, Els Goetghebeur, Stijn Vansteelandt, and Arvid Sjölander.
2024. <span>“Inverse Probability of Treatment Weighting with Generalized
Linear Outcome Models for Doubly Robust Estimation.”</span>
<em>Statistics in Medicine</em> 43 (3): 534–47. <a href="https://doi.org/10.1002/sim.9969" class="external-link">https://doi.org/10.1002/sim.9969</a>.
</div>
<div id="ref-greiferChoosingEstimandWhen2021" class="csl-entry">
Greifer, Noah, and Elizabeth A. Stuart. 2021. <span>“Choosing the
Estimand When Matching or Weighting in Observational Studies.”</span>
<em>arXiv:2106.10577 [Stat]</em>, June. <a href="https://arxiv.org/abs/2106.10577" class="external-link">https://arxiv.org/abs/2106.10577</a>.
</div>
<div id="ref-griffinTutorialPropensityScore2023" class="csl-entry">
Griffin, Beth Ann, Megan S. Schuler, Matt Cefalu, Lynsay Ayer, Mark
Godley, Noah Greifer, Donna L. Coffman, and Daniel F. McCaffrey. 2023.
<span>“A Tutorial for Propensity Score Weighting for Moderation Analysis
With Categorical Variables: An Application Examining Smoking Disparities
Among Sexual Minority Adults.”</span> <em>Medical Care</em> 61 (12):
836–45. <a href="https://doi.org/10.1097/MLR.0000000000001922" class="external-link">https://doi.org/10.1097/MLR.0000000000001922</a>.
</div>
<div id="ref-hainmuellerEntropyBalancingCausal2012" class="csl-entry">
Hainmueller, J. 2012. <span>“Entropy Balancing for Causal Effects:
<span>A</span> Multivariate Reweighting Method to Produce Balanced
Samples in Observational Studies.”</span> <em>Political Analysis</em> 20
(1): 25–46. <a href="https://doi.org/10.1093/pan/mpr025" class="external-link">https://doi.org/10.1093/pan/mpr025</a>.
</div>
<div id="ref-hajage2018" class="csl-entry">
Hajage, David, Guillaume Chauvet, Lisa Belin, Alexandre Lafourcade,
Florence Tubach, and Yann De Rycke. 2018. <span>“Closed-Form Variance
Estimator for Weighted Propensity Score Estimators with Survival
Outcome.”</span> <em>Biometrical Journal</em> 60 (6): 1151–63. <a href="https://doi.org/10.1002/bimj.201700330" class="external-link">https://doi.org/10.1002/bimj.201700330</a>.
</div>
<div id="ref-hoMatchingNonparametricPreprocessing2007" class="csl-entry">
Ho, Daniel E., Kosuke Imai, Gary King, and Elizabeth A. Stuart. 2007.
<span>“Matching as Nonparametric Preprocessing for Reducing Model
Dependence in Parametric Causal Inference.”</span> <em>Political
Analysis</em> 15 (3): 199–236. <a href="https://doi.org/10.1093/pan/mpl013" class="external-link">https://doi.org/10.1093/pan/mpl013</a>.
</div>
<div id="ref-jacksonMeaningfulCausalDecompositions2021" class="csl-entry">
Jackson, John W. 2021. <span>“Meaningful Causal Decompositions in Health
Equity Research: Definition, Identification, and Estimation Through a
Weighting Framework.”</span> <em>Epidemiology</em> 32 (2): 282. <a href="https://doi.org/10.1097/EDE.0000000000001319" class="external-link">https://doi.org/10.1097/EDE.0000000000001319</a>.
</div>
<div id="ref-luncefordStratificationWeightingPropensity2004" class="csl-entry">
Lunceford, Jared K., and Marie Davidian. 2004. <span>“Stratification and
Weighting via the Propensity Score in Estimation of Causal Treatment
Effects: A Comparative Study.”</span> <em>Statistics in Medicine</em> 23
(19): 29372960. <a href="https://doi.org/10.1002/sim.1903" class="external-link">https://doi.org/10.1002/sim.1903</a>.
</div>
<div id="ref-mackinnonHeteroskedasticityconsistentCovarianceMatrix1985" class="csl-entry">
MacKinnon, James G, and Halbert White. 1985. <span>“Some
Heteroskedasticity-Consistent Covariance Matrix Estimators with Improved
Finite Sample Properties.”</span> <em>Journal of Econometrics</em> 29
(3): 305–25. <a href="https://doi.org/10.1016/0304-4076(85)90158-7" class="external-link">https://doi.org/10.1016/0304-4076(85)90158-7</a>.
</div>
<div id="ref-mao2018" class="csl-entry">
Mao, Huzhang, Liang Li, Wei Yang, and Yu Shen. 2018. <span>“On the
Propensity Score Weighting Analysis with Survival Outcome: Estimands,
Estimation, and Inference.”</span> <em>Statistics in Medicine</em> 37
(26): 3745–63. <a href="https://doi.org/10.1002/sim.7839" class="external-link">https://doi.org/10.1002/sim.7839</a>.
</div>
<div id="ref-nguyenDoubleadjustmentPropensityScore2017" class="csl-entry">
Nguyen, Tri-Long, Gary S. Collins, Jessica Spence, Jean-Pierre Daurès,
P. J. Devereaux, Paul Landais, and Yannick Le Manach. 2017.
<span>“Double-Adjustment in Propensity Score Matching Analysis: Choosing
a Threshold for Considering Residual Imbalance.”</span> <em>BMC Medical
Research Methodology</em> 17: 78. <a href="https://doi.org/10.1186/s12874-017-0338-0" class="external-link">https://doi.org/10.1186/s12874-017-0338-0</a>.
</div>
<div id="ref-reifeisVarianceTreatmentEffect2020" class="csl-entry">
Reifeis, Sarah A., and Michael G. Hudgens. 2020. <span>“On Variance of
the Treatment Effect in the Treated Using Inverse Probability
Weighting.”</span> <em>arXiv:2011.11874 [Stat]</em>, November. <a href="https://arxiv.org/abs/2011.11874" class="external-link">https://arxiv.org/abs/2011.11874</a>.
</div>
<div id="ref-robinsMarginalStructuralModels2000" class="csl-entry">
Robins, James M., Miguel Ángel Hernán, and Babette Brumback. 2000.
<span>“Marginal Structural Models and Causal Inference in
Epidemiology.”</span> <em>Epidemiology</em> 11 (5): 550–60. <a href="https://doi.org/10.1097/00001648-200009000-00011" class="external-link">https://doi.org/10.1097/00001648-200009000-00011</a>.
</div>
<div id="ref-rossMestimationCommonEpidemiological2024" class="csl-entry">
Ross, Rachael K, Paul N Zivich, Jeffrey S A Stringer, and Stephen R
Cole. 2024. <span>“M-Estimation for Common Epidemiological Measures:
Introduction and Applied Examples.”</span> <em>International Journal of
Epidemiology</em> 53 (2): dyae030. <a href="https://doi.org/10.1093/ije/dyae030" class="external-link">https://doi.org/10.1093/ije/dyae030</a>.
</div>
<div id="ref-schaferAverageCausalEffects2008" class="csl-entry">
Schafer, Joseph L., and Joseph Kang. 2008. <span>“Average Causal Effects
from Nonrandomized Studies: A Practical Guide and Simulated
Example.”</span> <em>Psychological Methods</em> 13 (4): 279–313. <a href="https://doi.org/10.1037/a0014268" class="external-link">https://doi.org/10.1037/a0014268</a>.
</div>
<div id="ref-snowdenImplementationGComputationSimulated2011" class="csl-entry">
Snowden, Jonathan M., Sherri Rose, and Kathleen M. Mortimer. 2011.
<span>“Implementation of G-Computation on a Simulated Data Set:
Demonstration of a Causal Inference Technique.”</span> <em>American
Journal of Epidemiology</em> 173 (7): 731–38. <a href="https://doi.org/10.1093/aje/kwq472" class="external-link">https://doi.org/10.1093/aje/kwq472</a>.
</div>
<div id="ref-stefanskiCalculusMEstimation2002" class="csl-entry">
Stefanski, Leonard A., and Dennis D. Boos. 2002. <span>“The Calculus of
m-Estimation.”</span> <em>The American Statistician</em> 56 (1): 29–38.
<a href="https://doi.org/10.1198/000313002753631330" class="external-link">https://doi.org/10.1198/000313002753631330</a>.
</div>
<div id="ref-vanderweeleDistinctionInteractionEffect2009" class="csl-entry">
VanderWeele, Tyler J. 2009. <span>“On the Distinction Between
Interaction and Effect Modification.”</span> <em>Epidemiology</em> 20
(6): 863–71. <a href="https://www.jstor.org/stable/25662776" class="external-link">https://www.jstor.org/stable/25662776</a>.
</div>
<div id="ref-vansteelandtInvitedCommentaryGComputation2011" class="csl-entry">
Vansteelandt, Stijn, and Niels Keiding. 2011. <span>“Invited Commentary:
G-Computation<span></span>lost in Translation?”</span> <em>American
Journal of Epidemiology</em> 173 (7): 739–42. <a href="https://doi.org/10.1093/aje/kwq474" class="external-link">https://doi.org/10.1093/aje/kwq474</a>.
</div>
<div id="ref-vegetabileNonparametricEstimationPopulation2021" class="csl-entry">
Vegetabile, Brian G., Beth Ann Griffin, Donna L. Coffman, Matthew
Cefalu, Michael W. Robbins, and Daniel F. McCaffrey. 2021.
<span>“Nonparametric Estimation of Population Average Dose-Response
Curves Using Entropy Balancing Weights for Continuous Exposures.”</span>
<em>Health Services and Outcomes Research Methodology</em> 21 (1):
69–110. <a href="https://doi.org/10.1007/s10742-020-00236-2" class="external-link">https://doi.org/10.1007/s10742-020-00236-2</a>.
</div>
<div id="ref-wangGcomputationAverageTreatment2017" class="csl-entry">
Wang, Aolin, Roch A. Nianogo, and Onyebuchi A. Arah. 2017.
<span>“G-Computation of Average Treatment Effects on the Treated and the
Untreated.”</span> <em>BMC Medical Research Methodology</em> 17 (1): 3.
<a href="https://doi.org/10.1186/s12874-016-0282-4" class="external-link">https://doi.org/10.1186/s12874-016-0282-4</a>.
</div>
<div id="ref-westreichTableFallacyPresenting2013" class="csl-entry">
Westreich, Daniel, and Sander Greenland. 2013. <span>“The Table 2
Fallacy: Presenting and Interpreting Confounder and Modifier
Coefficients.”</span> <em>American Journal of Epidemiology</em> 177 (4):
292–98. <a href="https://doi.org/10.1093/aje/kws412" class="external-link">https://doi.org/10.1093/aje/kws412</a>.
</div>
<div id="ref-xuApplicationsFractionalRandomWeightBootstrap2020a" class="csl-entry">
Xu, Li, Chris Gotwalt, Yili Hong, Caleb B. King, and William Q. Meeker.
2020. <span>“Applications of the Fractional-Random-Weight
Bootstrap.”</span> <em>The American Statistician</em> 74 (4): 345–58. <a href="https://doi.org/10.1080/00031305.2020.1731599" class="external-link">https://doi.org/10.1080/00031305.2020.1731599</a>.
</div>
</div>
</div>
<div class="section level2">
<h2 id="code-to-generate-data-used-in-examples">Code to Generate Data used in Examples<a class="anchor" aria-label="anchor" href="#code-to-generate-data-used-in-examples"></a>
</h2>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Generating data similar to Austin (2009) for demonstrating treatment effect estimation</span></span>
<span><span class="va">gen_X</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">9</span> <span class="op">*</span> <span class="va">n</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">n</span>, ncol <span class="op">=</span> <span class="fl">9</span><span class="op">)</span></span>
<span>  <span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">&lt;</span> <span class="fl">.5</span><span class="op">)</span></span>
<span>  <span class="va">X</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">gen_Ac</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">LP_A</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1.2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.4</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">7</span><span class="op">]</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">8</span><span class="op">]</span></span>
<span>  <span class="va">LP_A</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">rlogis</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">#~20% treated</span></span>
<span><span class="va">gen_A</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">Ac</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">1</span> <span class="op">*</span> <span class="op">(</span><span class="va">Ac</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">gen_Am</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">A</span> <span class="op">==</span> <span class="fl">1</span>, <span class="st">"T"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"C1"</span>, <span class="st">"C2"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Continuous outcome</span></span>
<span><span class="va">gen_Y_C</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fl">2</span><span class="op">*</span><span class="va">A</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">6</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, <span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#Conditional:</span></span>
<span><span class="co">#  MD: 2</span></span>
<span><span class="co">#Marginal:</span></span>
<span><span class="co">#  MD: 2</span></span>
<span></span>
<span><span class="co"># Binary outcome</span></span>
<span><span class="va">gen_Y_B</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">LP_B</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.4</span><span class="op">)</span><span class="op">*</span><span class="va">A</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.4</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">6</span><span class="op">]</span></span>
<span>  <span class="va">P_B</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Logistic.html" class="external-link">plogis</a></span><span class="op">(</span><span class="va">LP_B</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span>, <span class="fl">1</span>, <span class="va">P_B</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#Conditional:</span></span>
<span><span class="co">#  OR:   2.4</span></span>
<span><span class="co">#  logOR: .875</span></span>
<span><span class="co">#Marginal:</span></span>
<span><span class="co">#  RD:    .144</span></span>
<span><span class="co">#  RR:   1.54</span></span>
<span><span class="co">#  logRR: .433</span></span>
<span><span class="co">#  OR:   1.92</span></span>
<span><span class="co">#  logOR  .655</span></span>
<span></span>
<span><span class="co"># Survival outcome</span></span>
<span><span class="va">gen_Y_S</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">LP_S</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.4</span><span class="op">)</span><span class="op">*</span><span class="va">A</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">3</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">2.4</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">5</span><span class="op">]</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span><span class="op">)</span><span class="op">*</span><span class="va">X</span><span class="op">[</span>,<span class="fl">6</span><span class="op">]</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">A</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">*</span><span class="fl">2e4</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">LP_S</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co">#Conditional:</span></span>
<span><span class="co">#  HR:   2.4</span></span>
<span><span class="co">#  logHR: .875</span></span>
<span><span class="co">#Marginal:</span></span>
<span><span class="co">#  HR:   1.57</span></span>
<span><span class="co">#  logHR: .452</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">19599</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">2000</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu">gen_X</span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span><span class="va">Ac</span> <span class="op">&lt;-</span> <span class="fu">gen_Ac</span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">gen_A</span><span class="op">(</span><span class="va">Ac</span><span class="op">)</span></span>
<span><span class="va">Am</span> <span class="op">&lt;-</span> <span class="fu">gen_Am</span><span class="op">(</span><span class="va">A</span><span class="op">)</span></span>
<span></span>
<span><span class="va">Y_C</span> <span class="op">&lt;-</span> <span class="fu">gen_Y_C</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span></span>
<span><span class="va">Y_B</span> <span class="op">&lt;-</span> <span class="fu">gen_Y_B</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span></span>
<span><span class="va">Y_S</span> <span class="op">&lt;-</span> <span class="fu">gen_Y_S</span><span class="op">(</span><span class="va">A</span>, <span class="va">X</span><span class="op">)</span></span>
<span></span>
<span><span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">A</span>, <span class="va">Am</span>, <span class="va">Ac</span>, <span class="va">X</span>, <span class="va">Y_C</span>, <span class="va">Y_B</span>, <span class="va">Y_S</span><span class="op">)</span></span></code></pre></div>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Noah Greifer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
