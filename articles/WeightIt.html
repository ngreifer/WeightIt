<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="WeightIt">
<title>Using WeightIt to Estimate Balancing Weights • WeightIt</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using WeightIt to Estimate Balancing Weights">
<meta property="og:description" content="WeightIt">
<meta property="og:image" content="https://ngreifer.github.io/WeightIt/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">WeightIt</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.13.1.9010</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/WeightIt.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/estimating-effects.html">Estimating Effects After Weighting</a>
    <a class="dropdown-item" href="../articles/installing-packages.html">Installing Supporting Packages</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ngreifer/WeightIt/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Using WeightIt to Estimate Balancing Weights</h1>
                        <h4 data-toc-skip class="author">Noah
Greifer</h4>
            
            <h4 data-toc-skip class="date">2023-04-11</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/ngreifer/WeightIt/blob/HEAD/vignettes/WeightIt.Rmd" class="external-link"><code>vignettes/WeightIt.Rmd</code></a></small>
      <div class="d-none name"><code>WeightIt.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><code>WeightIt</code> contains several functions for estimating and
assessing balancing weights for observational studies. These weights can
be used to estimate the causal parameters of marginal structural models.
I will not go into the basics of causal inference methods here. For good
introductory articles, see <span class="citation">Austin (<a href="#ref-austinIntroductionPropensityScore2011" role="doc-biblioref">2011</a>)</span>, <span class="citation">Austin and
Stuart (<a href="#ref-austinMovingBestPractice2015" role="doc-biblioref">2015</a>)</span>, <span class="citation">Robins,
Hernán, and Brumback (<a href="#ref-robinsMarginalStructuralModels2000" role="doc-biblioref">2000</a>)</span>, or <span class="citation">Thoemmes and Ong (<a href="#ref-thoemmesPrimerInverseProbability2016" role="doc-biblioref">2016</a>)</span>.</p>
<p>Typically, the analysis of an observation study might proceed as
follows: identify the covariates for which balance is required; assess
the quality of the data available, including missingness and measurement
error; estimate weights that balance the covariates adequately; and
estimate a treatment effect and corresponding standard error or
confidence interval. This guide will go through all these steps for two
observational studies: estimating the causal effect of a point treatment
on an outcome, and estimating the causal parameters of a marginal
structural model with multiple treatment periods. This is not meant to
be a definitive guide, but rather an introduction to the relevant
issues.</p>
</div>
<div class="section level2">
<h2 id="balancing-weights-for-a-point-treatment">Balancing Weights for a Point Treatment<a class="anchor" aria-label="anchor" href="#balancing-weights-for-a-point-treatment"></a>
</h2>
<p>First we will use the Lalonde dataset to estimate the effect of a
point treatment. We’ll use the version of the data set that resides
within the <code>cobalt</code> package, which we will use later on as
well. Here, we are interested in the average treatment effect on the
treated (ATT).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ngreifer.github.io/cobalt/" class="external-link">"cobalt"</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  cobalt (Version 4.5.0, Build Date: 2023-03-21)</span></span></code></pre>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"lalonde"</span>, package <span class="op">=</span> <span class="st">"cobalt"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">lalonde</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   treat age educ   race married nodegree re74 re75    re78</span></span>
<span><span class="co">## 1     1  37   11  black       1        1    0    0  9930.0</span></span>
<span><span class="co">## 2     1  22    9 hispan       0        1    0    0  3595.9</span></span>
<span><span class="co">## 3     1  30   12  black       0        0    0    0 24909.5</span></span>
<span><span class="co">## 4     1  27   11  black       0        1    0    0  7506.1</span></span>
<span><span class="co">## 5     1  33    8  black       0        1    0    0   289.8</span></span>
<span><span class="co">## 6     1  22    9  black       0        1    0    0  4056.5</span></span></code></pre>
<p>We have our outcome (<code>re78</code>), our treatment
(<code>treat</code>), and the covariates for which balance is desired
(<code>age</code>, <code>educ</code>, <code>race</code>,
<code>married</code>, <code>nodegree</code>, <code>re74</code>, and
<code>re75</code>). Using <code>cobalt</code>, we can examine the
initial imbalance on the covariates:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>,</span>
<span>        data <span class="op">=</span> <span class="va">lalonde</span>, estimand <span class="op">=</span> <span class="st">"ATT"</span>, thresholds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fl">.05</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="text-decoration: underline;">Balance Measures</span></span></span>
<span><span class="co">##                Type Diff.Un      M.Threshold.Un</span></span>
<span><span class="co">## age         Contin.  -0.309 Not Balanced, &gt;0.05</span></span>
<span><span class="co">## educ        Contin.   0.055 Not Balanced, &gt;0.05</span></span>
<span><span class="co">## race_black   Binary   0.640 Not Balanced, &gt;0.05</span></span>
<span><span class="co">## race_hispan  Binary  -0.083 Not Balanced, &gt;0.05</span></span>
<span><span class="co">## race_white   Binary  -0.558 Not Balanced, &gt;0.05</span></span>
<span><span class="co">## married      Binary  -0.324 Not Balanced, &gt;0.05</span></span>
<span><span class="co">## nodegree     Binary   0.111 Not Balanced, &gt;0.05</span></span>
<span><span class="co">## re74        Contin.  -0.721 Not Balanced, &gt;0.05</span></span>
<span><span class="co">## re75        Contin.  -0.290 Not Balanced, &gt;0.05</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Balance tally for mean differences</span></span></span>
<span><span class="co">##                     count</span></span>
<span><span class="co">## Balanced, &lt;0.05         0</span></span>
<span><span class="co">## Not Balanced, &gt;0.05     9</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Variable with the greatest mean difference</span></span></span>
<span><span class="co">##  Variable Diff.Un      M.Threshold.Un</span></span>
<span><span class="co">##      re74  -0.721 Not Balanced, &gt;0.05</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Sample sizes</span></span></span>
<span><span class="co">##     Control Treated</span></span>
<span><span class="co">## All     429     185</span></span></code></pre>
<p>Based on this output, we can see that all variables are imbalanced in
the sense that the standardized mean differences (for continuous
variables) and differences in proportion (for binary variables) are
greater than .05 for all variables. In particular, <code>re74</code> and
<code>re75</code> are quite imbalanced, which is troubling given that
they are likely strong predictors of the outcome. We will estimate
weights using <code><a href="../reference/weightit.html">weightit()</a></code> to try to attain balance on these
covariates.</p>
<p>First, we’ll start simple, and use inverse probability weights from
propensity scores generated through logistic regression. We need to
supply <code><a href="../reference/weightit.html">weightit()</a></code> with the formula for the model, the data
set, the estimand (ATT), and the method of estimation
(<code>"glm"</code>) for generalized linear model propensity score
weights).</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ngreifer.github.io/WeightIt/">"WeightIt"</a></span><span class="op">)</span></span>
<span><span class="va">W.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weightit.html">weightit</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>,</span>
<span>                  data <span class="op">=</span> <span class="va">lalonde</span>, estimand <span class="op">=</span> <span class="st">"ATT"</span>, method <span class="op">=</span> <span class="st">"glm"</span><span class="op">)</span></span>
<span><span class="va">W.out</span> <span class="co">#print the output</span></span></code></pre></div>
<pre><code><span><span class="co">## A <span style="font-style: italic;">weightit</span> object</span></span>
<span><span class="co">##  - method: "glm" (propensity score weighting with GLM)</span></span>
<span><span class="co">##  - number of obs.: 614</span></span>
<span><span class="co">##  - sampling weights: none</span></span>
<span><span class="co">##  - treatment: 2-category</span></span>
<span><span class="co">##  - estimand: ATT (focal: 1)</span></span>
<span><span class="co">##  - covariates: age, educ, race, married, nodegree, re74, re75</span></span></code></pre>
<p>Printing the output of <code><a href="../reference/weightit.html">weightit()</a></code> displays a summary of
how the weights were estimated. Let’s examine the quality of the weights
using <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>. Weights with low variability are desirable
because they improve the precision of the estimator. This variability is
presented in several ways: by the ratio of the largest weight to the
smallest in each group, the coefficient of variation (standard deviation
divided by the mean) of the weights in each group, and the effective
sample size computed from the weights. We want a small ratio, a smaller
coefficient of variation, and a large effective sample size (ESS). What
constitutes these values is mostly relative, though, and must be
balanced with other constraints, including covariate balance. These
metrics are best used when comparing weighting methods, but the ESS can
give a sense of how much information remains in the weighted sample on a
familiar scale.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">W.out</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                  <span style="text-decoration: underline;">Summary of weights</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Weight ranges</span>:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            Min                                 Max</span></span>
<span><span class="co">## treated 1.0000         ||                    1.000</span></span>
<span><span class="co">## control 0.0092 |---------------------------| 3.743</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Units with the 5 most extreme weights by group</span>:</span></span>
<span><span class="co">##                                            </span></span>
<span><span class="co">##               6      5      3      2      1</span></span>
<span><span class="co">##  treated      1      1      1      1      1</span></span>
<span><span class="co">##             597    573    381    411    303</span></span>
<span><span class="co">##  control 3.0301 3.0592 3.2397 3.5231 3.7432</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Weight statistics</span>:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##         Coef of Var   MAD Entropy # Zeros</span></span>
<span><span class="co">## treated       0.000 0.000  -0.000       0</span></span>
<span><span class="co">## control       1.818 1.289   1.098       0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Effective Sample Sizes</span>:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unweighted  429.       185</span></span>
<span><span class="co">## Weighted     99.82     185</span></span></code></pre>
<p>These weights have quite high variability, and yield an ESS of close
to 100 in the control group. Let’s see if these weights managed to yield
balance on our covariates.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab</a></span><span class="op">(</span><span class="va">W.out</span>, stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"m"</span>, <span class="st">"v"</span><span class="op">)</span>, thresholds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fl">.05</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="text-decoration: underline;">Balance Measures</span></span></span>
<span><span class="co">##                 Type Diff.Adj         M.Threshold V.Ratio.Adj</span></span>
<span><span class="co">## prop.score  Distance   -0.021     Balanced, &lt;0.05       1.032</span></span>
<span><span class="co">## age          Contin.    0.119 Not Balanced, &gt;0.05       0.458</span></span>
<span><span class="co">## educ         Contin.   -0.028     Balanced, &lt;0.05       0.664</span></span>
<span><span class="co">## race_black    Binary   -0.002     Balanced, &lt;0.05           .</span></span>
<span><span class="co">## race_hispan   Binary    0.000     Balanced, &lt;0.05           .</span></span>
<span><span class="co">## race_white    Binary    0.002     Balanced, &lt;0.05           .</span></span>
<span><span class="co">## married       Binary    0.019     Balanced, &lt;0.05           .</span></span>
<span><span class="co">## nodegree      Binary    0.018     Balanced, &lt;0.05           .</span></span>
<span><span class="co">## re74         Contin.   -0.002     Balanced, &lt;0.05       1.321</span></span>
<span><span class="co">## re75         Contin.    0.011     Balanced, &lt;0.05       1.394</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Balance tally for mean differences</span></span></span>
<span><span class="co">##                     count</span></span>
<span><span class="co">## Balanced, &lt;0.05         9</span></span>
<span><span class="co">## Not Balanced, &gt;0.05     1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Variable with the greatest mean difference</span></span></span>
<span><span class="co">##  Variable Diff.Adj         M.Threshold</span></span>
<span><span class="co">##       age    0.119 Not Balanced, &gt;0.05</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Effective sample sizes</span></span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unadjusted  429.       185</span></span>
<span><span class="co">## Adjusted     99.82     185</span></span></code></pre>
<p>For nearly all the covariates, these weights yielded very good
balance. Only <code>age</code> remained imbalanced, with a standardized
mean difference greater than .05 and a variance ratio greater than 2.
Let’s see if we can do better. We’ll choose a different method: entropy
balancing <span class="citation">(<a href="#ref-hainmuellerEntropyBalancingCausal2012" role="doc-biblioref">Hainmueller 2012</a>)</span>, which guarantees
perfect balance on specified moments of the covariates while minimizing
the entropy (a measure of dispersion) of the weights.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">W.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weightit.html">weightit</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span> <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span>,</span>
<span>                  data <span class="op">=</span> <span class="va">lalonde</span>, estimand <span class="op">=</span> <span class="st">"ATT"</span>, method <span class="op">=</span> <span class="st">"ebal"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">W.out</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                  <span style="text-decoration: underline;">Summary of weights</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Weight ranges</span>:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            Min                                 Max</span></span>
<span><span class="co">## treated 1.0000    ||                         1.000</span></span>
<span><span class="co">## control 0.0188 |---------------------------| 9.419</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Units with the 5 most extreme weights by group</span>:</span></span>
<span><span class="co">##                                            </span></span>
<span><span class="co">##               5      4      3      2      1</span></span>
<span><span class="co">##  treated      1      1      1      1      1</span></span>
<span><span class="co">##             608    381    597    303    411</span></span>
<span><span class="co">##  control 7.1268 7.5013 7.9979 9.0355 9.4195</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Weight statistics</span>:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##         Coef of Var   MAD Entropy # Zeros</span></span>
<span><span class="co">## treated       0.000 0.000   0.000       0</span></span>
<span><span class="co">## control       1.834 1.287   1.101       0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Effective Sample Sizes</span>:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unweighted  429.       185</span></span>
<span><span class="co">## Weighted     98.46     185</span></span></code></pre>
<p>The variability of the weights has not changed much, but let’s see if
there are any gains in terms of balance:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab</a></span><span class="op">(</span><span class="va">W.out</span>, stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"m"</span>, <span class="st">"v"</span><span class="op">)</span>, thresholds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fl">.05</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="text-decoration: underline;">Balance Measures</span></span></span>
<span><span class="co">##                Type Diff.Adj     M.Threshold V.Ratio.Adj</span></span>
<span><span class="co">## age         Contin.        0 Balanced, &lt;0.05       0.410</span></span>
<span><span class="co">## educ        Contin.        0 Balanced, &lt;0.05       0.664</span></span>
<span><span class="co">## race_black   Binary        0 Balanced, &lt;0.05           .</span></span>
<span><span class="co">## race_hispan  Binary       -0 Balanced, &lt;0.05           .</span></span>
<span><span class="co">## race_white   Binary       -0 Balanced, &lt;0.05           .</span></span>
<span><span class="co">## married      Binary       -0 Balanced, &lt;0.05           .</span></span>
<span><span class="co">## nodegree     Binary       -0 Balanced, &lt;0.05           .</span></span>
<span><span class="co">## re74        Contin.       -0 Balanced, &lt;0.05       1.326</span></span>
<span><span class="co">## re75        Contin.       -0 Balanced, &lt;0.05       1.335</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Balance tally for mean differences</span></span></span>
<span><span class="co">##                     count</span></span>
<span><span class="co">## Balanced, &lt;0.05         9</span></span>
<span><span class="co">## Not Balanced, &gt;0.05     0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Variable with the greatest mean difference</span></span></span>
<span><span class="co">##  Variable Diff.Adj     M.Threshold</span></span>
<span><span class="co">##   married       -0 Balanced, &lt;0.05</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Effective sample sizes</span></span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unadjusted  429.       185</span></span>
<span><span class="co">## Adjusted     98.46     185</span></span></code></pre>
<p>Indeed, we have achieved perfect balance on the means of the
covariates. However, the variance ratio of <code>age</code> is still
quite high. We could continue to try to adjust for this imbalance, but
if there is reason to believe it is unlikely to affect the outcome, it
may be best to leave it as is. (You can try adding <code>I(age^2)</code>
to the formula and see what changes this causes.)</p>
<p>Now that we have our weights stored in <code>W.out</code>, let’s
extract them and estimate our treatment effect.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Attach weights to dataset</span></span>
<span><span class="va">lalonde</span><span class="op">$</span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">W.out</span><span class="op">$</span><span class="va">weights</span></span>
<span></span>
<span><span class="co"># Fit outcome model</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">re78</span> <span class="op">~</span> <span class="va">treat</span> <span class="op">*</span> <span class="op">(</span><span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">race</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span></span>
<span>                            <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span> <span class="op">+</span> <span class="va">re75</span><span class="op">)</span>,</span>
<span>          data <span class="op">=</span> <span class="va">lalonde</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># G-computation for the treatment effect</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://vincentarelbundock.github.io/marginaleffects/" class="external-link">"marginaleffects"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://vincentarelbundock.github.io/marginaleffects/reference/comparisons.html" class="external-link">avg_comparisons</a></span><span class="op">(</span><span class="va">fit</span>, variables <span class="op">=</span> <span class="st">"treat"</span>,</span>
<span>                vcov <span class="op">=</span> <span class="st">"HC3"</span>,</span>
<span>                newdata <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">lalonde</span>, <span class="va">treat</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                wts <span class="op">=</span> <span class="st">"weights"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##   Term Contrast Estimate Std. Error    z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">##  treat    1 - 0     1273        823 1.55    0.122  -339   2886</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, contrast, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre>
<p>Our confidence interval for <code>treat</code> contains 0, so there
isn’t evidence that <code>treat</code> has an effect on
<code>re78</code>. Although some authors recommend using “robust”
sandwich standard errors to adjust for the weights <span class="citation">(<a href="#ref-robinsMarginalStructuralModels2000" role="doc-biblioref">Robins, Hernán, and Brumback 2000</a>; <a href="#ref-hainmuellerEntropyBalancingCausal2012" role="doc-biblioref">Hainmueller 2012</a>)</span> as we did above,
others believe these can misleading and recommend bootstrapping instead
<span class="citation">(<a href="#ref-reifeisVarianceTreatmentEffect2020" role="doc-biblioref">Reifeis and Hudgens 2020</a>; <a href="#ref-chanGloballyEfficientNonparametric2016" role="doc-biblioref">Chan, Yam, and Zhang 2016</a>)</span>. Both methods
are described in detail at
<code><a href="../articles/estimating-effects.html">vignette("estimating-effects")</a></code>.</p>
</div>
<div class="section level2">
<h2 id="balancing-weights-for-a-longitudinal-treatment">Balancing Weights for a Longitudinal Treatment<a class="anchor" aria-label="anchor" href="#balancing-weights-for-a-longitudinal-treatment"></a>
</h2>
<p><code>WeightIt</code> can estimate weights for longitudinal treatment
marginal structural models as well. This time, we’ll use the sample data
set <code>msmdata</code> to estimate our weights. Data must be in “wide”
format, with one row per unit.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"msmdata"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">msmdata</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##   X1_0 X2_0 A_1 X1_1 X2_1 A_2 X1_2 X2_2 A_3 Y_B</span></span>
<span><span class="co">## 1    2    0   1    5    1   0    4    1   0   0</span></span>
<span><span class="co">## 2    4    0   1    9    0   1   10    0   1   1</span></span>
<span><span class="co">## 3    4    1   0    5    0   1    4    0   0   1</span></span>
<span><span class="co">## 4    4    1   0    4    0   0    6    1   0   1</span></span>
<span><span class="co">## 5    6    1   1    5    0   1    6    0   0   1</span></span>
<span><span class="co">## 6    5    1   0    4    0   1    4    0   1   0</span></span></code></pre>
<p>We have a binary outcome variable (<code>Y_B</code>), pre-treatment
time-varying variables (<code>X1_0</code> and <code>X2_0</code>,
measured before the first treatment, <code>X1_1</code> and
<code>X2_1</code> measured between the first and second treatments, and
<code>X1_2</code> and <code>X2_2</code> measured between the second and
third treatments), and three time-varying binary treatment variables
(<code>A_1</code>, <code>A_2</code>, and <code>A_3</code>). We are
interested in the joint, unique, causal effects of each treatment period
on the outcome. At each treatment time point, we need to achieve balance
on all variables measured prior to that treatment, including previous
treatments.</p>
<p>Using <code>cobalt</code>, we can examine the initial imbalance at
each time point and overall:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ngreifer.github.io/cobalt/" class="external-link">"cobalt"</a></span><span class="op">)</span> <span class="co">#if not already attached</span></span>
<span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">A_1</span> <span class="op">~</span> <span class="va">X1_0</span> <span class="op">+</span> <span class="va">X2_0</span>,</span>
<span>             <span class="va">A_2</span> <span class="op">~</span> <span class="va">X1_1</span> <span class="op">+</span> <span class="va">X2_1</span> <span class="op">+</span></span>
<span>               <span class="va">A_1</span> <span class="op">+</span> <span class="va">X1_0</span> <span class="op">+</span> <span class="va">X2_0</span>,</span>
<span>             <span class="va">A_3</span> <span class="op">~</span> <span class="va">X1_2</span> <span class="op">+</span> <span class="va">X2_2</span> <span class="op">+</span></span>
<span>               <span class="va">A_2</span> <span class="op">+</span> <span class="va">X1_1</span> <span class="op">+</span> <span class="va">X2_1</span> <span class="op">+</span></span>
<span>               <span class="va">A_1</span> <span class="op">+</span> <span class="va">X1_0</span> <span class="op">+</span> <span class="va">X2_0</span><span class="op">)</span>,</span>
<span>        data <span class="op">=</span> <span class="va">msmdata</span>, stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"m"</span>, <span class="st">"ks"</span><span class="op">)</span>,</span>
<span>        which.time <span class="op">=</span> <span class="va">.all</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="text-decoration: underline;">Balance by Time Point</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  - - - <span style="font-style: italic;">Time: 1</span> - - - </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Balance Measures</span></span></span>
<span><span class="co">##         Type Diff.Un KS.Un</span></span>
<span><span class="co">## X1_0 Contin.   0.690 0.276</span></span>
<span><span class="co">## X2_0  Binary  -0.325 0.325</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Sample sizes</span></span></span>
<span><span class="co">##     Control Treated</span></span>
<span><span class="co">## All    3306    4194</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  - - - <span style="font-style: italic;">Time: 2</span> - - - </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Balance Measures</span></span></span>
<span><span class="co">##         Type Diff.Un KS.Un</span></span>
<span><span class="co">## X1_1 Contin.   0.874 0.340</span></span>
<span><span class="co">## X2_1  Binary  -0.299 0.299</span></span>
<span><span class="co">## A_1   Binary   0.127 0.127</span></span>
<span><span class="co">## X1_0 Contin.   0.528 0.201</span></span>
<span><span class="co">## X2_0  Binary  -0.060 0.060</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Sample sizes</span></span></span>
<span><span class="co">##     Control Treated</span></span>
<span><span class="co">## All    3701    3799</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##  - - - <span style="font-style: italic;">Time: 3</span> - - - </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Balance Measures</span></span></span>
<span><span class="co">##         Type Diff.Un KS.Un</span></span>
<span><span class="co">## X1_2 Contin.   0.475 0.212</span></span>
<span><span class="co">## X2_2  Binary  -0.594 0.594</span></span>
<span><span class="co">## A_2   Binary   0.162 0.162</span></span>
<span><span class="co">## X1_1 Contin.   0.573 0.237</span></span>
<span><span class="co">## X2_1  Binary  -0.040 0.040</span></span>
<span><span class="co">## A_1   Binary   0.100 0.100</span></span>
<span><span class="co">## X1_0 Contin.   0.361 0.148</span></span>
<span><span class="co">## X2_0  Binary  -0.040 0.040</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Sample sizes</span></span></span>
<span><span class="co">##     Control Treated</span></span>
<span><span class="co">## All    4886    2614</span></span>
<span><span class="co">##  - - - - - - - - - - -</span></span></code></pre>
<p><code><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab()</a></code> indicates significant imbalance on most
covariates at most time points, so we need to do some work to eliminate
that imbalance in our weighted data set. We’ll use the
<code><a href="../reference/weightitMSM.html">weightitMSM()</a></code> function to specify our weight models. The
syntax is similar both to that of <code><a href="../reference/weightit.html">weightit()</a></code> for point
treatments and to that of <code><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab()</a></code> for longitudinal
treatments. We’ll use <code>method = "glm"</code> and
<code>stabilize = TRUE</code> for stabilized propensity score weights
estimated using logistic regression.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">Wmsm.out</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/weightitMSM.html">weightitMSM</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">A_1</span> <span class="op">~</span> <span class="va">X1_0</span> <span class="op">+</span> <span class="va">X2_0</span>,</span>
<span>                             <span class="va">A_2</span> <span class="op">~</span> <span class="va">X1_1</span> <span class="op">+</span> <span class="va">X2_1</span> <span class="op">+</span></span>
<span>                               <span class="va">A_1</span> <span class="op">+</span> <span class="va">X1_0</span> <span class="op">+</span> <span class="va">X2_0</span>,</span>
<span>                             <span class="va">A_3</span> <span class="op">~</span> <span class="va">X1_2</span> <span class="op">+</span> <span class="va">X2_2</span> <span class="op">+</span></span>
<span>                               <span class="va">A_2</span> <span class="op">+</span> <span class="va">X1_1</span> <span class="op">+</span> <span class="va">X2_1</span> <span class="op">+</span></span>
<span>                               <span class="va">A_1</span> <span class="op">+</span> <span class="va">X1_0</span> <span class="op">+</span> <span class="va">X2_0</span><span class="op">)</span>,</span>
<span>                        data <span class="op">=</span> <span class="va">msmdata</span>, method <span class="op">=</span> <span class="st">"glm"</span>,</span>
<span>                        stabilize <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">Wmsm.out</span></span></code></pre></div>
<pre><code><span><span class="co">## A <span style="font-style: italic;">weightitMSM</span> object</span></span>
<span><span class="co">##  - method: "glm" (propensity score weighting with GLM)</span></span>
<span><span class="co">##  - number of obs.: 7500</span></span>
<span><span class="co">##  - sampling weights: none</span></span>
<span><span class="co">##  - number of time points: 3 (A_1, A_2, A_3)</span></span>
<span><span class="co">##  - treatment: </span></span>
<span><span class="co">##     + time 1: 2-category</span></span>
<span><span class="co">##     + time 2: 2-category</span></span>
<span><span class="co">##     + time 3: 2-category</span></span>
<span><span class="co">##  - covariates: </span></span>
<span><span class="co">##     + baseline: X1_0, X2_0</span></span>
<span><span class="co">##     + after time 1: X1_1, X2_1, A_1, X1_0, X2_0</span></span>
<span><span class="co">##     + after time 2: X1_2, X2_2, A_2, X1_1, X2_1, A_1, X1_0, X2_0</span></span>
<span><span class="co">##  - stabilized; stabilization factors:</span></span>
<span><span class="co">##     + baseline: (none)</span></span>
<span><span class="co">##     + after time 1: A_1</span></span>
<span><span class="co">##     + after time 2: A_1, A_2, A_1:A_2</span></span></code></pre>
<p>No matter which method is selected, <code><a href="../reference/weightitMSM.html">weightitMSM()</a></code>
estimates separate weights for each time period and then takes the
product of the weights for each individual to arrive at the final
estimated weights. Printing the output of <code><a href="../reference/weightitMSM.html">weightitMSM()</a></code>
provides some details about the function call and the output. We can
take a look at the quality of the weights with <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>,
just as we could for point treatments.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">Wmsm.out</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                  <span style="text-decoration: underline;">Summary of weights</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: line-through;">                      </span><span style="font-style: italic;"> Time 1 </span><span style="text-decoration: line-through;">                      </span></span></span>
<span><span class="co">##                  <span style="text-decoration: underline;">Summary of weights</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Weight ranges</span>:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            Min                                 Max</span></span>
<span><span class="co">## treated 0.1527 |---------------------------| 57.08</span></span>
<span><span class="co">## control 0.1089 |--------|                    20.46</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Units with the 5 most extreme weights by group</span>:</span></span>
<span><span class="co">##                                                </span></span>
<span><span class="co">##             4390    3440    3774   3593    5685</span></span>
<span><span class="co">##  treated 22.1008 24.1278 25.6999 27.786 57.0794</span></span>
<span><span class="co">##             6659    6284    1875   6163    2533</span></span>
<span><span class="co">##  control 12.8943   13.09 14.5234 14.705  20.465</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Weight statistics</span>:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##         Coef of Var   MAD Entropy # Zeros</span></span>
<span><span class="co">## treated       1.779 0.775   0.573       0</span></span>
<span><span class="co">## control       1.331 0.752   0.486       0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Mean of Weights</span> = 0.99</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Effective Sample Sizes</span>:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unweighted    3306    4194</span></span>
<span><span class="co">## Weighted      1193    1007</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: line-through;">                      </span><span style="font-style: italic;"> Time 2 </span><span style="text-decoration: line-through;">                      </span></span></span>
<span><span class="co">##                  <span style="text-decoration: underline;">Summary of weights</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Weight ranges</span>:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            Min                                 Max</span></span>
<span><span class="co">## treated 0.1089 |---------------------------| 57.08</span></span>
<span><span class="co">## control 0.1501 |--------|                    20.49</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Units with the 5 most extreme weights by group</span>:</span></span>
<span><span class="co">##                                                 </span></span>
<span><span class="co">##             4390    3440    3774    3593    5685</span></span>
<span><span class="co">##  treated 22.1008 24.1278 25.6999  27.786 57.0794</span></span>
<span><span class="co">##             1875    6163    6862    1286    6158</span></span>
<span><span class="co">##  control 14.5234  14.705 14.8079 16.2311 20.4862</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Weight statistics</span>:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##         Coef of Var   MAD Entropy # Zeros</span></span>
<span><span class="co">## treated       1.797 0.779   0.580       0</span></span>
<span><span class="co">## control       1.359 0.750   0.488       0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Mean of Weights</span> = 0.99</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Effective Sample Sizes</span>:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unweighted    3701  3799. </span></span>
<span><span class="co">## Weighted      1300   898.2</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: line-through;">                      </span><span style="font-style: italic;"> Time 3 </span><span style="text-decoration: line-through;">                      </span></span></span>
<span><span class="co">##                  <span style="text-decoration: underline;">Summary of weights</span></span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Weight ranges</span>:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            Min                                 Max</span></span>
<span><span class="co">## treated 0.1089 |---------------------------| 57.08</span></span>
<span><span class="co">## control 0.2085 |-----------|                 25.70</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Units with the 5 most extreme weights by group</span>:</span></span>
<span><span class="co">##                                                 </span></span>
<span><span class="co">##             3576    4390    3440    3593    5685</span></span>
<span><span class="co">##  treated 20.5828 22.1008 24.1278  27.786 57.0794</span></span>
<span><span class="co">##             6163    6862     168    6158    3774</span></span>
<span><span class="co">##  control  14.705 14.8079 16.9698 20.4862 25.6999</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Weight statistics</span>:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##         Coef of Var   MAD Entropy # Zeros</span></span>
<span><span class="co">## treated       2.008 0.931   0.753       0</span></span>
<span><span class="co">## control       1.269 0.672   0.407       0</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Mean of Weights</span> = 0.99</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## - <span style="font-style: italic;">Effective Sample Sizes</span>:</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unweighted    4886  2614. </span></span>
<span><span class="co">## Weighted      1871   519.8</span></span></code></pre>
<p>Displayed are summaries of how the weights perform at each time point
with respect to variability. Next, we’ll examine how well they perform
with respect to covariate balance.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab</a></span><span class="op">(</span><span class="va">Wmsm.out</span>, stats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"m"</span>, <span class="st">"ks"</span><span class="op">)</span>, which.time <span class="op">=</span> <span class="va">.none</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## <span style="text-decoration: underline;">Balance summary across all time points</span></span></span>
<span><span class="co">##              Times     Type Max.Diff.Adj Max.KS.Adj</span></span>
<span><span class="co">## prop.score 1, 2, 3 Distance        0.095      0.074</span></span>
<span><span class="co">## X1_0       1, 2, 3  Contin.        0.033      0.018</span></span>
<span><span class="co">## X2_0       1, 2, 3   Binary        0.018      0.018</span></span>
<span><span class="co">## X1_1          2, 3  Contin.        0.087      0.039</span></span>
<span><span class="co">## X2_1          2, 3   Binary        0.031      0.031</span></span>
<span><span class="co">## A_1           2, 3   Binary        0.130      0.130</span></span>
<span><span class="co">## X1_2             3  Contin.        0.104      0.054</span></span>
<span><span class="co">## X2_2             3   Binary        0.007      0.007</span></span>
<span><span class="co">## A_2              3   Binary        0.154      0.154</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## <span style="text-decoration: underline;">Effective sample sizes</span></span></span>
<span><span class="co">##  - <span style="font-style: italic;">Time 1</span></span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unadjusted    3306    4194</span></span>
<span><span class="co">## Adjusted      1193    1007</span></span>
<span><span class="co">##  - <span style="font-style: italic;">Time 2</span></span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unadjusted    3701  3799. </span></span>
<span><span class="co">## Adjusted      1300   898.2</span></span>
<span><span class="co">##  - <span style="font-style: italic;">Time 3</span></span></span>
<span><span class="co">##            Control Treated</span></span>
<span><span class="co">## Unadjusted    4886  2614. </span></span>
<span><span class="co">## Adjusted      1871   519.8</span></span></code></pre>
<p>By setting <code>which.time = .none</code> in <code><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab()</a></code>,
we can focus on the overall balance assessment, which displays the
greatest imbalance for each covariate across time points. We can see
that our estimated weights balance all covariates all time points with
respect to means and KS statistics. Now we can estimate our treatment
effects.</p>
<p>First, we fit a marginal structural model for the outcome using
<code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code> with the weights included:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Attach weights to dataset</span></span>
<span><span class="va">msmdata</span><span class="op">$</span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">Wmsm.out</span><span class="op">$</span><span class="va">weights</span></span>
<span></span>
<span><span class="co"># Fit outcome model</span></span>
<span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">Y_B</span> <span class="op">~</span> <span class="va">A_1</span> <span class="op">*</span> <span class="va">A_2</span> <span class="op">*</span> <span class="va">A_3</span> <span class="op">*</span> <span class="op">(</span><span class="va">X1_0</span> <span class="op">+</span> <span class="va">X2_0</span><span class="op">)</span>,</span>
<span>           data <span class="op">=</span> <span class="va">msmdata</span>, weights <span class="op">=</span> <span class="va">weights</span>,</span>
<span>           family <span class="op">=</span> <span class="va">quasibinomial</span><span class="op">)</span></span></code></pre></div>
<p>Then, we compute the average expected potential outcomes under each
treatment regime using
<code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">marginaleffects::avg_predictions()</a></code>:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://vincentarelbundock.github.io/marginaleffects/" class="external-link">"marginaleffects"</a></span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">avg_predictions</a></span><span class="op">(</span><span class="va">fit</span>,</span>
<span>                      vcov <span class="op">=</span> <span class="st">"HC3"</span>,</span>
<span>                      newdata <span class="op">=</span> <span class="fu"><a href="https://vincentarelbundock.github.io/marginaleffects/reference/datagrid.html" class="external-link">datagridcf</a></span><span class="op">(</span>A_1 <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, A_2 <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span>, A_3 <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                      by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A_1"</span>, <span class="st">"A_2"</span>, <span class="st">"A_3"</span><span class="op">)</span>,</span>
<span>                      wts <span class="op">=</span> <span class="st">"weights"</span>,</span>
<span>                      type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  A_1 A_2 A_3 Estimate Std. Error    z Pr(&gt;|z|) 2.5 % 97.5 %</span></span>
<span><span class="co">##    0   0   0    0.685     0.0169 40.6   &lt;0.001 0.652  0.718</span></span>
<span><span class="co">##    0   0   1    0.518     0.0398 13.0   &lt;0.001 0.440  0.596</span></span>
<span><span class="co">##    0   1   0    0.488     0.0217 22.5   &lt;0.001 0.446  0.531</span></span>
<span><span class="co">##    0   1   1    0.434     0.0309 14.1   &lt;0.001 0.373  0.494</span></span>
<span><span class="co">##    1   0   0    0.600     0.0218 27.6   &lt;0.001 0.558  0.643</span></span>
<span><span class="co">##    1   0   1    0.541     0.0334 16.2   &lt;0.001 0.475  0.606</span></span>
<span><span class="co">##    1   1   0    0.375     0.0170 22.0   &lt;0.001 0.342  0.409</span></span>
<span><span class="co">##    1   1   1    0.419     0.0285 14.7   &lt;0.001 0.363  0.475</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: A_1, A_2, A_3, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre>
<p>We can compare the expected potential outcomes under each regime
using <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/hypotheses.html" class="external-link">marginaleffects::hypotheses()</a></code>. To get all pairwise
comparisons, supply the <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">avg_predictions()</a></code> output to
<code>hypotheses(., "pairwise")</code>. To compare individual regimes,
we can use <code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/hypotheses.html" class="external-link">hypotheses()</a></code>, identifying the rows of the
<code><a href="https://vincentarelbundock.github.io/marginaleffects/reference/predictions.html" class="external-link">avg_predictions()</a></code> output. For example, to compare the
regimes with no treatment for all three time points vs. the regime with
treatment for all three time points, we would run</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://vincentarelbundock.github.io/marginaleffects/reference/hypotheses.html" class="external-link">hypotheses</a></span><span class="op">(</span><span class="va">p</span>, <span class="st">"b8 - b1 = 0"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##     Term Estimate Std. Error     z Pr(&gt;|z|)  2.5 % 97.5 %</span></span>
<span><span class="co">##  b8-b1=0   -0.266     0.0182 -14.6   &lt;0.001 -0.301  -0.23</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Columns: term, estimate, std.error, statistic, p.value, conf.low, conf.high</span></span></code></pre>
<p>These results indicate that receive treatment at all time points
reduces the risk of the outcome relative to not receiving treatment at
all.</p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-austinIntroductionPropensityScore2011" class="csl-entry">
Austin, Peter C. 2011. <span>“An Introduction to Propensity Score
Methods for Reducing the Effects of Confounding in Observational
Studies.”</span> <em>Multivariate Behavioral Research</em> 46 (3):
399–424. <a href="https://doi.org/10.1080/00273171.2011.568786" class="external-link">https://doi.org/10.1080/00273171.2011.568786</a>.
</div>
<div id="ref-austinMovingBestPractice2015" class="csl-entry">
Austin, Peter C., and Elizabeth A. Stuart. 2015. <span>“Moving Towards
Best Practice When Using Inverse Probability of Treatment Weighting
(<span>IPTW</span>) Using the Propensity Score to Estimate Causal
Treatment Effects in Observational Studies.”</span> <em>Statistics in
Medicine</em> 34 (28): 3661–79. <a href="https://doi.org/10.1002/sim.6607" class="external-link">https://doi.org/10.1002/sim.6607</a>.
</div>
<div id="ref-chanGloballyEfficientNonparametric2016" class="csl-entry">
Chan, Kwun Chuen Gary, Sheung Chi Phillip Yam, and Zheng Zhang. 2016.
<span>“Globally Efficient Non-Parametric Inference of Average Treatment
Effects by Empirical Balancing Calibration Weighting.”</span>
<em>Journal of the Royal Statistical Society: Series B (Statistical
Methodology)</em> 78 (3): 673–700. <a href="https://doi.org/10.1111/rssb.12129" class="external-link">https://doi.org/10.1111/rssb.12129</a>.
</div>
<div id="ref-hainmuellerEntropyBalancingCausal2012" class="csl-entry">
Hainmueller, J. 2012. <span>“Entropy Balancing for Causal Effects:
<span>A</span> Multivariate Reweighting Method to Produce Balanced
Samples in Observational Studies.”</span> <em>Political Analysis</em> 20
(1): 25–46. <a href="https://doi.org/10.1093/pan/mpr025" class="external-link">https://doi.org/10.1093/pan/mpr025</a>.
</div>
<div id="ref-reifeisVarianceTreatmentEffect2020" class="csl-entry">
Reifeis, Sarah A., and Michael G. Hudgens. 2020. <span>“On Variance of
the Treatment Effect in the Treated Using Inverse Probability
Weighting.”</span> <em>arXiv:2011.11874 [Stat]</em>, November. <a href="https://arxiv.org/abs/2011.11874" class="external-link">https://arxiv.org/abs/2011.11874</a>.
</div>
<div id="ref-robinsMarginalStructuralModels2000" class="csl-entry">
Robins, James M., Miguel Ángel Hernán, and Babette Brumback. 2000.
<span>“Marginal Structural Models and Causal Inference in
Epidemiology.”</span> <em>Epidemiology</em> 11 (5): 550–60. <a href="https://doi.org/10.1097/00001648-200009000-00011" class="external-link">https://doi.org/10.1097/00001648-200009000-00011</a>.
</div>
<div id="ref-thoemmesPrimerInverseProbability2016" class="csl-entry">
Thoemmes, Felix J., and Anthony D. Ong. 2016. <span>“A Primer on Inverse
Probability of Treatment Weighting and Marginal Structural
Models.”</span> <em>Emerging Adulthood</em> 4 (1): 40–59. <a href="https://doi.org/10.1177/2167696815621645" class="external-link">https://doi.org/10.1177/2167696815621645</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Noah Greifer.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
