<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Nonparametric Covariate Balancing Propensity Score Weighting — method_npcbps • WeightIt</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Nonparametric Covariate Balancing Propensity Score Weighting — method_npcbps"><meta property="og:description" content='This page explains the details of estimating weights from nonparametric covariate balancing propensity scores by setting method = "npcbps" in the call to weightit() or weightitMSM(). This method can be used with binary, multinomial, and continuous treatments.
In general, this method relies on estimating weights by maximizing the empirical likelihood of the data subject to balance constraints. This method relies on npCBPS() from the CBPS package.

Binary Treatments
For binary treatments, this method estimates the weights using npCBPS(). The ATE is the only estimand allowed. The weights are taken from the output of the npCBPS fit object.


Multinomial Treatments
For multinomial treatments, this method estimates the weights using npCBPS(). The ATE is the only estimand allowed. The weights are taken from the output of the npCBPS fit object.


Continuous Treatments
For continuous treatments, this method estimates the weights using npCBPS(). The weights are taken from the output of the npCBPS fit object.


Longitudinal Treatments
For longitudinal treatments, the weights are the product of the weights estimated at each time point. This is not how CBMSM in the CBPS package estimates weights for longitudinal treatments.


Sampling Weights
Sampling weights are not supported with method = "npcbps".


Missing Data
In the presence of missing data, the following value(s) for missing are allowed:
"ind" (default)
First, for each variable with missingness, a new missingness indicator variable is created which takes the value 1 if the original covariate is NA and 0 otherwise. The missingness indicators are added to the model formula as main effects. The missing values in the covariates are then replaced with 0s (this value is arbitrary and does not affect estimation). The weight estimation then proceeds with this new formula and set of covariates. The covariates output in the resulting weightit object will be the original covariates with the NAs.





'><meta property="og:image" content="/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">WeightIt</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.12.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/WeightIt.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/ngreifer/WeightIt/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Nonparametric Covariate Balancing Propensity Score Weighting</h1>
    
    <div class="hidden name"><code>method_npcbps.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This page explains the details of estimating weights from nonparametric covariate balancing propensity scores by setting <code>method = "npcbps"</code> in the call to <code><a href="weightit.html">weightit()</a></code> or <code><a href="weightitMSM.html">weightitMSM()</a></code>. This method can be used with binary, multinomial, and continuous treatments.</p>
<p>In general, this method relies on estimating weights by maximizing the empirical likelihood of the data subject to balance constraints. This method relies on <code><a href="https://rdrr.io/pkg/CBPS/man/npCBPS.html" class="external-link">npCBPS()</a></code> from the <a href="https://CRAN.R-project.org/package=CBPS" class="external-link"><span class="pkg">CBPS</span></a> package.</p>
<div class="section">
<h3 id="binary-treatments">Binary Treatments<a class="anchor" aria-label="anchor" href="#binary-treatments"></a></h3>
<p>For binary treatments, this method estimates the weights using <code><a href="https://rdrr.io/pkg/CBPS/man/npCBPS.html" class="external-link">npCBPS()</a></code>. The ATE is the only estimand allowed. The weights are taken from the output of the <code>npCBPS</code> fit object.</p>
</div>
<div class="section">
<h3 id="multinomial-treatments">Multinomial Treatments<a class="anchor" aria-label="anchor" href="#multinomial-treatments"></a></h3>
<p>For multinomial treatments, this method estimates the weights using <code><a href="https://rdrr.io/pkg/CBPS/man/npCBPS.html" class="external-link">npCBPS()</a></code>. The ATE is the only estimand allowed. The weights are taken from the output of the <code>npCBPS</code> fit object.</p>
</div>
<div class="section">
<h3 id="continuous-treatments">Continuous Treatments<a class="anchor" aria-label="anchor" href="#continuous-treatments"></a></h3>
<p>For continuous treatments, this method estimates the weights using <code><a href="https://rdrr.io/pkg/CBPS/man/npCBPS.html" class="external-link">npCBPS()</a></code>. The weights are taken from the output of the <code>npCBPS</code> fit object.</p>
</div>
<div class="section">
<h3 id="longitudinal-treatments">Longitudinal Treatments<a class="anchor" aria-label="anchor" href="#longitudinal-treatments"></a></h3>
<p>For longitudinal treatments, the weights are the product of the weights estimated at each time point. This is not how <code><a href="https://rdrr.io/pkg/CBPS/man/CBMSM.html" class="external-link">CBMSM</a></code> in the <span class="pkg">CBPS</span> package estimates weights for longitudinal treatments.</p>
</div>
<div class="section">
<h3 id="sampling-weights">Sampling Weights<a class="anchor" aria-label="anchor" href="#sampling-weights"></a></h3>
<p>Sampling weights are <b>not</b> supported with <code>method = "npcbps"</code>.</p>
</div>
<div class="section">
<h3 id="missing-data">Missing Data<a class="anchor" aria-label="anchor" href="#missing-data"></a></h3>
<p>In the presence of missing data, the following value(s) for <code>missing</code> are allowed:</p><dl><dt><code>"ind"</code> (default)</dt>
<dd><p>First, for each variable with missingness, a new missingness indicator variable is created which takes the value 1 if the original covariate is <code>NA</code> and 0 otherwise. The missingness indicators are added to the model formula as main effects. The missing values in the covariates are then replaced with 0s (this value is arbitrary and does not affect estimation). The weight estimation then proceeds with this new formula and set of covariates. The covariates output in the resulting <code>weightit</code> object will be the original covariates with the <code>NA</code>s.</p></dd>


</dl></div>

    </div>


    <div id="additional-arguments">
    <h2>Additional Arguments</h2>
    <p>All arguments to <code>npCBPS()</code> can be passed through <code><a href="weightit.html">weightit()</a></code> or <code><a href="weightitMSM.html">weightitMSM()</a></code>.</p>
<p>All arguments take on the defaults of those in <code>npCBPS()</code>.</p>
    </div>
    <div id="additional-outputs">
    <h2>Additional Outputs</h2>
    
<dl><dt><code>obj</code></dt>
<dd><p>When <code>include.obj = TRUE</code>, the nonparametric CB(G)PS model fit. The output of the call to <code><a href="https://rdrr.io/pkg/CBPS/man/npCBPS.html" class="external-link">CBPS::npCBPS()</a></code>.</p></dd>


</dl></div>
    <div id="details">
    <h2>Details</h2>
    <p>Nonparametric CBPS involves the specification of a constrained optimization problem over the weights. The constraints correspond to covariate balance, and the loss function is the empirical likelihood of the data given the weights. npCBPS is similar to <a href="method_ebal.html">entropy balancing</a> and will generally produce similar results. Because the optimization problem of npCBPS is not convex it can be slow to converge or not converge at all, so approximate balance is allowed instead using the <code>cor.prior</code> argument, which controls the average deviation from zero correlation between the treatment and covariates allowed.</p>
    </div>
    <div id="references">
    <h2>References</h2>
    

<p>Fong, C., Hazlett, C., &amp; Imai, K. (2018). Covariate balancing propensity score for a continuous treatment: Application to the efficacy of political advertisements. The Annals of Applied Statistics, 12(1), 156–177. doi: <a href="https://doi.org/10.1214/17-AOAS1101" class="external-link">10.1214/17-AOAS1101</a></p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p><code><a href="weightit.html">weightit()</a></code>, <code><a href="weightitMSM.html">weightitMSM()</a></code>, <code><a href="method_cbps.html">method_cbps</a></code></p>
<p><code><a href="https://rdrr.io/pkg/CBPS/man/npCBPS.html" class="external-link">CBPS::npCBPS()</a></code> for the fitting function</p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span class="co"># Examples take a long time to run</span></span>
<span class="r-in"><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span class="r-in"><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ngreifer.github.io/cobalt/" class="external-link">"cobalt"</a></span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"lalonde"</span>, package <span class="op">=</span> <span class="st">"cobalt"</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co">#Balancing covariates between treatment groups (binary)</span></span>
<span class="r-in"><span class="op">(</span><span class="va">W1</span> <span class="op">&lt;-</span> <span class="fu"><a href="weightit.html">weightit</a></span><span class="op">(</span><span class="va">treat</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span></span>
<span class="r-in">                  <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span class="r-in">                method <span class="op">=</span> <span class="st">"npcbps"</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">W1</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab</a></span><span class="op">(</span><span class="va">W1</span><span class="op">)</span></span>
<span class="r-in"></span>
<span class="r-in"><span class="co">#Balancing covariates with respect to race (multinomial)</span></span>
<span class="r-in"><span class="op">(</span><span class="va">W2</span> <span class="op">&lt;-</span> <span class="fu"><a href="weightit.html">weightit</a></span><span class="op">(</span><span class="va">race</span> <span class="op">~</span> <span class="va">age</span> <span class="op">+</span> <span class="va">educ</span> <span class="op">+</span> <span class="va">married</span> <span class="op">+</span></span>
<span class="r-in">                  <span class="va">nodegree</span> <span class="op">+</span> <span class="va">re74</span>, data <span class="op">=</span> <span class="va">lalonde</span>,</span>
<span class="r-in">                method <span class="op">=</span> <span class="st">"npcbps"</span>, estimand <span class="op">=</span> <span class="st">"ATE"</span><span class="op">)</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">W2</span><span class="op">)</span></span>
<span class="r-in"><span class="fu"><a href="https://ngreifer.github.io/cobalt/reference/bal.tab.html" class="external-link">bal.tab</a></span><span class="op">(</span><span class="va">W2</span><span class="op">)</span></span>
<span class="r-in"><span class="op">}</span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Noah Greifer.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer></div>

  


  

  </body></html>

